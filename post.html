<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Create Post</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: #fff; height: 100vh; display: flex; flex-direction: column; }
        .head { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #ddd; }
        .head span { font-size: 18px; font-weight: 500; }
        .btn-post { background: #1877f2; color: white; padding: 8px 20px; border-radius: 6px; border: none; font-weight: 600; font-size: 15px; disabled: true; opacity: 0.5; }
        .btn-post.active { opacity: 1; cursor: pointer; }
        .user-sec { padding: 15px; display: flex; gap: 10px; align-items: center; }
        .u-img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; }
        .input-area { flex: 1; padding: 0 15px; overflow-y: auto; }
        textarea { width: 100%; border: none; outline: none; font-size: 20px; resize: none; min-height: 100px; }
        .preview-box { margin-top: 20px; position: relative; display: none; border-radius: 10px; overflow: hidden; border: 1px solid #ddd; }
        .preview-box img, .preview-box video { width: 100%; max-height: 400px; object-fit: contain; background: black; }
        .preview-box iframe { width: 100%; height: 300px; border: none; }
        .del-media { position: absolute; top: 10px; right: 10px; background: white; padding: 5px 10px; border-radius: 50%; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .tools { border-top: 1px solid #eee; padding: 15px; }
        .tool-btn { display: flex; align-items: center; gap: 10px; padding: 10px; border-radius: 8px; cursor: pointer; }
        .tool-btn:active { background: #f0f2f5; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: none; justify-content: center; align-items: center; z-index: 99; }
    </style>
</head>
<body>
    <div id="loader"><i class="fas fa-spinner fa-spin" style="font-size:30px; color:#1877f2"></i></div>
    <div class="head">
        <i class="fas fa-arrow-left" style="font-size:20px;" onclick="window.history.back()"></i>
        <span>Create Post</span>
        <button class="btn-post" id="subBtn" onclick="pub()">Post</button>
    </div>
    <div class="user-sec">
        <img id="myPic" class="u-img" src="https://via.placeholder.com/50">
        <span id="myName" style="font-weight:600;">Loading...</span>
    </div>
    <div class="input-area">
        <textarea id="txt" placeholder="What's on your mind? or Paste YouTube Link"></textarea>
        <div class="preview-box" id="prevBox">
            <div class="del-media" onclick="clr()"><i class="fas fa-times"></i></div>
            <div id="contentHolder"></div>
        </div>
    </div>
    <div class="tools">
        <div class="tool-btn" onclick="document.getElementById('fIn').click()">
            <i class="fas fa-photo-video" style="color:#45bd62; font-size:24px;"></i>
            <span>Photo/Video</span>
        </div>
        <input type="file" id="fIn" hidden accept="image/*,video/*" onchange="fileSel(this)">
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const cfg = { apiKey: "AIzaSyD_HBGuQSh_GzqrHqHbgdaoBikLZsK3Qqs", authDomain: "new-all-f99f7.firebaseapp.com", projectId: "new-all-f99f7", storageBucket: "new-all-f99f7.appspot.com", messagingSenderId: "1069748173900", appId: "1:1069748173900:web:158d6336c0f4628133c8e9" };
        const C_URL = "https://api.cloudinary.com/v1_1/dwgvvzbvn/auto/upload";
        const C_PRESET = "storyapp";

        const app = initializeApp(cfg);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let user = null;
        let file = null;
        let ytId = null;

        onAuthStateChanged(auth, async (u) => {
            if(u) {
                user = u;
                const d = (await getDoc(doc(db,"users",u.uid))).data();
                document.getElementById('myPic').src = d.profilePic;
                document.getElementById('myName').innerText = d.fullName;
            } else window.location.href="Account.html";
        });

        const txt = document.getElementById('txt');
        const btn = document.getElementById('subBtn');

        txt.addEventListener('input', () => {
            const val = txt.value;
            const ytMatch = val.match(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([\w-]{11})/);
            
            if(ytMatch && !file) {
                ytId = ytMatch[1];
                document.getElementById('contentHolder').innerHTML = `<iframe src="https://www.youtube.com/embed/${ytId}" allowfullscreen></iframe>`;
                document.getElementById('prevBox').style.display = 'block';
            }
            chk();
        });

        window.fileSel = (inp) => {
            if(inp.files[0]) {
                file = inp.files[0];
                ytId = null;
                const url = URL.createObjectURL(file);
                const isVid = file.type.startsWith('video');
                const h = document.getElementById('contentHolder');
                h.innerHTML = isVid ? `<video src="${url}" controls style="width:100%"></video>` : `<img src="${url}" style="width:100%">`;
                document.getElementById('prevBox').style.display = 'block';
                chk();
            }
        }

        window.clr = () => {
            file = null;
            ytId = null;
            document.getElementById('fIn').value = "";
            document.getElementById('prevBox').style.display = 'none';
            document.getElementById('contentHolder').innerHTML = "";
            chk();
        }

        function chk() {
            if(txt.value.trim() || file || ytId) {
                btn.classList.add('active'); btn.disabled = false;
            } else {
                btn.classList.remove('active'); btn.disabled = true;
            }
        }

        window.pub = async () => {
            document.getElementById('loader').style.display = 'flex';
            try {
                let mUrl = null, type = 'text';
                
                if(ytId) {
                    mUrl = `https://www.youtube.com/embed/${ytId}`;
                    type = 'youtube';
                } else if (file) {
                    const fd = new FormData(); fd.append('file', file); fd.append('upload_preset', C_PRESET);
                    const res = await fetch(C_URL, {method:'POST', body:fd});
                    const data = await res.json();
                    mUrl = data.secure_url;
                    type = file.type.startsWith('video') ? 'video' : 'image';
                }

                const ud = (await getDoc(doc(db,"users",user.uid))).data();
                
                await addDoc(collection(db,"posts"), {
                    uid: user.uid, userName: ud.fullName, userPic: ud.profilePic,
                    text: txt.value, mediaUrl: mUrl, type: type, likes: [], timestamp: new Date().toISOString()
                });
                window.location.href = "index.html";
            } catch(e) {
                alert("Error"); document.getElementById('loader').style.display = 'none';
            }
        }
    </script>
</body>
</html>
