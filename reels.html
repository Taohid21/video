<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tio Reels</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #1877f2; --white: #ffffff; --glass: rgba(255, 255, 255, 0.15); }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background: #000; color: var(--white); overflow: hidden; height: 100vh; width: 100vw; }
        
        /* --- Container & Scroll --- */
        .app-container { height: 100%; width: 100%; overflow-y: scroll; scroll-snap-type: y mandatory; scrollbar-width: none; position: relative; }
        .app-container::-webkit-scrollbar { display: none; }
        
        /* --- Reel Item --- */
        .reel { height: 100vh; width: 100%; scroll-snap-align: start; position: relative; display: flex; justify-content: center; align-items: center; background: #111; overflow: hidden; }
        
        /* ভিডিও স্টাইল (ফুল স্ক্রিন কভার) */
        .reel-video { width: 100%; height: 100%; object-fit: cover; z-index: 1; display: block; }
        
        /* --- Overlays --- */
        .gradient-overlay { position: absolute; bottom: 0; left: 0; width: 100%; height: 50%; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); z-index: 2; pointer-events: none; }
        
        /* --- Right Side Actions --- */
        .actions-bar { position: absolute; right: 10px; bottom: 100px; z-index: 10; display: flex; flex-direction: column; gap: 20px; align-items: center; padding-bottom: 20px; }
        .action-btn { display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; transition: transform 0.2s; }
        .action-btn:active { transform: scale(0.85); }
        .icon-box { width: 45px; height: 45px; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; transition: 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .icon-box.liked { color: #ff2d55; background: rgba(255, 255, 255, 0.1); }
        .action-label { font-size: 11px; font-weight: 600; text-shadow: 0 1px 3px rgba(0,0,0,0.8); }

        /* --- Music Disc Animation --- */
        .music-disc { width: 45px; height: 45px; background: #222; border-radius: 50%; border: 2px solid #333; overflow: hidden; margin-top: 15px; animation: spin 4s linear infinite; display: flex; justify-content: center; align-items: center; position: relative; }
        .music-disc img { width: 100%; height: 100%; object-fit: cover; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- User Info Area --- */
        .info-area { position: absolute; bottom: 20px; left: 0; width: 100%; padding: 15px 70px 25px 15px; z-index: 5; pointer-events: none; }
        .user-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; pointer-events: auto; width: fit-content; }
        .u-pic { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--white); object-fit: cover; }
        .u-name { font-weight: 700; font-size: 16px; text-shadow: 0 1px 2px rgba(0,0,0,0.8); display: flex; align-items: center; gap: 5px; }
        .caption { font-size: 14px; line-height: 1.4; color: #eee; text-shadow: 0 1px 2px rgba(0,0,0,0.8); max-height: 80px; overflow-y: auto; pointer-events: auto; }
        
        /* --- Big Heart Animation (Double Tap) --- */
        .big-heart { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); color: rgba(255, 45, 85, 0.9); font-size: 100px; z-index: 20; pointer-events: none; }
        .big-heart.animate { animation: heartPop 0.8s ease-out; }
        @keyframes heartPop { 0%{transform: translate(-50%, -50%) scale(0); opacity: 0;} 15%{transform: translate(-50%, -50%) scale(1.2); opacity: 1;} 30%{transform: translate(-50%, -50%) scale(0.9);} 100%{transform: translate(-50%, -50%) scale(1.5); opacity: 0;} }

        /* --- Modal (Comments & Share) --- */
        .modal-sheet { position: fixed; bottom: 0; left: 0; width: 100%; height: 70vh; background: #1a1a1a; z-index: 100; border-radius: 20px 20px 0 0; transform: translateY(110%); transition: transform 0.3s cubic-bezier(0.1, 0.7, 0.1, 1); display: flex; flex-direction: column; box-shadow: 0 -5px 30px rgba(0,0,0,0.5); }
        .modal-sheet.active { transform: translateY(0); }
        .drag-handle { width: 40px; height: 5px; background: #444; border-radius: 5px; margin: 10px auto; }
        .modal-head { padding: 10px 20px; text-align: center; border-bottom: 1px solid #333; font-weight: 700; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { flex: 1; overflow-y: auto; padding: 15px; }
        
        /* Comment Styles */
        .cmt-item { display: flex; gap: 10px; margin-bottom: 15px; }
        .cmt-text-box { background: #2a2a2a; padding: 8px 12px; border-radius: 12px; flex: 1; }
        .cmt-u { font-weight: 700; font-size: 12px; color: #aaa; margin-bottom: 2px; }
        .cmt-in-area { padding: 10px; border-top: 1px solid #333; display: flex; gap: 10px; align-items: center; background: #1a1a1a; }
        .c-inp { flex: 1; background: #333; border: none; padding: 10px 15px; border-radius: 20px; color: white; }
        
        /* Share Styles */
        .share-opt { padding: 15px; background: #2a2a2a; margin-bottom: 10px; border-radius: 10px; display: flex; align-items: center; gap: 15px; cursor: pointer; transition: 0.2s; }
        .share-opt:active { background: #333; transform: scale(0.98); }

        /* Mute Icon */
        .mute-ind { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); background: rgba(0,0,0,0.6); padding: 15px; border-radius: 50%; pointer-events: none; opacity: 0; transition: 0.3s; z-index: 5; }
        .loader-center { position: absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:var(--accent); font-size:30px; }
    </style>
</head>
<body>

    <!-- Main Reels Container -->
    <div class="app-container" id="feed-container">
        <div class="loader-center"><i class="fas fa-circle-notch fa-spin"></i></div>
    </div>

    <!-- Hidden Modals -->
    <div id="overlay" onclick="closeModals()" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:90;display:none;"></div>

    <!-- Comments Modal -->
    <div class="modal-sheet" id="cmt-modal">
        <div class="drag-handle"></div>
        <div class="modal-head">
            <span>Comments</span>
            <i class="fas fa-times" onclick="closeModals()"></i>
        </div>
        <div class="modal-body" id="cmt-list"></div>
        <div class="cmt-in-area">
            <input id="cmt-input" class="c-inp" placeholder="Add a comment...">
            <i class="fas fa-paper-plane" style="color:var(--accent); padding:10px; font-size:20px;" onclick="postComment()"></i>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal-sheet" id="share-modal" style="height:auto; max-height:50vh;">
        <div class="drag-handle"></div>
        <div class="modal-head">Share to</div>
        <div class="modal-body">
            <div class="share-opt" onclick="shareToMyFeed()">
                <div class="icon-box" style="background:var(--accent);"><i class="fas fa-rss"></i></div>
                <div>
                    <div style="font-weight:700;">Share to Feed</div>
                    <div style="font-size:12px; color:#aaa;">Post this reel to your profile</div>
                </div>
            </div>
            <div class="share-opt" onclick="copyLink()">
                <div class="icon-box" style="background:#333;"><i class="fas fa-link"></i></div>
                <div>
                    <div style="font-weight:700;">Copy Link</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, query, orderBy, updateDoc, doc, arrayUnion, arrayRemove, addDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase Config
        const cfg = { apiKey: "AIzaSyD_HBGuQSh_GzqrHqHbgdaoBikLZsK3Qqs", authDomain: "new-all-f99f7.firebaseapp.com", projectId: "new-all-f99f7", storageBucket: "new-all-f99f7.appspot.com", messagingSenderId: "1069748173900", appId: "1:1069748173900:web:158d6336c0f4628133c8e9" };
        const app = initializeApp(cfg);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let me = null;
        let activeReelId = null;
        let activeVideoEl = null;

        // Authentication State
        onAuthStateChanged(auth, (u) => {
            if (u) { me = u; loadReels(); }
            else { document.body.innerHTML = "<div style='display:flex;justify-content:center;align-items:center;height:100vh;'>Login required</div>"; }
        });

        async function loadReels() {
            const feed = document.getElementById('feed-container');
            const q = query(collection(db, "posts"), orderBy("timestamp", "desc"));
            const s = await getDocs(q);
            
            let html = "";
            let count = 0;

            s.forEach(d => {
                const p = d.data();
                if (p.type === 'video' || p.type === 'youtube') {
                    // Only process actual videos for now (ignoring youtube iframe for seamless scrolling experience or treat differently)
                    if(p.type === 'video') {
                        count++;
                        const isLiked = p.likes && p.likes.includes(me.uid);
                        const likeCnt = p.likes ? p.likes.length : 0;
                        const badge = p.isVerified ? `<i class="fas fa-check-circle" style="color:#1877f2; font-size:14px; margin-left:5px;"></i>` : '';

                        html += `
                        <div class="reel" id="reel-${d.id}">
                            <div class="big-heart"><i class="fas fa-heart"></i></div>
                            <div class="mute-ind"><i class="fas fa-volume-mute" style="font-size:30px"></i></div>
                            
                            <video class="reel-video" src="${p.mediaUrl}" loop playsinline data-id="${d.id}"></video>
                            
                            <div class="gradient-overlay"></div>

                            <div class="actions-bar">
                                <div class="action-btn" onclick="toggleLike('${d.id}', this)">
                                    <div class="icon-box ${isLiked ? 'liked' : ''}"><i class="${isLiked ? 'fas' : 'far'} fa-heart"></i></div>
                                    <span class="action-label l-cnt">${likeCnt}</span>
                                </div>
                                <div class="action-btn" onclick="openComments('${d.id}')">
                                    <div class="icon-box"><i class="fas fa-comment-dots"></i></div>
                                    <span class="action-label">Comment</span>
                                </div>
                                <div class="action-btn" onclick="openShare('${d.id}')">
                                    <div class="icon-box"><i class="fas fa-share"></i></div>
                                    <span class="action-label">Share</span>
                                </div>
                                <div class="music-disc">
                                    <img src="${p.userPic}">
                                </div>
                            </div>

                            <div class="info-area">
                                <div class="user-row">
                                    <img src="${p.userPic}" class="u-pic">
                                    <div class="u-name">${p.userName} ${badge}</div>
                                </div>
                                <div class="caption">${p.text || ''}</div>
                                <div style="font-size:12px; margin-top:5px; display:flex; align-items:center; gap:5px;">
                                    <i class="fas fa-music"></i> <span>Original Audio - ${p.userName}</span>
                                </div>
                            </div>
                        </div>`;
                    }
                }
            });

            if (count === 0) feed.innerHTML = "<div style='display:flex;justify-content:center;align-items:center;height:100vh;'>No reels yet</div>";
            else {
                feed.innerHTML = html;
                initVideoObserver();
                addDoubleTapListeners();
            }
        }

        // --- Video Logic (Auto Play/Pause) ---
        function initVideoObserver() {
            const options = { threshold: 0.6 }; // 60% visibility required
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const video = entry.target.querySelector('video');
                    if (entry.isIntersecting) {
                        video.play().catch(e => console.log('Autoplay blocked'));
                        activeVideoEl = video;
                        activeReelId = video.getAttribute('data-id');
                        document.querySelector(`#reel-${activeReelId} .music-disc`).style.animationPlayState = 'running';
                    } else {
                        video.pause();
                        video.currentTime = 0; // Reset loop
                        const disc = entry.target.querySelector('.music-disc');
                        if(disc) disc.style.animationPlayState = 'paused';
                    }
                });
            }, options);

            document.querySelectorAll('.reel').forEach(reel => observer.observe(reel));
        }

        // --- User Interaction Logic ---
        
        // Mute/Unmute toggle
        document.addEventListener('click', (e) => {
            if(e.target.classList.contains('reel-video')) {
                const vid = e.target;
                vid.muted = !vid.muted;
                const icon = vid.parentElement.querySelector('.mute-ind');
                icon.innerHTML = vid.muted ? '<i class="fas fa-volume-mute" style="font-size:30px"></i>' : '<i class="fas fa-volume-up" style="font-size:30px"></i>';
                icon.style.opacity = '1';
                setTimeout(() => icon.style.opacity = '0', 1000);
            }
        });

        // Double Tap to Like
        function addDoubleTapListeners() {
            let lastTap = 0;
            document.querySelectorAll('.reel-video').forEach(vid => {
                vid.addEventListener('touchend', (e) => {
                    const currentTime = new Date().getTime();
                    const tapLength = currentTime - lastTap;
                    if (tapLength < 300 && tapLength > 0) {
                        const id = vid.getAttribute('data-id');
                        // Find the like button for this reel
                        const btn = vid.parentElement.querySelector('.actions-bar .action-btn'); 
                        if (!btn.querySelector('.icon-box').classList.contains('liked')) {
                            toggleLike(id, btn); // Like logic
                        }
                        // Heart Animation
                        const heart = vid.parentElement.querySelector('.big-heart');
                        heart.classList.remove('animate');
                        void heart.offsetWidth; // Trigger reflow
                        heart.classList.add('animate');
                        e.preventDefault();
                    }
                    lastTap = currentTime;
                });
            });
        }

        // Like Function
        window.toggleLike = async (id, btn) => {
            const box = btn.querySelector('.icon-box');
            const icon = btn.querySelector('i');
            const cntSpan = btn.querySelector('.l-cnt');
            let count = parseInt(cntSpan.innerText);

            if (box.classList.contains('liked')) {
                // Unlike
                box.classList.remove('liked');
                icon.className = 'far fa-heart';
                cntSpan.innerText = Math.max(0, count - 1);
                await updateDoc(doc(db, "posts", id), { likes: arrayRemove(me.uid) });
            } else {
                // Like
                box.classList.add('liked');
                icon.className = 'fas fa-heart';
                cntSpan.innerText = count + 1;
                await updateDoc(doc(db, "posts", id), { likes: arrayUnion(me.uid) });
            }
        };

        // --- Comments System ---
        window.openComments = async (id) => {
            activeReelId = id;
            document.getElementById('overlay').style.display = 'block';
            const modal = document.getElementById('cmt-modal');
            modal.classList.add('active');
            const list = document.getElementById('cmt-list');
            list.innerHTML = '<div style="text-align:center;color:#888;">Loading...</div>';

            const snap = await getDocs(query(collection(db, "posts", id, "comments"), orderBy("timestamp", "asc")));
            list.innerHTML = "";
            snap.forEach(d => {
                const c = d.data();
                list.innerHTML += `
                    <div class="cmt-item">
                        <img src="${c.uPic}" style="width:30px;height:30px;border-radius:50%;">
                        <div class="cmt-text-box">
                            <div class="cmt-u">${c.uName}</div>
                            <div style="font-size:13px;color:#eee;">${c.txt}</div>
                        </div>
                    </div>`;
            });
            if(list.innerHTML === "") list.innerHTML = '<div style="text-align:center;color:#555;margin-top:20px;">No comments yet. Be the first!</div>';
        };

        window.postComment = async () => {
            const inp = document.getElementById('cmt-input');
            const txt = inp.value.trim();
            if (!txt || !activeReelId) return;
            
            inp.value = "";
            const uData = (await getDoc(doc(db, "users", me.uid))).data();
            
            // Optimistic Update
            const list = document.getElementById('cmt-list');
            if(list.innerText.includes("No comments")) list.innerHTML = "";
            list.innerHTML += `
                <div class="cmt-item" style="opacity:0.7">
                    <img src="${uData.profilePic}" style="width:30px;height:30px;border-radius:50%;">
                    <div class="cmt-text-box">
                        <div class="cmt-u">${uData.fullName}</div>
                        <div style="font-size:13px;color:#eee;">${txt}</div>
                    </div>
                </div>`;
            list.scrollTop = list.scrollHeight;

            await addDoc(collection(db, "posts", activeReelId, "comments"), {
                uid: me.uid, uName: uData.fullName, uPic: uData.profilePic, txt: txt, timestamp: new Date().toISOString()
            });
        };

        // --- Share System ---
        window.openShare = (id) => {
            activeReelId = id;
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('share-modal').classList.add('active');
        };

        window.closeModals = () => {
            document.getElementById('overlay').style.display = 'none';
            document.querySelectorAll('.modal-sheet').forEach(m => m.classList.remove('active'));
        };

        window.shareToMyFeed = async () => {
            if(!activeReelId) return;
            const btn = document.querySelector('.share-opt'); // Just for visual feedback if needed
            
            try {
                // Get original post data
                const original = (await getDoc(doc(db,"posts", activeReelId))).data();
                const myData = (await getDoc(doc(db,"users", me.uid))).data();

                await addDoc(collection(db, "posts"), {
                    uid: me.uid,
                    userName: myData.fullName,
                    userPic: myData.profilePic,
                    text: `Shared a reel from ${original.userName}`,
                    mediaUrl: original.mediaUrl, // Reuse the video URL
                    type: 'video', // It becomes a video on my profile too
                    likes: [],
                    timestamp: new Date().toISOString(),
                    isVerified: myData.isVerified || false // Keep verification status logic
                });
                alert("Shared to your feed successfully!");
                closeModals();
            } catch(e) {
                console.error(e);
                alert("Failed to share.");
            }
        };

        window.copyLink = () => {
            // Since this is in an iframe, we might just copy the direct ID or a mock link
            navigator.clipboard.writeText(`https://tio.app/reel/${activeReelId}`);
            alert("Link copied to clipboard");
            closeModals();
        };

    </script>
</body>
</html>
