<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tio Reels Ultimate</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #00d2ff; --white: #ffffff; --dark-bg: #000000; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        html, body { height: 100%; width: 100%; background: var(--dark-bg); color: var(--white); overflow: hidden; }
        
        .app-container { height: 100%; width: 100%; overflow-y: scroll; scroll-snap-type: y mandatory; scrollbar-width: none; position: absolute; top: 0; left: 0; }
        .app-container::-webkit-scrollbar { display: none; }
        
        .reel { height: 100%; width: 100%; scroll-snap-align: start; scroll-snap-stop: always; position: relative; background: #111; overflow: hidden; }
        .reel-video { width: 100%; height: 100%; object-fit: cover; display: block; }
        .gradient-overlay { position: absolute; bottom: 0; left: 0; width: 100%; height: 60%; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); pointer-events: none; }
        
        /* --- Progress Bar (Restored) --- */
        .progress-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background: rgba(255,255,255,0.3); z-index: 20; }
        .progress-bar { height: 100%; background: var(--accent); width: 0%; transition: width 0.1s linear; }

        /* --- Actions Bar --- */
        .actions-bar { position: absolute; right: 10px; bottom: 40px; z-index: 10; display: flex; flex-direction: column; gap: 20px; align-items: center; }
        .action-btn { position: relative; display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; transition: transform 0.2s; }
        .action-btn:active { transform: scale(0.9); }
        .icon-box { width: 42px; height: 42px; background: rgba(255,255,255,0.1); backdrop-filter: blur(5px); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: 0.3s; border: 1px solid rgba(255,255,255,0.1); }
        .action-label { font-size: 11px; font-weight: 600; text-shadow: 0 1px 2px black; }

        /* Reaction Logic */
        .icon-box.reacted { border-color: transparent; background: rgba(255,255,255,0.2); }
        .react-like { color: #1877F2; } .react-love { color: #F02849; } 
        .react-haha { color: #F7B125; } .react-wow { color: #F7B125; } 
        .react-sad { color: #F7B125; } .react-angry { color: #E4605E; }

        .reactions-popup {
            position: absolute; right: 55px; bottom: 0; background: white; border-radius: 30px;
            padding: 8px 12px; display: flex; gap: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            opacity: 0; visibility: hidden; transform: scale(0.8) translateX(20px); transition: 0.2s; pointer-events: none; z-index: 100;
        }
        .reactions-popup.show { opacity: 1; visibility: visible; transform: scale(1) translateX(0); pointer-events: auto; }
        .r-emoji { font-size: 26px; transition: 0.2s; cursor: pointer; }
        .r-emoji:hover { transform: scale(1.4) translateY(-5px); }

        /* --- Music Disc & Animation (Restored) --- */
        .music-disc-wrap { margin-top: 10px; position: relative; width: 45px; height: 45px; display: flex; justify-content: center; align-items: center; }
        .music-disc { width: 100%; height: 100%; background: #222; border-radius: 50%; border: 4px solid #1a1a1a; overflow: hidden; animation: spin 5s linear infinite; }
        .music-disc img { width: 100%; height: 100%; object-fit: cover; }
        
        /* Floating Notes */
        .music-note { position: absolute; font-size: 14px; color: var(--accent); opacity: 0; animation: floatNote 2s infinite ease-out; }
        .note-1 { right: -5px; bottom: 5px; animation-delay: 0s; }
        .note-2 { right: -10px; top: 0px; animation-delay: 1s; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes floatNote { 0% { transform: translate(0, 0) rotate(0deg); opacity: 0; } 50% { opacity: 1; } 100% { transform: translate(-15px, -30px) rotate(-20deg); opacity: 0; } }

        /* --- Info Area --- */
        .info-area { position: absolute; bottom: 10px; left: 0; width: 100%; padding: 15px 70px 20px 10px; pointer-events: none; }
        .user-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; pointer-events: auto; }
        .u-pic { width: 40px; height: 40px; border-radius: 50%; border: 1px solid white; object-fit: cover; }
        .u-name { font-weight: 700; font-size: 16px; color: white; text-shadow: 0 1px 2px black; }
        .public-badge { font-size: 11px; color: rgba(255,255,255,0.8); display: flex; align-items: center; gap: 4px; margin-top: 2px; }
        .caption { font-size: 14px; color: #eee; text-shadow: 0 1px 1px black; line-height: 1.4; max-height: 80px; overflow-y: auto; }

        /* --- Modals --- */
        .modal-sheet { position: fixed; bottom: 0; left: 0; width: 100%; background: #1a1a1a; z-index: 100; border-radius: 20px 20px 0 0; transform: translateY(110%); transition: transform 0.3s; display: flex; flex-direction: column; max-height: 70vh; box-shadow: 0 -5px 40px rgba(0,0,0,0.6); }
        .modal-sheet.active { transform: translateY(0); }
        .drag-handle { width: 40px; height: 4px; background: #555; margin: 12px auto; border-radius: 2px; }
        .modal-head { padding: 10px 20px; border-bottom: 1px solid #333; font-weight: 700; display: flex; justify-content: space-between; align-items: center; color: white; }
        .modal-body { flex: 1; overflow-y: auto; padding: 15px; }

        /* --- Comments & Gift Styles --- */
        .cmt-item { display: flex; gap: 10px; margin-bottom: 15px; }
        .cmt-item.gift-msg { border: 1px solid #ffd700; background: rgba(255, 215, 0, 0.1); padding: 8px; border-radius: 10px; }
        .cmt-box { padding: 10px 15px; border-top: 1px solid #333; display: flex; gap: 10px; background: #1a1a1a; padding-bottom: 20px; }
        .c-inp { flex: 1; background: #333; border: none; padding: 12px 15px; border-radius: 25px; color: white; }
        
        .gift-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 10px; }
        .gift-item { display: flex; flex-direction: column; align-items: center; gap: 5px; padding: 10px; border-radius: 10px; border: 1px solid transparent; cursor: pointer; transition: 0.2s; background: rgba(255,255,255,0.05); }
        .gift-item.selected { background: rgba(255,255,255,0.15); border-color: var(--accent); transform: scale(1.05); }
        .send-gift-btn { margin: 15px; background: linear-gradient(45deg, #FFD700, #FFA500); border: none; padding: 12px; border-radius: 25px; font-weight: bold; color: black; cursor: pointer; width: calc(100% - 30px); }

        /* --- Expanded Share Styles (Restored) --- */
        .share-scroll-area { overflow-x: auto; padding: 10px 0; }
        .share-row { display: flex; gap: 20px; padding: 0 15px; min-width: max-content; }
        .share-item { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; width: 60px; }
        .s-icon { width: 55px; height: 55px; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center; font-size: 22px; color: white; transition: 0.2s; }
        .share-item:active .s-icon { transform: scale(0.9); background: var(--accent); color: black; }
        .s-lbl { font-size: 11px; color: #aaa; text-align: center; white-space: nowrap; }
        .divider { height: 1px; background: #333; margin: 15px 0; }

        /* Big Heart Animation */
        .big-heart { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); font-size: 90px; z-index: 20; color: #F02849; transition: 0.2s; pointer-events: none; filter: drop-shadow(0 0 15px rgba(0,0,0,0.5)); }
        .big-heart.animate { animation: heartPop 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes heartPop { 0%{transform: translate(-50%, -50%) scale(0); opacity: 0;} 15%{transform: translate(-50%, -50%) scale(1.3); opacity: 1;} 100%{transform: translate(-50%, -50%) scale(1.5); opacity: 0;} }
    </style>
</head>
<body>

    <div class="app-container" id="feed-container">
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#888;">
            <i class="fas fa-circle-notch fa-spin fa-2x"></i>
        </div>
    </div>

    <div id="overlay" onclick="closeModals()" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:90;display:none;backdrop-filter:blur(3px);"></div>

    <!-- Comments Modal -->
    <div class="modal-sheet" id="cmt-modal" style="height:70vh;">
        <div class="drag-handle"></div>
        <div class="modal-head">
            <span>Comments</span>
            <i class="fas fa-times" onclick="closeModals()" style="padding:10px;"></i>
        </div>
        <div class="modal-body" id="cmt-list"></div>
        <div class="cmt-box">
            <input id="cmt-input" class="c-inp" placeholder="Add a comment...">
            <i class="fas fa-paper-plane" style="color:var(--accent); padding:10px; font-size:22px; cursor:pointer;" onclick="postComment()"></i>
        </div>
    </div>

    <!-- Gift Modal -->
    <div class="modal-sheet" id="gift-modal" style="height:auto;">
        <div class="drag-handle"></div>
        <div class="modal-head">Send a Gift</div>
        <div class="modal-body">
            <div class="gift-grid">
                <div class="gift-item" onclick="selectGift(this, 'Rose', 'üåπ')">
                    <div style="font-size:30px;">üåπ</div><div style="font-size:11px;color:#ffd700;">10 C</div>
                </div>
                <div class="gift-item" onclick="selectGift(this, 'Choco', 'üç´')">
                    <div style="font-size:30px;">üç´</div><div style="font-size:11px;color:#ffd700;">20 C</div>
                </div>
                <div class="gift-item" onclick="selectGift(this, 'Love', 'üíñ')">
                    <div style="font-size:30px;">üíñ</div><div style="font-size:11px;color:#ffd700;">50 C</div>
                </div>
                <div class="gift-item" onclick="selectGift(this, 'King', 'üëë')">
                    <div style="font-size:30px;">üëë</div><div style="font-size:11px;color:#ffd700;">100 C</div>
                </div>
            </div>
            <button class="send-gift-btn" onclick="sendSelectedGift()">SEND NOW</button>
        </div>
    </div>

    <!-- Complete Share Modal -->
    <div class="modal-sheet" id="share-modal" style="height:auto; padding-bottom:30px;">
        <div class="drag-handle"></div>
        <div class="modal-head">Share</div>
        
        <!-- Primary Shares -->
        <div class="share-scroll-area">
            <div class="share-row">
                <div class="share-item" onclick="shareToFeed()">
                    <div class="s-icon" style="background:#E1306C"><i class="fas fa-rss"></i></div>
                    <div class="s-lbl">My Feed</div>
                </div>
                <div class="share-item" onclick="shareExternal('whatsapp')">
                    <div class="s-icon" style="background:#25D366"><i class="fab fa-whatsapp"></i></div>
                    <div class="s-lbl">WhatsApp</div>
                </div>
                <div class="share-item" onclick="shareExternal('messenger')">
                    <div class="s-icon" style="background:#0084FF"><i class="fab fa-facebook-messenger"></i></div>
                    <div class="s-lbl">Messenger</div>
                </div>
                <div class="share-item" onclick="copyLink()">
                    <div class="s-icon"><i class="fas fa-link"></i></div>
                    <div class="s-lbl">Copy Link</div>
                </div>
            </div>
        </div>

        <div class="divider"></div>

        <!-- Secondary Actions (Restored) -->
        <div class="share-scroll-area">
            <div class="share-row">
                <div class="share-item" onclick="alert('Downloading...')">
                    <div class="s-icon"><i class="fas fa-download"></i></div>
                    <div class="s-lbl">Save Video</div>
                </div>
                <div class="share-item">
                    <div class="s-icon"><i class="far fa-eye-slash"></i></div>
                    <div class="s-lbl">Not Interested</div>
                </div>
                <div class="share-item">
                    <div class="s-icon"><i class="fas fa-exclamation-triangle"></i></div>
                    <div class="s-lbl">Report</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, query, orderBy, updateDoc, doc, arrayUnion, arrayRemove, addDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const cfg = { apiKey: "AIzaSyD_HBGuQSh_GzqrHqHbgdaoBikLZsK3Qqs", authDomain: "new-all-f99f7.firebaseapp.com", projectId: "new-all-f99f7", storageBucket: "new-all-f99f7.appspot.com", messagingSenderId: "1069748173900", appId: "1:1069748173900:web:158d6336c0f4628133c8e9" };
        const app = initializeApp(cfg);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let me = null;
        let activeReelId = null;
        let selectedGift = null;
        let pressTimer;

        // Reaction Config
        const reactions = {
            'like': { class: 'react-like', icon: 'fa-thumbs-up' },
            'love': { class: 'react-love', icon: 'fa-heart' },
            'haha': { class: 'react-haha', icon: 'fa-laugh-squint' },
            'wow': { class: 'react-wow', icon: 'fa-surprise' },
            'sad': { class: 'react-sad', icon: 'fa-sad-tear' },
            'angry': { class: 'react-angry', icon: 'fa-angry' }
        };

        onAuthStateChanged(auth, (u) => {
            if (u) { me = u; loadReels(); }
        });

        async function loadReels() {
            const feed = document.getElementById('feed-container');
            const q = query(collection(db, "posts"), orderBy("timestamp", "desc"));
            const snap = await getDocs(q);
            let html = "";
            
            snap.forEach(d => {
                const p = d.data();
                if(p.type === 'video' && p.mediaUrl) {
                    const isLiked = p.likes && p.likes.includes(me.uid);
                    
                    html += `
                    <div class="reel">
                        <div class="big-heart" id="bh-${d.id}"><i class="fas fa-heart"></i></div>
                        
                        <video class="reel-video" src="${p.mediaUrl}" loop playsinline onclick="handleDoubleTap(this, '${d.id}')"></video>
                        <div class="gradient-overlay"></div>
                        <div class="progress-container"><div class="progress-bar"></div></div>

                        <div class="actions-bar">
                            <!-- Reaction Btn -->
                            <div class="action-btn" id="btn-${d.id}" style="position:relative;">
                                <div class="reactions-popup" id="rp-${d.id}">
                                    <span class="r-emoji" onclick="submitReaction('${d.id}', 'like')">üëç</span>
                                    <span class="r-emoji" onclick="submitReaction('${d.id}', 'love')">‚ù§Ô∏è</span>
                                    <span class="r-emoji" onclick="submitReaction('${d.id}', 'haha')">üòÇ</span>
                                    <span class="r-emoji" onclick="submitReaction('${d.id}', 'wow')">üòÆ</span>
                                    <span class="r-emoji" onclick="submitReaction('${d.id}', 'sad')">üò¢</span>
                                    <span class="r-emoji" onclick="submitReaction('${d.id}', 'angry')">üò°</span>
                                </div>
                                <div class="icon-box ${isLiked ? 'reacted react-love' : ''}"
                                     ontouchstart="startPress('${d.id}')" ontouchend="endPress('${d.id}')"
                                     onmousedown="startPress('${d.id}')" onmouseup="endPress('${d.id}')">
                                    <i class="${isLiked ? 'fas fa-heart' : 'fas fa-heart'}" style="${isLiked ? '' : 'color:white'}"></i>
                                </div>
                                <span class="action-label l-cnt">${p.likes ? p.likes.length : 0}</span>
                            </div>

                            <div class="action-btn" onclick="openComments('${d.id}')">
                                <div class="icon-box"><i class="fas fa-comment-dots"></i></div>
                                <span class="action-label">Comment</span>
                            </div>

                            <div class="action-btn" onclick="openGift('${d.id}')">
                                <div class="icon-box" style="border-color:#ffd700"><i class="fas fa-gift" style="color:#ffd700"></i></div>
                                <span class="action-label">Gift</span>
                            </div>

                            <div class="action-btn" onclick="openShare('${d.id}')">
                                <div class="icon-box"><i class="fas fa-share"></i></div>
                                <span class="action-label">Share</span>
                            </div>

                            <div class="music-disc-wrap">
                                <div class="music-disc"><img src="${p.userPic}"></div>
                                <div class="music-note note-1"><i class="fas fa-music"></i></div>
                                <div class="music-note note-2"><i class="fas fa-music"></i></div>
                            </div>
                        </div>

                        <div class="info-area">
                            <div class="user-row">
                                <img src="${p.userPic}" class="u-pic">
                                <div class="u-name">
                                    ${p.userName}
                                    <div class="public-badge"><i class="fas fa-globe-americas"></i> Public</div>
                                </div>
                            </div>
                            <div class="caption">${p.text || ''}</div>
                        </div>
                    </div>`;
                }
            });

            feed.innerHTML = html || "<h3 style='text-align:center;color:#666;margin-top:50%;'>No Reels Found</h3>";
            initVideoObserver();
        }

        /* --- Reaction Logic Fixed (Toggle capability) --- */
        window.startPress = (id) => {
            pressTimer = setTimeout(() => {
                document.getElementById(`rp-${id}`).classList.add('show');
                pressTimer = null;
            }, 500);
        };
        
        window.endPress = (id) => {
            if (pressTimer) {
                clearTimeout(pressTimer);
                toggleSimpleLike(id);
            }
        };

        window.submitReaction = async (id, type) => {
            document.getElementById(`rp-${id}`).classList.remove('show');
            const btn = document.getElementById(`btn-${id}`);
            const iconBox = btn.querySelector('.icon-box');
            const icon = iconBox.querySelector('i');
            const cnt = btn.querySelector('.l-cnt');
            
            // If already liked, don't increment, just change icon
            // If not liked, increment
            if(!iconBox.classList.contains('reacted')) {
                cnt.innerText = parseInt(cnt.innerText) + 1;
            }

            // UI Update
            iconBox.className = `icon-box reacted ${reactions[type].class}`;
            icon.className = `fas ${reactions[type].icon}`;
            icon.style.removeProperty('color');
            
            await updateDoc(doc(db, "posts", id), { likes: arrayUnion(me.uid) });
        };

        window.toggleSimpleLike = async (id) => {
            const popup = document.getElementById(`rp-${id}`);
            if(popup.classList.contains('show')) { popup.classList.remove('show'); return; }

            const btn = document.getElementById(`btn-${id}`);
            const box = btn.querySelector('.icon-box');
            const icon = box.querySelector('i');
            const cnt = btn.querySelector('.l-cnt');
            let n = parseInt(cnt.innerText);

            if (box.classList.contains('reacted')) {
                // --- UNLIKE LOGIC (Fixed) ---
                box.className = 'icon-box'; // Remove reacted class
                icon.className = 'fas fa-heart';
                icon.style.color = 'white';
                cnt.innerText = Math.max(0, n - 1);
                await updateDoc(doc(db, "posts", id), { likes: arrayRemove(me.uid) });
            } else {
                // --- LIKE LOGIC ---
                box.className = 'icon-box reacted react-love';
                icon.className = 'fas fa-heart';
                icon.style.removeProperty('color');
                cnt.innerText = n + 1;
                showBigHeart(id);
                await updateDoc(doc(db, "posts", id), { likes: arrayUnion(me.uid) });
            }
        };

        window.handleDoubleTap = (video, id) => {
            let lastTap = video.getAttribute('data-last-tap') || 0;
            const now = new Date().getTime();
            if (now - lastTap < 300) {
                showBigHeart(id);
                const btn = document.getElementById(`btn-${id}`);
                // Only toggle if NOT already liked (Prevent unlike on double tap)
                if (!btn.querySelector('.icon-box').classList.contains('reacted')) {
                    toggleSimpleLike(id);
                }
            } else {
                video.muted = !video.muted;
            }
            video.setAttribute('data-last-tap', now);
        };

        function showBigHeart(id) {
            const h = document.getElementById(`bh-${id}`);
            h.classList.remove('animate');
            void h.offsetWidth;
            h.classList.add('animate');
        }

        /* --- Comments & Gift Logic --- */
        window.openComments = async (id) => {
            activeReelId = id;
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('cmt-modal').classList.add('active');
            const list = document.getElementById('cmt-list');
            list.innerHTML = '<div style="text-align:center;padding:20px;color:#666;">Loading...</div>';

            const q = query(collection(db, "posts", id, "comments"), orderBy("timestamp", "asc"));
            const snap = await getDocs(q);
            list.innerHTML = "";
            snap.forEach(d => {
                const c = d.data();
                const isGift = c.isGift ? 'gift-msg' : '';
                list.innerHTML += `
                    <div class="cmt-item ${isGift}">
                        <img src="${c.uPic}" style="width:32px;height:32px;border-radius:50%;object-fit:cover;">
                        <div>
                            <div style="font-size:12px;color:#aaa;font-weight:700;">${c.uName}</div>
                            <div style="font-size:13px;color:white;">${c.txt}</div>
                        </div>
                    </div>`;
            });
            if(list.innerHTML === "") list.innerHTML = '<div style="text-align:center;padding:20px;color:#555;">No comments yet.</div>';
        };

        window.postComment = async (giftText = null) => {
            const inp = document.getElementById('cmt-input');
            const txt = giftText || inp.value.trim();
            if (!txt || !activeReelId) return;
            
            const uData = (await getDoc(doc(db, "users", me.uid))).data();
            const list = document.getElementById('cmt-list');
            if(list.innerText.includes("No comments")) list.innerHTML = "";

            const isGift = !!giftText;
            list.innerHTML += `
                <div class="cmt-item ${isGift ? 'gift-msg' : ''}" style="opacity:0.7">
                    <img src="${uData.profilePic}" style="width:32px;height:32px;border-radius:50%;">
                    <div>
                        <div style="font-size:12px;color:#aaa;font-weight:700;">${uData.fullName}</div>
                        <div style="font-size:13px;color:white;">${txt}</div>
                    </div>
                </div>`;
            list.scrollTop = list.scrollHeight;
            if(!giftText) inp.value = "";

            await addDoc(collection(db, "posts", activeReelId, "comments"), {
                uid: me.uid, uName: uData.fullName, uPic: uData.profilePic, 
                txt: txt, timestamp: new Date().toISOString(), isGift: isGift
            });
        };

        window.openGift = (id) => {
            activeReelId = id;
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('gift-modal').classList.add('active');
            selectedGift = null;
            document.querySelectorAll('.gift-item').forEach(el => el.classList.remove('selected'));
        };

        window.selectGift = (el, name, emoji) => {
            document.querySelectorAll('.gift-item').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            selectedGift = { name, emoji };
        };

        window.sendSelectedGift = () => {
            if(!selectedGift) return alert("Please select a gift!");
            closeModals();
            openComments(activeReelId).then(() => {
                postComment(`Sent a Gift ${selectedGift.emoji} - ${selectedGift.name}`);
            });
        };

        /* --- Share & Utility --- */
        window.openShare = (id) => {
            activeReelId = id;
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('share-modal').classList.add('active');
        };

        window.shareToFeed = async () => {
            if(!activeReelId) return;
            const original = (await getDoc(doc(db,"posts", activeReelId))).data();
            const myData = (await getDoc(doc(db,"users", me.uid))).data();
            
            await addDoc(collection(db, "posts"), {
                uid: me.uid, userName: myData.fullName, userPic: myData.profilePic,
                text: `Shared a reel from ${original.userName}`, mediaUrl: original.mediaUrl,
                type: 'video', likes: [], timestamp: new Date().toISOString()
            });
            closeModals(); alert("Shared to feed!");
        };

        window.copyLink = () => { navigator.clipboard.writeText(`https://tio.app/reel/${activeReelId}`); alert("Link Copied!"); closeModals(); };
        window.shareExternal = (app) => { alert(`Opening ${app}...`); closeModals(); };
        window.closeModals = () => { document.getElementById('overlay').style.display = 'none'; document.querySelectorAll('.modal-sheet').forEach(m => m.classList.remove('active')); };

        /* --- Video Observer & Progress --- */
        function initVideoObserver() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const video = entry.target.querySelector('video');
                    const bar = entry.target.querySelector('.progress-bar');
                    const disc = entry.target.querySelector('.music-disc');

                    if (entry.isIntersecting) {
                        video.currentTime = 0;
                        video.play().catch(()=>{});
                        // Animation Play
                        if(disc) disc.style.animationPlayState = 'running';
                        
                        // Progress Update Logic
                        video.ontimeupdate = () => {
                            if(video.duration) {
                                const pct = (video.currentTime / video.duration) * 100;
                                if(bar) bar.style.width = pct + "%";
                            }
                        };
                    } else {
                        video.pause();
                        if(disc) disc.style.animationPlayState = 'paused';
                    }
                });
            }, { threshold: 0.6 });
            document.querySelectorAll('.reel').forEach(reel => observer.observe(reel));
        }
    </script>
</body>
</html>
