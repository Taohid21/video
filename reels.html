<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tio Reels Pro</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #00d2ff; --white: #ffffff; --dark-bg: #000000; --glass: rgba(255,255,255,0.1); }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        html, body { height: 100%; width: 100%; background: var(--dark-bg); color: var(--white); overflow: hidden; }
        
        .app-container { 
            height: 100%; width: 100%; 
            overflow-y: scroll; 
            scroll-snap-type: y mandatory; 
            scroll-behavior: smooth;
            scrollbar-width: none; 
            position: absolute; top: 0; left: 0;
        }
        .app-container::-webkit-scrollbar { display: none; }
        
        .reel { 
            height: 100%; width: 100%; 
            scroll-snap-align: start; scroll-snap-stop: always; 
            position: relative; display: flex; justify-content: center; align-items: center; 
            background: #111; overflow: hidden; 
        }
        
        .reel-video { width: 100%; height: 100%; object-fit: cover; display: block; }
        .gradient-overlay { position: absolute; bottom: 0; left: 0; width: 100%; height: 50%; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); pointer-events: none; }
        
        /* --- Progress Bar --- */
        .progress-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 2px; background: rgba(255,255,255,0.2); z-index: 20; }
        .progress-bar { height: 100%; background: var(--accent); width: 0%; transition: width 0.1s linear; }

        /* --- Right Actions (Updated) --- */
        .actions-bar { 
            position: absolute; right: 8px; bottom: 40px; /* ‡¶®‡¶ø‡¶ö‡ßá ‡¶®‡¶æ‡¶Æ‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá */
            z-index: 10; display: flex; flex-direction: column; gap: 18px; /* ‡¶ó‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ï‡¶Æ‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá */
            align-items: center; padding-bottom: 20px; 
        }
        
        .action-btn { position: relative; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; transition: transform 0.2s; }
        .action-btn:active { transform: scale(0.9); }
        
        /* ‡¶Ü‡¶á‡¶ï‡¶® ‡¶õ‡ßã‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá */
        .icon-box { 
            width: 38px; height: 38px; 
            background: rgba(0,0,0,0.3); backdrop-filter: blur(4px); 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            font-size: 18px; transition: 0.3s; border: 1px solid rgba(255,255,255,0.1); 
        }
        .action-label { font-size: 10px; font-weight: 600; text-shadow: 0 1px 3px rgba(0,0,0,0.9); }

        /* FB Style Reaction Popup */
        .reactions-container {
            position: absolute; right: 50px; bottom: 0;
            background: #ffffff; border-radius: 30px;
            padding: 5px; display: flex; gap: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            opacity: 0; visibility: hidden;
            transform: scale(0.8) translateX(20px);
            transition: all 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none; z-index: 100;
        }
        .reactions-container.show { opacity: 1; visibility: visible; transform: scale(1) translateX(0); pointer-events: auto; }
        .react-emoji { font-size: 24px; transition: transform 0.2s; cursor: pointer; user-select: none; }
        .react-emoji:hover { transform: scale(1.4) translateY(-5px); }
        
        /* Selected Reaction Colors */
        .icon-box.reacted { border-color: transparent; }
        .react-like { color: #1877F2; } .react-love { color: #F02849; } 
        .react-haha { color: #F7B125; } .react-wow { color: #F7B125; } 
        .react-sad { color: #F7B125; } .react-angry { color: #E4605E; }

        /* --- User Info Area --- */
        .info-area { position: absolute; bottom: 10px; left: 0; width: 100%; padding: 15px 60px 20px 10px; z-index: 5; pointer-events: none; }
        .user-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; pointer-events: auto; width: fit-content; }
        .u-pic { width: 38px; height: 38px; border-radius: 50%; border: 1px solid var(--white); object-fit: cover; }
        .u-name { font-weight: 700; font-size: 15px; text-shadow: 0 1px 2px rgba(0,0,0,0.8); display: flex; flex-direction: column; }
        
        /* Follow ‡¶è‡¶∞ ‡¶¨‡¶¶‡¶≤‡ßá Public Badge */
        .public-badge { font-size: 11px; font-weight: 400; color: rgba(255,255,255,0.8); display: flex; align-items: center; gap: 4px; margin-top: 1px; }
        
        .caption { font-size: 13px; line-height: 1.3; color: #f0f0f0; margin-bottom: 6px; text-shadow: 0 1px 1px black; }
        
        /* Music Animation */
        .music-disc-wrap { margin-top: 5px; position: relative; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; }
        .music-disc { width: 100%; height: 100%; background: #222; border-radius: 50%; border: 5px solid #222; overflow: hidden; animation: spin 5s linear infinite; }
        .music-disc img { width: 100%; height: 100%; object-fit: cover; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- Modern Share Modal --- */
        .modal-sheet { 
            position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(20, 20, 20, 0.95); 
            z-index: 100; border-radius: 25px 25px 0 0; 
            transform: translateY(110%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); 
            backdrop-filter: blur(10px); border-top: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 20px;
        }
        .modal-sheet.active { transform: translateY(0); }
        .drag-handle { width: 40px; height: 4px; background: #555; border-radius: 5px; margin: 10px auto; }
        
        /* Share Specific Styles */
        .share-header { padding: 10px 20px; font-weight: 700; font-size: 16px; border-bottom: 1px solid rgba(255,255,255,0.05); color: #fff; }
        
        .share-row-scroll { display: flex; gap: 15px; overflow-x: auto; padding: 20px; scrollbar-width: none; }
        .share-row-scroll::-webkit-scrollbar { display: none; }
        
        .share-item { min-width: 60px; display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; }
        .share-icon-circle { 
            width: 50px; height: 50px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; font-size: 22px; 
            background: rgba(255,255,255,0.1); transition: 0.2s; 
        }
        .share-item:active .share-icon-circle { transform: scale(0.9); background: var(--accent); color: black; }
        .share-label { font-size: 11px; color: #bbb; text-align: center; }

        /* Big Heart Animation */
        .big-heart { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); font-size: 80px; z-index: 20; pointer-events: none; filter: drop-shadow(0 0 10px rgba(0,0,0,0.5)); transition: 0.2s; }
        .big-heart.animate { animation: heartPop 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes heartPop { 0%{transform: translate(-50%, -50%) scale(0); opacity: 0;} 15%{transform: translate(-50%, -50%) scale(1.3); opacity: 1;} 100%{transform: translate(-50%, -50%) scale(1.5); opacity: 0;} }
    </style>
</head>
<body>

    <div class="app-container" id="feed-container">
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#888;">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
        </div>
    </div>

    <div id="overlay" onclick="closeModals()" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:90;display:none;"></div>

    <!-- Modern Share Modal -->
    <div class="modal-sheet" id="share-modal">
        <div class="drag-handle"></div>
        <div class="share-header">Share to</div>
        
        <!-- Direct Share Row -->
        <div class="share-row-scroll">
            <div class="share-item" onclick="shareAction('feed')">
                <div class="share-icon-circle" style="background:#E1306C; color:white;"><i class="fas fa-rss"></i></div>
                <span class="share-label">My Feed</span>
            </div>
            <div class="share-item" onclick="shareAction('whatsapp')">
                <div class="share-icon-circle" style="background:#25D366; color:white;"><i class="fab fa-whatsapp"></i></div>
                <span class="share-label">WhatsApp</span>
            </div>
            <div class="share-item" onclick="shareAction('messenger')">
                <div class="share-icon-circle" style="background:#0084FF; color:white;"><i class="fab fa-facebook-messenger"></i></div>
                <span class="share-label">Messenger</span>
            </div>
            <div class="share-item" onclick="shareAction('copy')">
                <div class="share-icon-circle"><i class="fas fa-link"></i></div>
                <span class="share-label">Copy Link</span>
            </div>
        </div>

        <div style="height:1px; background:rgba(255,255,255,0.1); margin:0 20px;"></div>

        <!-- Action Row -->
        <div class="share-row-scroll">
            <div class="share-item" onclick="alert('Downloading video...')">
                <div class="share-icon-circle"><i class="fas fa-download"></i></div>
                <span class="share-label">Save Video</span>
            </div>
            <div class="share-item">
                <div class="share-icon-circle"><i class="far fa-eye-slash"></i></div>
                <span class="share-label">Not Interested</span>
            </div>
            <div class="share-item">
                <div class="share-icon-circle"><i class="fas fa-exclamation-triangle"></i></div>
                <span class="share-label">Report</span>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, query, orderBy, updateDoc, doc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase Config (‡¶è‡¶ï‡¶á ‡¶Ü‡¶õ‡ßá)
        const cfg = { apiKey: "AIzaSyD_HBGuQSh_GzqrHqHbgdaoBikLZsK3Qqs", authDomain: "new-all-f99f7.firebaseapp.com", projectId: "new-all-f99f7", storageBucket: "new-all-f99f7.appspot.com", messagingSenderId: "1069748173900", appId: "1:1069748173900:web:158d6336c0f4628133c8e9" };
        const app = initializeApp(cfg);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let me = null;
        let pressTimer;

        // Reaction Map
        const reactions = {
            'like': { icon: 'fa-thumbs-up', color: '#1877F2', class: 'react-like' },
            'love': { icon: 'fa-heart', color: '#F02849', class: 'react-love' },
            'haha': { icon: 'fa-laugh-squint', color: '#F7B125', class: 'react-haha' },
            'wow':  { icon: 'fa-surprise', color: '#F7B125', class: 'react-wow' },
            'sad':  { icon: 'fa-sad-tear', color: '#F7B125', class: 'react-sad' },
            'angry':{ icon: 'fa-angry', color: '#E4605E', class: 'react-angry' }
        };

        onAuthStateChanged(auth, (u) => {
            if (u) { me = u; loadReels(); }
        });

        async function loadReels() {
            const feed = document.getElementById('feed-container');
            const q = query(collection(db, "posts"), orderBy("timestamp", "desc"));
            const s = await getDocs(q);
            
            let html = "";
            s.forEach(d => {
                const p = d.data();
                if (p.type === 'video' && p.mediaUrl) {
                    // Check if user has reacted
                    let myReaction = null; // Default none
                    // (Real app would store reaction type in DB, simplified here to array check)
                    const isLiked = p.likes && p.likes.includes(me.uid);
                    
                    html += `
                    <div class="reel">
                        <div class="big-heart" id="bh-${d.id}"><i class="fas fa-heart" style="color:#F02849"></i></div>
                        
                        <video class="reel-video" src="${p.mediaUrl}" loop playsinline onclick="handleDoubleTap(this, '${d.id}')"></video>
                        <div class="gradient-overlay"></div>
                        <div class="progress-container"><div class="progress-bar"></div></div>

                        <div class="actions-bar">
                            <!-- Reaction / Like Btn -->
                            <div class="action-btn" id="btn-${d.id}">
                                <div class="reactions-container" id="rc-${d.id}">
                                    <span class="react-emoji" onclick="setReaction('${d.id}', 'like')">üëç</span>
                                    <span class="react-emoji" onclick="setReaction('${d.id}', 'love')">‚ù§Ô∏è</span>
                                    <span class="react-emoji" onclick="setReaction('${d.id}', 'haha')">üòÇ</span>
                                    <span class="react-emoji" onclick="setReaction('${d.id}', 'wow')">üòÆ</span>
                                    <span class="react-emoji" onclick="setReaction('${d.id}', 'sad')">üò¢</span>
                                    <span class="react-emoji" onclick="setReaction('${d.id}', 'angry')">üò°</span>
                                </div>
                                <div class="icon-box ${isLiked ? 'reacted react-love' : ''} reaction-trigger"
                                     ontouchstart="startPress('${d.id}')" 
                                     ontouchend="endPress('${d.id}')" 
                                     onmousedown="startPress('${d.id}')" 
                                     onmouseup="endPress('${d.id}')">
                                    <i class="${isLiked ? 'fas fa-heart' : 'fas fa-heart'}" style="${isLiked ? '' : 'color:white'}"></i>
                                </div>
                                <span class="action-label l-cnt">${p.likes ? p.likes.length : 0}</span>
                            </div>

                            <div class="action-btn" onclick="alert('Open Comments')">
                                <div class="icon-box"><i class="fas fa-comment-dots"></i></div>
                                <span class="action-label">${Math.floor(Math.random()*50)}</span>
                            </div>

                            <!-- New Gift Feature (Replaces Save) -->
                            <div class="action-btn" onclick="alert('Gift sent!')">
                                <div class="icon-box" style="border-color:#ffd700"><i class="fas fa-gift" style="color:#ffd700"></i></div>
                                <span class="action-label">Gift</span>
                            </div>

                            <div class="action-btn" onclick="openShare('${d.id}')">
                                <div class="icon-box"><i class="fas fa-share"></i></div>
                                <span class="action-label">Share</span>
                            </div>

                            <div class="music-disc-wrap">
                                <div class="music-disc"><img src="${p.userPic}"></div>
                            </div>
                        </div>

                        <div class="info-area">
                            <div class="user-row">
                                <img src="${p.userPic}" class="u-pic">
                                <div class="u-name">
                                    ${p.userName}
                                    <div class="public-badge"><i class="fas fa-globe-americas"></i> Public</div>
                                </div>
                            </div>
                            <div class="caption">${p.text || ''}</div>
                        </div>
                    </div>`;
                }
            });
            feed.innerHTML = html || "<h3 style='text-align:center;margin-top:50%;'>No Reels</h3>";
            initObserver();
        }

        // --- Logic for Reactions ---
        window.startPress = (id) => {
            pressTimer = setTimeout(() => {
                // Long press detected
                document.getElementById(`rc-${id}`).classList.add('show');
                pressTimer = null; // Reset
            }, 500); // 500ms hold time
        };

        window.endPress = (id) => {
            if (pressTimer) {
                // Was a short tap (Like Toggle)
                clearTimeout(pressTimer);
                toggleSimpleLike(id);
            }
            // If it was long press, popup stays open until option selected
        };

        window.setReaction = async (id, type) => {
            const rc = document.getElementById(`rc-${id}`);
            rc.classList.remove('show'); // Hide popup
            
            const btn = document.getElementById(`btn-${id}`);
            const iconBox = btn.querySelector('.icon-box');
            const icon = iconBox.querySelector('i');
            const count = btn.querySelector('.l-cnt');
            
            // UI Update
            iconBox.className = `icon-box reacted ${reactions[type].class} reaction-trigger`;
            icon.className = `fas ${reactions[type].icon}`;
            // DB Update Logic (Simplified)
            // await updateDoc(...)
        };

        window.toggleSimpleLike = (id) => {
            const rc = document.getElementById(`rc-${id}`);
            if(rc.classList.contains('show')) {
                rc.classList.remove('show'); // Close popup if open
                return;
            }

            const btn = document.getElementById(`btn-${id}`);
            const iconBox = btn.querySelector('.icon-box');
            const icon = iconBox.querySelector('i');
            const cnt = btn.querySelector('.l-cnt');
            let n = parseInt(cnt.innerText);

            if (iconBox.classList.contains('reacted')) {
                // Unlike
                iconBox.className = 'icon-box reaction-trigger';
                icon.className = 'fas fa-heart';
                icon.style.color = 'white';
                cnt.innerText = Math.max(0, n - 1);
            } else {
                // Default Like (Love)
                iconBox.className = 'icon-box reacted react-love reaction-trigger';
                icon.className = 'fas fa-heart';
                icon.style.removeProperty('color');
                cnt.innerText = n + 1;
                showBigHeart(id);
            }
        };

        // --- Double Tap ---
        let lastTap = 0;
        window.handleDoubleTap = (video, id) => {
            const now = new Date().getTime();
            if (now - lastTap < 300) {
                // Double tap action
                showBigHeart(id);
                // Force like if not liked
                const btn = document.getElementById(`btn-${id}`);
                if (!btn.querySelector('.icon-box').classList.contains('reacted')) {
                    toggleSimpleLike(id);
                }
            } else {
                // Single tap: Mute/Unmute
                video.muted = !video.muted;
            }
            lastTap = now;
        };

        function showBigHeart(id) {
            const h = document.getElementById(`bh-${id}`);
            h.classList.remove('animate');
            void h.offsetWidth; // Trigger reflow
            h.classList.add('animate');
        }

        // --- Share & Video Logic ---
        window.openShare = (id) => {
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('share-modal').classList.add('active');
        };

        window.closeModals = () => {
            document.getElementById('overlay').style.display = 'none';
            document.querySelectorAll('.modal-sheet').forEach(m => m.classList.remove('active'));
        };

        window.shareAction = (type) => {
            alert("Sharing via " + type);
            closeModals();
        };

        function initObserver() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const v = entry.target.querySelector('video');
                    const bar = entry.target.querySelector('.progress-bar');
                    if(entry.isIntersecting) {
                        v.currentTime = 0; v.play().catch(()=>{});
                        v.ontimeupdate = () => bar.style.width = (v.currentTime / v.duration) * 100 + "%";
                    } else {
                        v.pause();
                    }
                });
            }, {threshold: 0.6});
            document.querySelectorAll('.reel').forEach(r => observer.observe(r));
        }
    </script>
</body>
</html>
