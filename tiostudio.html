<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>tio Studio</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #18191a; --card: #242526; --text: #e4e6eb; --text-sec: #b0b3b8; --accent: #2d88ff; --border: #3e4042; }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Roboto', sans-serif; }
        body { background: var(--bg); color: var(--text); padding-bottom: 20px; }
        .header { background: var(--card); padding: 15px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .back-btn { font-size: 20px; cursor: pointer; color: var(--text-sec); }
        .brand { font-size: 22px; font-weight: 800; background: -webkit-linear-gradient(45deg, #FF416C, #FF4B2B); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .container { padding: 20px; max-width: 800px; margin: 0 auto; }
        .welcome { margin-bottom: 20px; }
        .welcome h2 { font-size: 24px; }
        .welcome p { color: var(--text-sec); font-size: 14px; }

        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--border); }
        .stat-head { color: var(--text-sec); font-size: 13px; font-weight: 600; text-transform: uppercase; margin-bottom: 5px; display: flex; justify-content: space-between; }
        .stat-val { font-size: 28px; font-weight: 700; color: var(--text); }
        .stat-trend { font-size: 12px; color: #4cd137; display: flex; align-items: center; gap: 3px; margin-top: 5px; }
        
        .chart-box { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 25px; }
        
        .list-box { background: var(--card); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; }
        .lb-head { padding: 15px; border-bottom: 1px solid var(--border); font-weight: 700; font-size: 16px; }
        .post-row { display: flex; align-items: center; gap: 12px; padding: 15px; border-bottom: 1px solid var(--border); transition: 0.2s; }
        .post-row:last-child { border-bottom: none; }
        .post-row:hover { background: rgba(255,255,255,0.05); }
        .pr-img { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; background: #333; }
        .pr-info { flex: 1; }
        .pr-txt { font-weight: 600; font-size: 14px; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; }
        .pr-meta { font-size: 12px; color: var(--text-sec); }
        .pr-stat { text-align: right; }
        .pr-num { font-weight: 700; font-size: 15px; color: var(--accent); }
        .pr-lbl { font-size: 11px; color: var(--text-sec); }

        #loader { position:fixed;top:0;left:0;width:100%;height:100%;background:var(--bg);z-index:9999;display:flex;justify-content:center;align-items:center; }
    </style>
</head>
<body>

    <div id="loader"><i class="fas fa-circle-notch fa-spin" style="color:var(--accent);font-size:30px;"></i></div>

    <div class="header">
        <i class="fas fa-arrow-left back-btn" onclick="location.href='index.html'"></i>
        <div class="brand">tio Studio</div>
    </div>

    <div class="container">
        <div class="welcome">
            <h2 id="u-name">Welcome Back</h2>
            <p>Here's what's happening with your content today.</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-head">Total Likes <i class="fas fa-thumbs-up"></i></div>
                <div class="stat-val" id="t-likes">0</div>
                <div class="stat-trend"><i class="fas fa-arrow-up"></i> +12% this week</div>
            </div>
            <div class="stat-card">
                <div class="stat-head">Total Posts <i class="fas fa-layer-group"></i></div>
                <div class="stat-val" id="t-posts">0</div>
                <div class="stat-trend" style="color:var(--text-sec)">Lifetime</div>
            </div>
            <div class="stat-card">
                <div class="stat-head">Est. Reach <i class="fas fa-globe"></i></div>
                <div class="stat-val" id="t-reach">0</div>
                <div class="stat-trend"><i class="fas fa-arrow-up"></i> High Impact</div>
            </div>
            <div class="stat-card">
                <div class="stat-head">Avg. Engagement <i class="fas fa-chart-pie"></i></div>
                <div class="stat-val" id="t-eng">0%</div>
                <div class="stat-trend">Based on likes</div>
            </div>
        </div>

        <div class="chart-box">
            <canvas id="growthChart"></canvas>
        </div>

        <div class="list-box">
            <div class="lb-head">Top Performing Content</div>
            <div id="top-posts"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const cfg = { apiKey: "AIzaSyD_HBGuQSh_GzqrHqHbgdaoBikLZsK3Qqs", authDomain: "new-all-f99f7.firebaseapp.com", projectId: "new-all-f99f7", storageBucket: "new-all-f99f7.appspot.com", messagingSenderId: "1069748173900", appId: "1:1069748173900:web:158d6336c0f4628133c8e9" };
        
        const app = initializeApp(cfg);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, async (u) => {
            if(u) {
                const ud = await getDoc(doc(db,"users",u.uid));
                document.getElementById('u-name').innerText = "Hello, " + ud.data().fullName.split(' ')[0];
                loadStats(u.uid);
            } else {
                location.href = "Account.html";
            }
        });

        async function loadStats(uid) {
            const q = query(collection(db, "posts"), where("uid", "==", uid));
            const snap = await getDocs(q);
            
            let totalLikes = 0;
            let totalPosts = 0;
            let postsData = [];
            let likesHistory = [0,0,0,0,0,0]; // Placeholder for graph data

            snap.forEach(d => {
                const p = d.data();
                const lk = p.likes ? p.likes.length : 0;
                totalLikes += lk;
                totalPosts++;
                postsData.push({ id: d.id, txt: p.text, img: p.mediaUrl, likes: lk, type: p.type, date: p.timestamp });
            });

            // Sort by likes for Top Content
            postsData.sort((a,b) => b.likes - a.likes);

            // UI Update
            document.getElementById('t-likes').innerText = formatNum(totalLikes);
            document.getElementById('t-posts').innerText = totalPosts;
            
            // Fake logic for Reach (Reach is usually 10x - 20x of likes in small apps)
            const reach = totalLikes * 12 + (totalPosts * 50);
            document.getElementById('t-reach').innerText = formatNum(reach);

            // Engagement Rate
            const eng = totalPosts > 0 ? ((totalLikes / reach) * 100).toFixed(1) : 0;
            document.getElementById('t-eng').innerText = eng + "%";

            // Render List
            const listHTML = postsData.slice(0, 5).map(p => {
                let thumb = p.img;
                if(!thumb) thumb = 'https://via.placeholder.com/50?text=Txt';
                if(p.type === 'video') thumb = 'https://via.placeholder.com/50?text=Vid'; // In real app generate thumbnail
                
                return `<div class="post-row">
                    <img src="${thumb}" class="pr-img">
                    <div class="pr-info">
                        <div class="pr-txt">${p.txt || 'Media Post'}</div>
                        <div class="pr-meta">${new Date(p.date).toLocaleDateString()}</div>
                    </div>
                    <div class="pr-stat">
                        <div class="pr-num">${p.likes}</div>
                        <div class="pr-lbl">Likes</div>
                    </div>
                </div>`;
            }).join('');
            document.getElementById('top-posts').innerHTML = listHTML || '<div style="padding:20px;text-align:center;color:gray;">No data available</div>';

            renderChart(totalLikes);
            document.getElementById('loader').style.display = 'none';
        }

        function formatNum(num) {
            if(num >= 1000000) return (num/1000000).toFixed(1) + 'M';
            if(num >= 1000) return (num/1000).toFixed(1) + 'K';
            return num;
        }

        function renderChart(total) {
            const ctx = document.getElementById('growthChart').getContext('2d');
            
            // Generating some dummy trend data based on total likes for visual effect
            const data = [
                Math.floor(total * 0.1), 
                Math.floor(total * 0.3), 
                Math.floor(total * 0.45), 
                Math.floor(total * 0.6), 
                Math.floor(total * 0.8), 
                total
            ];

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Today'],
                    datasets: [{
                        label: 'Engagement Growth',
                        data: data,
                        borderColor: '#2d88ff',
                        backgroundColor: 'rgba(45, 136, 255, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { display: false },
                        x: { grid: { display: false }, ticks: { color: '#b0b3b8' } }
                    }
                }
            });
        }
    </script>
</body>
</html>
