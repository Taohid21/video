<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>tio</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-body: #f0f2f5;
            --bg-card: #ffffff;
            --text-main: #050505;
            --text-sub: #65676b;
            --primary: #1877f2;
            --divider: #e4e6eb;
            --nav-height: 55px;
        }

        body.dark-mode {
            --bg-body: #000000;
            --bg-card: #121212;
            --text-main: #e4e6eb;
            --text-sub: #b0b3b8;
            --divider: #2f3031;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg-body); color: var(--text-main); padding-top: var(--nav-height); padding-bottom: 60px; min-height: 100vh; overflow-x: hidden; }
        
        .navbar { position: fixed; top: 0; left: 0; width: 100%; height: var(--nav-height); background: var(--bg-card); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; z-index: 1000; border-bottom: 1px solid var(--divider); }
        .logo { font-size: 26px; font-weight: 800; color: var(--primary); letter-spacing: -1px; }
        .nav-icons { display: flex; gap: 20px; }
        .nav-icons i { font-size: 22px; color: var(--text-main); cursor: pointer; }

        .container { max-width: 100%; margin: 0 auto; }
        .hidden { display: none !important; }

        .story-section { background: var(--bg-card); padding: 15px 10px; margin-bottom: 8px; overflow-x: auto; white-space: nowrap; }
        .story-circle { display: inline-block; width: 70px; margin-right: 15px; text-align: center; cursor: pointer; }
        .story-ring { width: 65px; height: 65px; border-radius: 50%; padding: 2px; border: 2px solid var(--primary); }
        .story-ring img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 2px solid var(--bg-card); }
        .story-user { font-size: 11px; margin-top: 5px; color: var(--text-main); overflow: hidden; text-overflow: ellipsis; }
        .add-story .story-ring { border-color: #ddd; position: relative; }
        .add-story .plus { position: absolute; bottom: 0; right: 0; background: var(--primary); color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; display: flex; align-items: center; justify-content: center; border: 2px solid var(--bg-card); }

        .create-post-box { background: var(--bg-card); padding: 15px; margin-bottom: 8px; display: flex; align-items: center; gap: 12px; }
        .cp-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .cp-input { flex: 1; background: var(--bg-body); padding: 10px 15px; border-radius: 20px; color: var(--text-main); font-size: 15px; border: none; outline: none; }

        .post-card { background: var(--bg-card); margin-bottom: 8px; width: 100%; border-top: 1px solid var(--divider); border-bottom: 1px solid var(--divider); }
        .post-header { display: flex; align-items: center; padding: 12px 15px; justify-content: space-between; }
        .p-head-left { display: flex; align-items: center; gap: 10px; }
        .p-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .p-name { font-weight: 600; font-size: 15px; color: var(--text-main); }
        .p-time { font-size: 12px; color: var(--text-sub); }
        .post-content { padding: 0 15px 10px; font-size: 15px; line-height: 1.5; color: var(--text-main); }
        .post-media { width: 100%; display: block; background: #000; }
        .post-media img, .post-media video { width: 100%; display: block; max-height: 600px; object-fit: contain; }
        .post-stats { padding: 10px 15px; display: flex; justify-content: space-between; color: var(--text-sub); font-size: 13px; border-bottom: 1px solid var(--divider); }
        .post-actions { display: flex; height: 45px; align-items: center; }
        .p-action-btn { flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; color: var(--text-sub); font-weight: 500; font-size: 14px; cursor: pointer; height: 100%; }
        .p-action-btn:active { background: var(--bg-body); }
        .p-action-btn.liked { color: var(--primary); }

        .modal-wrap { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; background: rgba(0,0,0,0.5); visibility: hidden; opacity: 0; transition: 0.2s; }
        .modal-wrap.active { visibility: visible; opacity: 1; }
        
        .full-sheet { position: absolute; bottom: 0; left: 0; width: 100%; background: var(--bg-card); border-radius: 15px 15px 0 0; height: 85vh; display: flex; flex-direction: column; transform: translateY(100%); transition: 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .modal-wrap.active .full-sheet { transform: translateY(0); }
        
        .fs-header { padding: 15px; border-bottom: 1px solid var(--divider); display: flex; align-items: center; justify-content: space-between; font-weight: 700; font-size: 16px; }
        .fs-close { background: var(--bg-body); width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-main); }
        
        .fs-body { flex: 1; overflow-y: auto; padding: 0; }
        
        .settings-menu .menu-item { padding: 15px 20px; display: flex; align-items: center; gap: 15px; font-size: 16px; border-bottom: 1px solid var(--divider); cursor: pointer; color: var(--text-main); }
        .menu-item i { width: 25px; color: var(--text-sub); }

        .comment-area { display: flex; flex-direction: column; height: 100%; }
        .comment-list { flex: 1; overflow-y: auto; padding: 15px; }
        .comment-box { display: flex; gap: 10px; margin-bottom: 20px; }
        .c-avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; }
        .c-content { display: flex; flex-direction: column; gap: 4px; max-width: 85%; }
        .c-bubble { background: var(--bg-body); padding: 10px 14px; border-radius: 18px; position: relative; }
        .c-name { font-weight: 700; font-size: 13px; margin-bottom: 2px; color: var(--text-main); }
        .c-text { font-size: 14px; color: var(--text-main); word-break: break-word; }
        .c-actions { display: flex; gap: 15px; padding-left: 12px; font-size: 12px; color: var(--text-sub); font-weight: 500; }
        .c-act-btn { cursor: pointer; }
        .c-act-btn.liked { color: var(--primary); }
        
        .comment-input-wrap { padding: 10px; border-top: 1px solid var(--divider); display: flex; align-items: center; gap: 10px; background: var(--bg-card); }
        .c-input { flex: 1; background: var(--bg-body); border: none; padding: 12px 15px; border-radius: 25px; outline: none; color: var(--text-main); }
        .c-send { color: var(--primary); font-size: 20px; padding: 5px; cursor: pointer; }

        .profile-top { background: var(--bg-card); padding-bottom: 20px; margin-bottom: 8px; }
        .cover-img { width: 100%; height: 180px; object-fit: cover; background: #ddd; }
        .prof-info { padding: 0 15px; margin-top: -50px; position: relative; text-align: center; }
        .prof-pic-lg { width: 110px; height: 110px; border-radius: 50%; border: 4px solid var(--bg-card); object-fit: cover; background: #eee; }
        .prof-name { font-size: 24px; font-weight: 700; margin-top: 5px; color: var(--text-main); }
        .prof-bio { color: var(--text-sub); font-size: 14px; margin: 5px 0 15px; }
        
        .edit-prof-form { padding: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 500; margin-bottom: 8px; font-size: 14px; }
        .form-control { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--divider); background: var(--bg-body); color: var(--text-main); outline: none; }
        .img-preview { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-top: 10px; border: 1px solid var(--divider); }
        .upload-btn { background: var(--bg-body); padding: 8px 15px; border-radius: 6px; font-size: 13px; font-weight: 500; display: inline-block; cursor: pointer; margin-top: 5px; }
        .save-btn { width: 100%; background: var(--primary); color: white; border: none; padding: 14px; border-radius: 8px; font-weight: 600; font-size: 16px; margin-top: 10px; }

        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: var(--bg-card); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid var(--divider); z-index: 999; }
        .bn-item { font-size: 24px; color: var(--text-sub); padding: 10px; position: relative; cursor: pointer; }
        .bn-item.active { color: var(--primary); }
        .bn-item.active::after { content: ''; position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 100%; height: 3px; background: var(--primary); }

        .section { display: none; }
        .section.active { display: block; }
        
        .search-modal { position: fixed; inset: 0; background: var(--bg-card); z-index: 3000; padding: 10px; display: none; }
        .search-modal.active { display: block; }
        .search-res-item { display: flex; align-items: center; gap: 10px; padding: 12px; border-bottom: 1px solid var(--divider); cursor: pointer; }
    </style>
</head>
<body>

    <div class="navbar">
        <div class="logo">tio</div>
        <div class="nav-icons">
            <i class="fas fa-search" onclick="toggleSearch(true)"></i>
            <i class="fas fa-cog" onclick="openSettings()"></i>
        </div>
    </div>

    <div id="homeSection" class="section active container">
        <div class="story-section">
            <div class="story-circle add-story" onclick="document.getElementById('storyUpload').click()">
                <div class="story-ring">
                    <img id="myStoryThumb" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
                    <div class="plus"><i class="fas fa-plus"></i></div>
                </div>
                <div class="story-user">Your Story</div>
                <input type="file" id="storyUpload" hidden accept="image/*" onchange="handleStoryUpload(this)">
            </div>
            <div id="storyList" style="display:inline;"></div>
        </div>

        <div class="create-post-box" onclick="window.location.href='post.html'">
            <img class="cp-avatar" id="navAvatar">
            <div class="cp-input">What's on your mind?</div>
            <i class="fas fa-images" style="color: #45bd62; font-size: 20px;"></i>
        </div>

        <div id="newsFeed"></div>
    </div>

    <div id="videoSection" class="section container">
        <div style="padding: 20px; text-align: center; color: var(--text-sub);">Video Feed Coming Soon</div>
    </div>

    <div id="friendsSection" class="section container">
        <div id="requestList" style="padding: 10px;"></div>
    </div>

    <div id="profileSection" class="section">
        <div class="profile-top">
            <img class="cover-img" id="pCover">
            <div class="prof-info">
                <img class="prof-pic-lg" id="pPic">
                <h2 class="prof-name" id="pName">Loading...</h2>
                <p class="prof-bio" id="pBio"></p>
            </div>
        </div>
        <div class="container">
            <h4 style="padding: 0 15px 10px; color: var(--text-main);">My Posts</h4>
            <div id="myPosts"></div>
        </div>
    </div>

    <div class="modal-wrap" id="settingsModal">
        <div class="full-sheet" style="height: auto; max-height: 70vh;">
            <div class="fs-header">
                Settings
                <div class="fs-close" onclick="closeModal('settingsModal')"><i class="fas fa-times"></i></div>
            </div>
            <div class="fs-body settings-menu">
                <div class="menu-item" onclick="toggleTheme()">
                    <i class="fas fa-moon"></i>
                    <span>Dark Mode</span>
                </div>
                <div class="menu-item" onclick="openEditProfile()">
                    <i class="fas fa-user-edit"></i>
                    <span>Edit Profile</span>
                </div>
                <div class="menu-item">
                    <i class="fas fa-question-circle"></i>
                    <span>Help & Support</span>
                </div>
                <div class="menu-item" onclick="logout()" style="color: #ff4d4d;">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Log Out</span>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-wrap" id="editProfileModal">
        <div class="full-sheet">
            <div class="fs-header">
                Edit Profile
                <div class="fs-close" onclick="closeModal('editProfileModal')"><i class="fas fa-times"></i></div>
            </div>
            <div class="fs-body">
                <div class="edit-prof-form">
                    <div class="form-group" style="text-align: center;">
                        <img id="previewPic" class="img-preview" src="https://via.placeholder.com/100">
                        <br>
                        <label class="upload-btn">
                            Change Profile Photo
                            <input type="file" id="filePic" hidden accept="image/*" onchange="previewImage(this, 'previewPic')">
                        </label>
                    </div>

                    <div class="form-group" style="text-align: center;">
                        <img id="previewCover" class="img-preview" style="width: 100%; height: 100px; border-radius: 8px;" src="https://via.placeholder.com/300x100">
                        <br>
                        <label class="upload-btn">
                            Change Cover Photo
                            <input type="file" id="fileCover" hidden accept="image/*" onchange="previewImage(this, 'previewCover')">
                        </label>
                    </div>

                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="editName" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Bio</label>
                        <textarea id="editBio" class="form-control" rows="3"></textarea>
                    </div>
                    <button class="save-btn" onclick="saveProfileData()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-wrap" id="commentModal">
        <div class="full-sheet" style="height: 90vh;">
            <div class="fs-header">
                Comments
                <div class="fs-close" onclick="closeModal('commentModal')"><i class="fas fa-times"></i></div>
            </div>
            <div class="comment-area">
                <div class="comment-list" id="commentList"></div>
                <div class="comment-input-wrap">
                    <input type="text" class="c-input" id="commentInput" placeholder="Write a comment...">
                    <i class="fas fa-paper-plane c-send" onclick="submitComment()"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="search-modal" id="searchModal">
        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
            <i class="fas fa-arrow-left" style="font-size: 20px; padding: 10px;" onclick="toggleSearch(false)"></i>
            <input type="text" style="flex: 1; padding: 12px; border-radius: 20px; border: 1px solid #ddd; outline: none;" placeholder="Search people..." oninput="runSearch(this.value)">
        </div>
        <div id="searchResults"></div>
    </div>

    <div class="bottom-nav">
        <div class="bn-item active" onclick="navTo('homeSection', this)"><i class="fas fa-home"></i></div>
        <div class="bn-item" onclick="navTo('videoSection', this)"><i class="fas fa-play-circle"></i></div>
        <div class="bn-item" onclick="navTo('friendsSection', this); loadReqs()"><i class="fas fa-user-friends"></i></div>
        <div class="bn-item" onclick="navTo('profileSection', this); loadMyProfile()"><i class="fas fa-user"></i></div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, getDocs, addDoc, query, where, orderBy, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyD_HBGuQSh_GzqrHqHbgdaoBikLZsK3Qqs", authDomain: "new-all-f99f7.firebaseapp.com", projectId: "new-all-f99f7", storageBucket: "new-all-f99f7.appspot.com", messagingSenderId: "1069748173900", appId: "1:1069748173900:web:158d6336c0f4628133c8e9" };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    let currentUser = null;
    let activePostId = null;
    const defaultPic = "https://cdn-icons-png.flaticon.com/512/149/149071.png";
    const defaultCover = "https://colorlib.com/wp/wp-content/uploads/sites/2/2014/02/bkg_06.jpg";

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            const snap = await getDoc(doc(db, "users", user.uid));
            if(snap.exists()) {
                const d = snap.data();
                const pic = d.profilePic || defaultPic;
                document.getElementById('navAvatar').src = pic;
                document.getElementById('myStoryThumb').src = pic;
                document.querySelector('.cp-input').placeholder = `What's on your mind, ${d.firstName}?`;
                loadMainFeed();
                loadStories();
            }
        } else {
            window.location.href = "Account.html";
        }
    });

    window.navTo = (id, el) => {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.bn-item').forEach(b => b.classList.remove('active'));
        if(el) el.classList.add('active');
        window.scrollTo(0,0);
    };

    window.openSettings = () => {
        document.getElementById('settingsModal').classList.add('active');
        closeModal('editProfileModal'); 
    };

    window.closeModal = (id) => document.getElementById(id).classList.remove('active');

    window.toggleTheme = () => document.body.classList.toggle('dark-mode');
    
    window.logout = () => signOut(auth);

    window.toggleSearch = (show) => document.getElementById('searchModal').classList.toggle('active', show);

    async function loadMainFeed() {
        const feed = document.getElementById('newsFeed');
        if(!feed.hasChildNodes()) feed.innerHTML = '<div style="padding:20px;text-align:center;">Loading...</div>';
        
        const q = query(collection(db, "posts"), orderBy("timestamp", "desc"));
        const snaps = await getDocs(q);
        feed.innerHTML = "";
        snaps.forEach(doc => feed.innerHTML += buildPost(doc.data(), doc.id));
    }

    function buildPost(p, id) {
        const isLiked = p.likes && p.likes.includes(currentUser.uid) ? 'liked' : '';
        const likeNum = p.likes ? p.likes.length : 0;
        const media = p.mediaUrl ? (p.type === 'video' ? `<video controls src="${p.mediaUrl}"></video>` : `<img src="${p.mediaUrl}">`) : '';
        const uPic = p.userPic || defaultPic;

        return `
        <div class="post-card">
            <div class="post-header">
                <div class="p-head-left">
                    <img src="${uPic}" class="p-avatar">
                    <div>
                        <div class="p-name">${p.userName}</div>
                        <div class="p-time">${timeAgo(p.timestamp)}</div>
                    </div>
                </div>
                <i class="fas fa-ellipsis-h" style="color:var(--text-sub);"></i>
            </div>
            <div class="post-content">${p.text}</div>
            ${media ? `<div class="post-media">${media}</div>` : ''}
            <div class="post-stats">
                <span id="lc-${id}">${likeNum} Likes</span>
                <span onclick="openComments('${id}')">${p.commentCount || 0} Comments</span>
            </div>
            <div class="post-actions">
                <div class="p-action-btn ${isLiked}" id="lb-${id}" onclick="doLike('${id}')">
                    <i class="far fa-thumbs-up"></i> Like
                </div>
                <div class="p-action-btn" onclick="openComments('${id}')">
                    <i class="far fa-comment-alt"></i> Comment
                </div>
                <div class="p-action-btn">
                    <i class="fas fa-share"></i> Share
                </div>
            </div>
        </div>`;
    }

    window.doLike = async (pid) => {
        const btn = document.getElementById(`lb-${pid}`);
        const txt = document.getElementById(`lc-${pid}`);
        let num = parseInt(txt.innerText);
        const ref = doc(db, "posts", pid);
        
        if(btn.classList.contains('liked')) {
            btn.classList.remove('liked');
            txt.innerText = (num - 1) + " Likes";
            await updateDoc(ref, { likes: arrayRemove(currentUser.uid) });
        } else {
            btn.classList.add('liked');
            txt.innerText = (num + 1) + " Likes";
            await updateDoc(ref, { likes: arrayUnion(currentUser.uid) });
        }
    };

    window.openComments = async (pid) => {
        activePostId = pid;
        document.getElementById('commentModal').classList.add('active');
        const list = document.getElementById('commentList');
        list.innerHTML = '<div style="text-align:center; padding:20px;">Loading comments...</div>';
        
        const q = query(collection(db, `posts/${pid}/comments`), orderBy("timestamp", "asc"));
        const snaps = await getDocs(q);
        list.innerHTML = "";
        
        if(snaps.empty) {
            list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-sub);">No comments yet.</div>';
        } else {
            snaps.forEach(d => {
                const c = d.data();
                const cid = d.id;
                const cPic = c.userPic || defaultPic;
                const cLiked = c.likes && c.likes.includes(currentUser.uid) ? 'liked' : '';
                const cLikeCount = c.likes ? c.likes.length : 0;
                
                list.innerHTML += `
                <div class="comment-box">
                    <img src="${cPic}" class="c-avatar">
                    <div class="c-content">
                        <div class="c-bubble">
                            <div class="c-name">${c.userName}</div>
                            <div class="c-text">${c.text}</div>
                        </div>
                        <div class="c-actions">
                            <span>${timeAgo(c.timestamp)}</span>
                            <span class="c-act-btn ${cLiked}" id="clb-${cid}" onclick="likeComment('${pid}', '${cid}')">Like</span>
                            <span class="c-act-btn" onclick="replyComment('${c.userName}')">Reply</span>
                            <span id="clc-${cid}">${cLikeCount > 0 ? cLikeCount + ' likes' : ''}</span>
                        </div>
                    </div>
                </div>`;
            });
            list.scrollTop = list.scrollHeight;
        }
    };

    window.likeComment = async (pid, cid) => {
        const btn = document.getElementById(`clb-${cid}`);
        const txt = document.getElementById(`clc-${cid}`);
        const ref = doc(db, `posts/${pid}/comments/${cid}`);
        
        if(btn.classList.contains('liked')) {
            btn.classList.remove('liked');
            await updateDoc(ref, { likes: arrayRemove(currentUser.uid) });
        } else {
            btn.classList.add('liked');
            await updateDoc(ref, { likes: arrayUnion(currentUser.uid) });
        }
    };

    window.replyComment = (name) => {
        const input = document.getElementById('commentInput');
        input.value = `@${name} `;
        input.focus();
    };

    window.submitComment = async () => {
        const inp = document.getElementById('commentInput');
        const txt = inp.value.trim();
        if(!txt || !activePostId) return;
        
        const uRef = await getDoc(doc(db, "users", currentUser.uid));
        const u = uRef.data();
        
        await addDoc(collection(db, `posts/${activePostId}/comments`), {
            text: txt,
            uid: currentUser.uid,
            userName: u.fullName,
            userPic: u.profilePic || defaultPic,
            timestamp: Date.now(),
            likes: []
        });
        
        const pRef = doc(db, "posts", activePostId);
        const pSnap = await getDoc(pRef);
        await updateDoc(pRef, { commentCount: (pSnap.data().commentCount || 0) + 1 });
        
        inp.value = "";
        openComments(activePostId);
    };

    window.loadMyProfile = async () => {
        if(!currentUser) return;
        const snap = await getDoc(doc(db, "users", currentUser.uid));
        const d = snap.data();
        
        document.getElementById('pCover').src = d.coverPic || defaultCover;
        document.getElementById('pPic').src = d.profilePic || defaultPic;
        document.getElementById('pName').innerText = d.fullName;
        document.getElementById('pBio').innerText = d.bio || "No bio available";
        
        const box = document.getElementById('myPosts');
        box.innerHTML = "Loading posts...";
        
        const q = query(collection(db, "posts"), where("uid", "==", currentUser.uid), orderBy("timestamp", "desc"));
        const posts = await getDocs(q);
        box.innerHTML = "";
        
        if(posts.empty) box.innerHTML = "<div style='padding:20px; text-align:center;'>No posts yet</div>";
        posts.forEach(doc => box.innerHTML += buildPost(doc.data(), doc.id));
    };

    window.openEditProfile = async () => {
        closeModal('settingsModal');
        const snap = await getDoc(doc(db, "users", currentUser.uid));
        const d = snap.data();
        document.getElementById('editName').value = d.fullName;
        document.getElementById('editBio').value = d.bio || "";
        document.getElementById('previewPic').src = d.profilePic || defaultPic;
        document.getElementById('previewCover').src = d.coverPic || defaultCover;
        document.getElementById('editProfileModal').classList.add('active');
    };

    window.previewImage = (input, imgId) => {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => document.getElementById(imgId).src = e.target.result;
            reader.readAsDataURL(input.files[0]);
        }
    };

    window.saveProfileData = async () => {
        const name = document.getElementById('editName').value;
        const bio = document.getElementById('editBio').value;
        const picSrc = document.getElementById('previewPic').src;
        const coverSrc = document.getElementById('previewCover').src;

        await updateDoc(doc(db, "users", currentUser.uid), {
            fullName: name,
            bio: bio,
            profilePic: picSrc,
            coverPic: coverSrc
        });
        
        closeModal('editProfileModal');
        loadMyProfile();
    };

    window.loadStories = async () => {
        const list = document.getElementById('storyList');
        list.innerHTML = "";
        const q = query(collection(db, "stories"), orderBy("timestamp", "desc"));
        const s = await getDocs(q);
        s.forEach(doc => {
            const d = doc.data();
            const el = document.createElement('div');
            el.className = 'story-circle';
            el.innerHTML = `
            <div class="story-ring"><img src="${d.img}"></div>
            <div class="story-user">${d.name}</div>`;
            list.appendChild(el);
        });
    };

    window.handleStoryUpload = async (inp) => {
        if(inp.files && inp.files[0]){
            const reader = new FileReader();
            reader.onload = async (e) => {
                const u = await getDoc(doc(db, "users", currentUser.uid));
                await addDoc(collection(db, "stories"), {
                    uid: currentUser.uid,
                    name: u.data().firstName,
                    img: e.target.result, 
                    timestamp: Date.now()
                });
                loadStories();
            };
            reader.readAsDataURL(inp.files[0]);
        }
    };
    
    window.loadReqs = async () => {
        const div = document.getElementById('requestList');
        div.innerHTML = "Loading...";
        const u = await getDoc(doc(db, "users", currentUser.uid));
        const reqs = u.data().friendRequests || [];
        div.innerHTML = "";
        if(reqs.length === 0) div.innerHTML = "<div style='text-align:center; padding:10px;'>No requests</div>";
        
        for(const rid of reqs) {
            const f = await getDoc(doc(db, "users", rid));
            const fd = f.data();
            div.innerHTML += `
            <div style="background:var(--bg-card); padding:10px; display:flex; gap:10px; border-radius:8px; margin-bottom:5px;">
                <img src="${fd.profilePic || defaultPic}" style="width:50px; height:50px; border-radius:50%;">
                <div style="flex:1;">
                    <b>${fd.fullName}</b>
                    <div style="display:flex; gap:10px; margin-top:5px;">
                        <button onclick="ansReq('${rid}', true)" style="background:var(--primary); color:white; border:none; padding:5px 15px; border-radius:4px;">Confirm</button>
                        <button onclick="ansReq('${rid}', false)" style="background:#ddd; border:none; padding:5px 15px; border-radius:4px;">Delete</button>
                    </div>
                </div>
            </div>`;
        }
    };

    window.ansReq = async (fid, ok) => {
        const me = doc(db, "users", currentUser.uid);
        const them = doc(db, "users", fid);
        await updateDoc(me, { friendRequests: arrayRemove(fid) });
        if(ok) {
            await updateDoc(me, { friends: arrayUnion(fid) });
            await updateDoc(them, { friends: arrayUnion(currentUser.uid) });
        }
        loadReqs();
    };

    window.runSearch = async (val) => {
        const res = document.getElementById('searchResults');
        if(val.length < 3) { res.innerHTML=""; return; }
        const q = query(collection(db, "users"), where("fullName", ">=", val), where("fullName", "<=", val + '\uf8ff'));
        const s = await getDocs(q);
        res.innerHTML = "";
        s.forEach(d => {
            const u = d.data();
            res.innerHTML += `
            <div class="search-res-item">
                <img src="${u.profilePic || defaultPic}" style="width:40px; height:40px; border-radius:50%;">
                <b>${u.fullName}</b>
            </div>`;
        });
    };

    function timeAgo(ts) {
        const s = Math.floor((Date.now() - ts) / 1000);
        if(s < 60) return 'Just now';
        const m = Math.floor(s/60);
        if(m < 60) return m + 'm';
        const h = Math.floor(m/60);
        if(h < 24) return h + 'h';
        return Math.floor(h/24) + 'd';
    }
</script>
</body>
</html>