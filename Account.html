<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>tio - Log In or Sign Up</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; }
        body { background-color: #f0f2f5; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #1877f2; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .login-container { padding: 20px; text-align: center; display: none; flex-direction: column; justify-content: center; height: 100%; }
        .app-name { font-size: 32px; color: #1877f2; font-weight: 800; margin-bottom: 40px; letter-spacing: -1px; }
        .form-group { width: 100%; max-width: 400px; margin: 0 auto; }
        .input-field { width: 100%; padding: 14px 16px; border: 1px solid #dddfe2; border-radius: 6px; font-size: 16px; margin-bottom: 12px; outline: none; }
        .input-field:focus { border-color: #1877f2; }
        .btn-login { width: 100%; background-color: #1877f2; color: white; padding: 12px; font-size: 20px; font-weight: 700; border: none; border-radius: 6px; cursor: pointer; margin-bottom: 15px; }
        .btn-create { background-color: #42b72a; color: white; padding: 10px 20px; font-size: 16px; font-weight: 700; border: none; border-radius: 6px; cursor: pointer; display: inline-block; }
        .divider { display: flex; align-items: center; margin-bottom: 30px; }
        .divider::before, .divider::after { content: ""; flex: 1; height: 1px; background: #ccd0d5; }
        .divider span { padding: 0 10px; color: #65676b; font-size: 13px; }

        .signup-container { background: #fff; height: 100%; display: none; flex-direction: column; }
        .signup-header { padding: 15px; border-bottom: 1px solid #ddd; display: flex; align-items: center; background: #fff; }
        .back-btn { font-size: 20px; cursor: pointer; color: #333; margin-right: 15px; }
        .header-title { font-size: 18px; font-weight: 600; }
        
        .step-content { padding: 20px; flex: 1; display: none; flex-direction: column; }
        .step-content.active { display: flex; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from{opacity:0;transform:translateX(20px)} to{opacity:1;transform:translateX(0)} }

        .step-title { font-size: 22px; font-weight: 700; margin-bottom: 5px; }
        .step-subtitle { color: #65676b; margin-bottom: 20px; font-size: 14px; }
        .btn-next { background: #1877f2; color: white; width: 100%; padding: 12px; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; margin-top: 20px; cursor: pointer; }
        .btn-skip { background: #e4e6eb; color: black; width: 100%; padding: 12px; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; margin-top: 10px; cursor: pointer; }
        
        .upload-circle { width: 140px; height: 140px; background: #f0f2f5; border-radius: 50%; margin: 10px auto; display: flex; justify-content: center; align-items: center; cursor: pointer; position: relative; overflow: hidden; border: 2px solid #ddd; }
        .upload-rect { width: 100%; height: 180px; background: #f0f2f5; border-radius: 8px; margin: 10px auto; display: flex; justify-content: center; align-items: center; cursor: pointer; position: relative; overflow: hidden; border: 2px solid #ddd; }
        img.preview { width: 100%; height: 100%; object-fit: cover; display: none; }
        .icon-area i { font-size: 40px; color: #bcc0c4; }
    </style>
</head>
<body>

    <div id="loading-screen"><div class="spinner"></div></div>

    <!-- Login View -->
    <div class="login-container" id="loginView">
        <div class="app-name">tio</div>
        <div class="form-group">
            <input type="email" id="loginEmail" class="input-field" placeholder="Mobile number or email">
            <input type="password" id="loginPassword" class="input-field" placeholder="Password">
            <button class="btn-login" onclick="handleLogin()">Log In</button>
            <div class="divider"><span>OR</span></div>
            <button class="btn-create" onclick="toggleView('signup')">Create new account</button>
        </div>
    </div>

    <!-- Signup Wizard -->
    <div class="signup-container" id="signupView">
        <div class="signup-header">
            <i class="fas fa-arrow-left back-btn" onclick="toggleView('login')"></i>
            <span class="header-title">Create account</span>
        </div>

        <form onsubmit="event.preventDefault()">
            
            <!-- Step 1: Name -->
            <div class="step-content active" id="step1">
                <div class="step-title">What's your name?</div>
                <div class="step-subtitle">Enter the name you use in real life.</div>
                <input type="text" id="fname" class="input-field" placeholder="First name">
                <input type="text" id="lname" class="input-field" placeholder="Surname" style="margin-top:10px;">
                <button class="btn-next" onclick="nextStep(1)">Next</button>
            </div>

            <!-- Step 2: Contact -->
            <div class="step-content" id="step2">
                <div class="step-title">Contact info</div>
                <div class="step-subtitle">Enter your mobile and email.</div>
                <input type="text" id="mobile" class="input-field" placeholder="Mobile number">
                <input type="email" id="regEmail" class="input-field" placeholder="Email address" style="margin-top:10px;">
                <button class="btn-next" onclick="nextStep(2)">Next</button>
            </div>

            <!-- Step 3: Password (ACCOUNT CREATION HAPPENS HERE) -->
            <div class="step-content" id="step3">
                <div class="step-title">Choose a password</div>
                <div class="step-subtitle">Create a password with at least 6 characters.</div>
                <input type="password" id="regPassword" class="input-field" placeholder="New password">
                <button class="btn-next" onclick="registerUser()">Sign Up</button>
                <p id="regError" style="color:red; font-size:12px; margin-top:10px; text-align:center;"></p>
            </div>

            <!-- Step 4: Profile Pic -->
            <div class="step-content" id="step4">
                <div class="step-title">Profile Picture</div>
                <div class="step-subtitle">Add a photo so friends can recognize you.</div>
                <div class="upload-circle" onclick="document.getElementById('profileInp').click()">
                    <div class="icon-area"><i class="fas fa-camera"></i></div>
                    <img id="pPreview" class="preview">
                </div>
                <input type="file" id="profileInp" hidden accept="image/*" onchange="preview(this, 'pPreview')">
                <button class="btn-next" onclick="nextStep(4)">Add Picture</button>
                <button class="btn-skip" onclick="nextStep(4)">Skip</button>
            </div>

            <!-- Step 5: Cover Photo -->
            <div class="step-content" id="step5">
                <div class="step-title">Cover Photo</div>
                <div class="step-subtitle">Add a cover photo to your profile.</div>
                <div class="upload-rect" onclick="document.getElementById('coverInp').click()">
                    <div class="icon-area"><i class="fas fa-image"></i></div>
                    <img id="cPreview" class="preview">
                </div>
                <input type="file" id="coverInp" hidden accept="image/*" onchange="preview(this, 'cPreview')">
                <button class="btn-next" id="finalBtn" onclick="uploadAndFinish()">Save & Finish</button>
                <button class="btn-skip" onclick="finish()">Skip</button>
            </div>

        </form>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyD_HBGuQSh_GzqrHqHbgdaoBikLZsK3Qqs", authDomain: "new-all-f99f7.firebaseapp.com", projectId: "new-all-f99f7", storageBucket: "new-all-f99f7.appspot.com", messagingSenderId: "1069748173900", appId: "1:1069748173900:web:158d6336c0f4628133c8e9" };
    const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dwgvvzbvn/auto/upload";
    const CLOUDINARY_PRESET = "storyapp";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let temp = {};
    let uid = "";
    // Default placeholder image
    const DEF_IMG = "https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png";

    onAuthStateChanged(auth, (user) => {
        const loader = document.getElementById('loading-screen');
        if (user) {
            // Already logged in
            window.location.href = "index.html";
        } else {
            // Not logged in, show login screen
            loader.style.display = 'none';
            document.getElementById('loginView').style.display = 'flex';
        }
    });

    window.toggleView = (v) => {
        document.getElementById('loginView').style.display = v === 'login' ? 'flex' : 'none';
        document.getElementById('signupView').style.display = v === 'signup' ? 'flex' : 'none';
    }

    window.handleLogin = async () => {
        const e = document.getElementById('loginEmail').value;
        const p = document.getElementById('loginPassword').value;
        if(!e || !p) return alert("Missing fields");
        
        document.getElementById('loading-screen').style.display = 'flex';
        try { 
            await signInWithEmailAndPassword(auth, e, p);
            // onAuthStateChanged will redirect
        } catch (err) { 
            document.getElementById('loading-screen').style.display = 'none';
            alert("Error: " + err.message); 
        }
    }

    window.nextStep = (s) => {
        // Validation
        if(s===1) {
            const f = document.getElementById('fname').value.trim();
            const l = document.getElementById('lname').value.trim();
            if(!f || !l) return alert("Please enter your name");
            temp.f = f; 
            temp.l = l;
        }
        if(s===2) {
            const m = document.getElementById('mobile').value.trim();
            const e = document.getElementById('regEmail').value.trim();
            if(!e) return alert("Please enter your email");
            temp.m = m; 
            temp.e = e;
        }

        // Just switching tabs for step 1, 2 and 4
        document.getElementById(`step${s}`).classList.remove('active');
        document.getElementById(`step${s+1}`).classList.add('active');
    }

    // Step 3: Register User AND Create Database Entry IMMEDIATELY
    window.registerUser = async () => {
        const p = document.getElementById('regPassword').value;
        if(p.length < 6) return alert("Password must be at least 6 characters");
        
        const btn = document.querySelector('#step3 button');
        const errP = document.getElementById('regError');
        
        btn.innerText = "Creating Account...";
        btn.disabled = true;
        errP.innerText = "";
        
        try {
            // 1. Create Auth
            const cred = await createUserWithEmailAndPassword(auth, temp.e, p);
            uid = cred.user.uid;
            
            // 2. Create Database Entry (Critical Step)
            // We do this BEFORE asking for photos, so data exists even if they quit.
            await setDoc(doc(db, "users", uid), {
                uid: uid,
                fullName: `${temp.f} ${temp.l}`,
                firstName: temp.f, 
                lastName: temp.l,
                mobile: temp.m, 
                email: temp.e,
                profilePic: DEF_IMG, // Set default image immediately
                coverPic: "",
                bio: "",
                friends: [], 
                friendRequests: [],
                createdAt: new Date().toISOString()
            });

            // 3. Success - Move to Photo Upload
            document.getElementById('step3').classList.remove('active');
            document.getElementById('step4').classList.add('active');
            
        } catch (e) {
            btn.innerText = "Sign Up";
            btn.disabled = false;
            errP.innerText = e.message;
            console.error(e);
        }
    }

    window.preview = (inp, id) => {
        if(inp.files[0]) {
            const r = new FileReader();
            r.onload = (e) => {
                document.getElementById(id).src = e.target.result;
                document.getElementById(id).style.display = "block";
                document.getElementById(id).previousElementSibling.style.display = "none";
            }
            r.readAsDataURL(inp.files[0]);
        }
    }

    window.uploadAndFinish = async () => {
        const pf = document.getElementById('profileInp').files[0];
        const cf = document.getElementById('coverInp').files[0];
        
        if(!pf && !cf) {
            finish();
            return;
        }

        const btn = document.getElementById('finalBtn');
        btn.innerText = "Uploading Images...";
        btn.disabled = true;

        try {
            const updateData = {};
            
            if(pf) {
                const url = await up(pf);
                if(url) updateData.profilePic = url;
            }
            if(cf) {
                const url = await up(cf);
                if(url) updateData.coverPic = url;
            }

            // Update the existing document
            if(Object.keys(updateData).length > 0) {
                await updateDoc(doc(db, "users", uid), updateData);
            }
            finish();
        } catch (e) {
            alert("Image upload failed, but account created.");
            finish();
        }
    }

    async function up(f) {
        const fd = new FormData();
        fd.append('file', f);
        fd.append('upload_preset', CLOUDINARY_PRESET);
        const r = await fetch(CLOUDINARY_URL, {method:'POST', body:fd});
        const data = await r.json();
        return data.secure_url;
    }

    window.finish = () => window.location.href = "index.html";

</script>
</body>
</html>
