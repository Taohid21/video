<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>tio</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { --bg: #f0f2f5; --card: #ffffff; --text: #050505; --sub: #65676b; --accent: #1877f2; --border: #ddd; }
        .dark-mode { --bg: #18191a; --card: #242526; --text: #e4e6eb; --sub: #b0b3b8; --accent: #2d88ff; --border: #3e4042; }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); color: var(--text); padding-top: 105px; padding-bottom: 60px; min-height: 100vh; overflow-x: hidden; }
        
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; backdrop-filter: blur(2px); }
        .header { position: fixed; top: 0; left: 0; width: 100%; height: 55px; background: var(--card); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; z-index: 1000; border-bottom: 1px solid var(--border); }
        .logo { font-size: 28px; font-weight: 800; color: var(--accent); letter-spacing: -1px; }
        .h-icons i { font-size: 18px; background: var(--bg); width: 38px; height: 38px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-left: 8px; color: var(--text); cursor: pointer; transition: 0.2s; }
        
        .tabs { position: fixed; top: 55px; left: 0; width: 100%; height: 50px; background: var(--card); display: flex; align-items: center; z-index: 999; border-bottom: 1px solid var(--border); }
        .tab { flex: 1; height: 100%; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; }
        .tab i { font-size: 24px; color: var(--sub); }
        .tab.active i { color: var(--accent); }
        .tab.active::after { content: ''; position: absolute; bottom: 0; width: 100%; height: 3px; background: var(--accent); }

        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.3s; }

        .create-box { background: var(--card); padding: 12px 15px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .u-ava { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #ccc; }
        .c-in { flex: 1; background: var(--bg); height: 40px; border-radius: 20px; padding: 0 15px; display: flex; align-items: center; color: var(--sub); border: 1px solid var(--border); cursor: pointer; }

        .story-tray { background: var(--card); padding: 15px 10px; margin-bottom: 10px; overflow-x: auto; display: flex; gap: 8px; scrollbar-width: none; }
        .story-card { min-width: 110px; height: 190px; border-radius: 12px; position: relative; overflow: hidden; background: #333; flex-shrink: 0; border: 1px solid var(--border); cursor: pointer; }
        .story-card img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; }
        .story-card:hover img { transform: scale(1.05); }
        .s-user { position: absolute; bottom: 8px; left: 8px; color: white; font-weight: 600; font-size: 13px; text-shadow: 0 1px 3px rgba(0,0,0,0.8); }
        .s-ava { position: absolute; top: 8px; left: 8px; width: 35px; height: 35px; border-radius: 50%; border: 3px solid var(--accent); object-fit: cover; }
        .s-create .s-plus { position: absolute; bottom: 35px; left: 50%; transform: translateX(-50%); background: var(--accent); color: white; width: 32px; height: 32px; border-radius: 50%; border: 3px solid var(--card); display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .s-create .s-label { position: absolute; bottom: 0; width: 100%; background: var(--card); height: 50px; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 5px; color: var(--text); font-weight: 600; font-size: 13px; }

        .post { background: var(--card); margin-bottom: 10px; width: 100%; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); position: relative; }
        .p-head { padding: 12px 15px; display: flex; align-items: center; gap: 10px; }
        .p-nm h4 { font-size: 16px; font-weight: 600; color: var(--text); cursor: pointer; }
        .p-nm span { font-size: 12px; color: var(--sub); }
        .p-del { position: absolute; top: 15px; right: 15px; color: var(--sub); cursor: pointer; padding: 5px; }
        .p-txt { font-size: 15px; color: var(--text); padding: 0 15px 10px; line-height: 1.4; }
        .p-med { width: 100%; display: block; background: #000; }
        .p-med img, .p-med video { width: 100%; max-height: 600px; object-fit: contain; display: block; }
        .p-med iframe { width: 100%; aspect-ratio: 16/9; border: none; }
        .p-stat { padding: 10px 15px; display: flex; justify-content: space-between; border-bottom: 1px solid var(--border); color: var(--sub); font-size: 13px; }
        .p-act { display: flex; height: 44px; align-items: center; }
        .btn { flex: 1; display: flex; align-items: center; justify-content: center; color: var(--sub); font-weight: 600; font-size: 14px; gap: 6px; cursor: pointer; }
        .btn:active { background: var(--bg); }
        .btn.liked { color: var(--accent); }

        .sheet { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--card); z-index: 2500; border-radius: 15px 15px 0 0; transform: translateY(100%); transition: 0.3s; box-shadow: 0 -5px 20px rgba(0,0,0,0.2); max-height: 80vh; display: flex; flex-direction: column; }
        .sheet.open { transform: translateY(0); }
        .sh-head { padding: 15px; text-align: center; border-bottom: 1px solid var(--border); font-weight: 700; color: var(--text); position: relative; }
        .sh-close { position: absolute; right: 15px; top: 15px; font-size: 20px; cursor: pointer; }
        .sh-body { padding: 15px; overflow-y: auto; }
        .cmt-item { display: flex; gap: 10px; margin-bottom: 15px; }
        .cmt-bub { background: var(--bg); padding: 8px 12px; border-radius: 15px; }
        .cmt-n { font-weight: 700; font-size: 13px; color: var(--text); }
        .cmt-t { font-size: 14px; color: var(--text); }

        #srch-pg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--card); z-index: 2100; display: none; flex-direction: column; }
        .s-bar { padding: 10px 15px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
        .s-inp { flex: 1; background: var(--bg); border: none; padding: 10px 15px; border-radius: 20px; color: var(--text); outline: none; }
        .s-res { flex: 1; padding: 10px; overflow-y: auto; }
        .s-row { display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid var(--border); cursor: pointer; }

        #edit-mod { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--card); z-index: 3000; display: none; flex-direction: column; }
        .em-bod { padding: 20px; overflow-y: auto; }
        .em-inp { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border); background: var(--bg); color: var(--text); border-radius: 6px; }
        .em-btn { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; }

        .pf-head { background: var(--card); text-align: center; padding-bottom: 15px; margin-bottom: 10px; }
        .pf-cvr { width: 100%; height: 200px; object-fit: cover; background: #555; }
        .pf-main { width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--card); margin-top: -60px; background: #ddd; object-fit: cover; position: relative; }
        .pf-nm { font-size: 24px; font-weight: 700; color: var(--text); margin-top: 10px; }
        .pf-bio { color: var(--sub); margin-bottom: 15px; padding: 0 20px; }
        .pf-act { padding: 0 20px; display: flex; gap: 10px; justify-content: center; }
        .pf-btn { flex: 1; padding: 8px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; }
        .btn-p { background: var(--accent); color: white; }
        .btn-s { background: var(--bg); color: var(--text); }

        #menu-pg { position: fixed; top: 0; right: 0; width: 80%; height: 100%; background: var(--card); z-index: 2200; transform: translateX(100%); transition: 0.3s; padding: 20px; box-shadow: -5px 0 20px rgba(0,0,0,0.2); }
        #menu-pg.open { transform: translateX(0); }
        .m-row { display: flex; justify-content: space-between; padding: 15px; border-bottom: 1px solid var(--border); font-weight: 600; cursor: pointer; color: var(--text); }

        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    </style>
</head>
<body>

    <div id="overlay" class="overlay" onclick="closeAll()"></div>
    <div id="loader" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#fff;z-index:9999;display:flex;justify-content:center;align-items:center;flex-direction:column;"><h1 style="color:#1877f2;font-size:40px;">tio</h1><i class="fas fa-spinner fa-spin" style="margin-top:10px;color:#1877f2;font-size:24px;"></i></div>

    <div class="header">
        <div class="logo" onclick="location.reload()">tio</div>
        <div class="h-icons">
            <i class="fas fa-plus" onclick="location.href='post.html'"></i>
            <i class="fas fa-search" onclick="openSearch()"></i>
            <i class="fas fa-bars" onclick="document.getElementById('menu-pg').classList.add('open');document.getElementById('overlay').style.display='block'"></i>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" id="t-home" onclick="nav('home')"><i class="fas fa-home"></i></div>
        <div class="tab" id="t-video" onclick="nav('video')"><i class="fas fa-video"></i></div>
        <div class="tab" id="t-friends" onclick="nav('friends')"><i class="fas fa-user-friends"></i></div>
        <div class="tab" id="t-profile" onclick="nav('profile')"><i class="fas fa-user-circle"></i></div>
    </div>

    <!-- HOME -->
    <div id="p-home" class="section active">
        <div class="create-box">
            <img id="my-pic" class="u-ava">
            <div class="c-in" onclick="location.href='post.html'">What's on your mind?</div>
        </div>

        <div class="story-tray" id="s-tray">
            <div class="story-card s-create" onclick="document.getElementById('s-in').click()">
                <img id="my-s-pic" style="width:100%;height:130px;object-fit:cover;">
                <div class="s-label">Create Story</div>
                <div class="s-plus">+</div>
                <input type="file" id="s-in" hidden accept="image/*" onchange="upStory(this)">
            </div>
        </div>
        <div id="feed"></div>
    </div>

    <!-- VIDEO -->
    <div id="p-video" class="section">
        <div id="v-feed"></div>
    </div>

    <!-- FRIENDS -->
    <div id="p-friends" class="section">
        <div style="padding:15px; font-weight:700;">Friend Requests</div>
        <div id="req-list"></div>
        <div style="padding:15px; font-weight:700; margin-top:10px;">People You May Know</div>
        <div id="sugg-list"></div>
    </div>

    <!-- PROFILE (SELF) -->
    <div id="p-profile" class="section">
        <div class="pf-head">
            <img id="pf-cvr" class="pf-cvr">
            <img id="pf-img" class="pf-main">
            <h1 id="pf-nm" class="pf-nm"></h1>
            <p id="pf-bio" class="pf-bio"></p>
            <div class="pf-act">
                <button class="pf-btn btn-s" onclick="openEdit()">Edit Profile</button>
            </div>
        </div>
        <div id="my-posts"></div>
    </div>

    <!-- VIEW PROFILE (GUEST) -->
    <div id="p-view" class="section">
        <div class="pf-head">
            <i class="fas fa-arrow-left" style="position:absolute;top:65px;left:15px;background:white;padding:8px;border-radius:50%;cursor:pointer;color:black;" onclick="nav('home')"></i>
            <img id="vp-cvr" class="pf-cvr">
            <img id="vp-img" class="pf-main">
            <h1 id="vp-nm" class="pf-nm"></h1>
            <p id="vp-bio" class="pf-bio"></p>
            <div class="pf-act">
                <button id="vp-btn" class="pf-btn btn-p" onclick="frAct()">Add Friend</button>
            </div>
        </div>
        <div id="vp-posts"></div>
    </div>

    <!-- MODALS -->
    <div id="menu-pg">
        <div class="m-row" onclick="togDark()">Dark Mode <i class="fas fa-moon"></i></div>
        <div class="m-row" onclick="logout()" style="color:red">Log Out <i class="fas fa-sign-out-alt"></i></div>
    </div>

    <div id="srch-pg">
        <div class="s-bar"><i class="fas fa-arrow-left" onclick="closeAll()"></i><input class="s-inp" placeholder="Search..." onkeyup="doSrch(this.value)"></div>
        <div id="s-out" class="s-res"></div>
    </div>

    <div id="edit-mod">
        <div style="padding:15px; border-bottom:1px solid #ddd; display:flex; justify-content:space-between; align-items:center;">
            <h3>Edit Profile</h3> <i class="fas fa-times" onclick="closeAll()"></i>
        </div>
        <div class="em-bod">
            <label>Profile Picture</label>
            <input type="file" id="e-pp" class="em-inp">
            <label>Cover Photo</label>
            <input type="file" id="e-cp" class="em-inp">
            <label>Full Name</label>
            <input id="e-nm" class="em-inp" type="text">
            <label>Bio</label>
            <input id="e-bio" class="em-inp" type="text">
            <button class="em-btn" onclick="savePf()">Save Changes</button>
        </div>
    </div>

    <div id="cmt-sht" class="sheet">
        <div class="sh-head">Comments <i class="fas fa-times sh-close" onclick="closeAll()"></i></div>
        <div id="clist" class="sh-body" style="height:300px;"></div>
        <div style="padding:10px; border-top:1px solid #ddd; display:flex; gap:10px;">
            <input id="cin" style="flex:1; padding:10px; border-radius:20px; border:1px solid #ddd;" placeholder="Write a comment...">
            <i class="fas fa-paper-plane" style="color:var(--accent); font-size:24px; padding:8px; cursor:pointer;" onclick="postCmt()"></i>
        </div>
    </div>

    <div id="shr-sht" class="sheet">
        <div class="sh-head">Share <i class="fas fa-times sh-close" onclick="closeAll()"></i></div>
        <div class="sh-body">
            <div class="m-row" onclick="shareFeed()">Share to Feed</div>
            <div class="m-row" onclick="copyL()">Copy Link</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, orderBy, limit, getDocs, updateDoc, arrayUnion, arrayRemove, addDoc, deleteDoc, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const cfg = { apiKey: "AIzaSyD_HBGuQSh_GzqrHqHbgdaoBikLZsK3Qqs", authDomain: "new-all-f99f7.firebaseapp.com", projectId: "new-all-f99f7", storageBucket: "new-all-f99f7.appspot.com", messagingSenderId: "1069748173900", appId: "1:1069748173900:web:158d6336c0f4628133c8e9" };
        const C_URL = "https://api.cloudinary.com/v1_1/dwgvvzbvn/auto/upload";
        const C_PRE = "storyapp";
        
        const app = initializeApp(cfg);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let me = null;
        let actP = null;
        let guestId = null;

        onAuthStateChanged(auth, async (u) => {
            if(u) {
                me = u;
                const d = (await getDoc(doc(db,"users",u.uid))).data();
                document.getElementById('my-pic').src = d.profilePic;
                document.getElementById('my-s-pic').src = d.profilePic;
                document.getElementById('pf-img').src = d.profilePic;
                document.getElementById('pf-cvr').src = d.coverPic;
                document.getElementById('pf-nm').innerText = d.fullName;
                document.getElementById('pf-bio').innerText = d.bio || "";
                loadAll();
                document.getElementById('loader').style.display='none';
            } else location.href="Account.html";
        });

        function loadAll() { loadFeed(); loadSt(); loadReq(); loadSugg(); }

        window.nav = (p) => {
            document.querySelectorAll('.section').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));
            document.getElementById('p-'+p).classList.add('active');
            if(p!=='view') document.getElementById('t-'+p).classList.add('active');
            if(p==='video') loadVid();
            if(p==='profile') loadMyP();
        }

        async function loadFeed() {
            const c = document.getElementById('feed');
            const s = await getDocs(query(collection(db,"posts"), orderBy("timestamp","desc"), limit(20)));
            let h = "";
            s.forEach(d => h+=mkP(d.data(), d.id));
            c.innerHTML = h;
        }

        function mkP(p, id) {
            const lk = p.likes?.includes(me.uid) ? 'liked' : '';
            const del = p.uid === me.uid ? `<i class="fas fa-trash p-del" onclick="delP('${id}')"></i>` : '';
            let m = "";
            if(p.mediaUrl) {
                if(p.type==='video') m = `<div class="p-med"><video src="${p.mediaUrl}" controls></video></div>`;
                else if(p.type==='youtube') m = `<div class="p-med"><iframe src="${p.mediaUrl}" allowfullscreen></iframe></div>`;
                else m = `<div class="p-med"><img src="${p.mediaUrl}"></div>`;
            }
            return `<div class="post">
                ${del}
                <div class="p-head"><img src="${p.userPic}" class="u-ava" onclick="vwProf('${p.uid}')"><div class="p-nm"><h4 onclick="vwProf('${p.uid}')">${p.userName}</h4><span>Just now</span></div></div>
                <div class="p-txt">${p.text}</div>${m}
                <div class="p-stat"><span>${p.likes?.length||0} Likes</span><span>Comments</span></div>
                <div class="p-act">
                    <div class="btn ${lk}" id="l-${id}" onclick="lk('${id}')"><i class="fas fa-thumbs-up"></i> Like</div>
                    <div class="btn" onclick="opCmt('${id}')"><i class="far fa-comment-alt"></i> Comment</div>
                    <div class="btn" onclick="opShr('${id}')"><i class="fas fa-share"></i> Share</div>
                </div>
            </div>`;
        }

        window.delP = async(id) => {
            if(confirm("Delete post?")) {
                await deleteDoc(doc(db,"posts",id));
                loadFeed();
            }
        }

        window.lk = async(id) => {
            const b = document.getElementById(`l-${id}`);
            if(b.classList.contains('liked')) { b.classList.remove('liked'); updateDoc(doc(db,"posts",id),{likes:arrayRemove(me.uid)}); }
            else { b.classList.add('liked'); updateDoc(doc(db,"posts",id),{likes:arrayUnion(me.uid)}); }
        }

        window.opCmt = async(id) => {
            actP = id;
            document.getElementById('overlay').style.display='block';
            document.getElementById('cmt-sht').classList.add('open');
            const c = document.getElementById('clist'); c.innerHTML="Loading...";
            const s = await getDocs(collection(db,"posts",id,"comments"));
            let h = "";
            s.forEach(d=>{ const k=d.data(); h+=`<div class="cmt-item"><img src="${k.uPic}" class="u-ava"><div class="cmt-bub"><div class="cmt-n">${k.uName}</div><div class="cmt-t">${k.txt}</div></div></div>`; });
            c.innerHTML = h||"No comments";
        }

        window.postCmt = async() => {
            const t = document.getElementById('cin').value;
            if(!t) return;
            const u = (await getDoc(doc(db,"users",me.uid))).data();
            await addDoc(collection(db,"posts",actP,"comments"), {uid:me.uid, uName:u.fullName, uPic:u.profilePic, txt:t});
            document.getElementById('cin').value="";
            window.opCmt(actP);
        }

        window.opShr = (id) => { actP=id; document.getElementById('overlay').style.display='block'; document.getElementById('shr-sht').classList.add('open'); }
        window.shareFeed = () => { alert("Shared!"); closeAll(); }
        window.copyL = () => { navigator.clipboard.writeText("tio.app/p/"+actP); alert("Copied"); closeAll(); }

        window.closeAll = () => {
            document.querySelectorAll('.sheet').forEach(e=>e.classList.remove('open'));
            document.querySelectorAll('.overlay').forEach(e=>e.style.display='none');
            document.getElementById('menu-pg').classList.remove('open');
            document.getElementById('srch-pg').style.display='none';
            document.getElementById('edit-mod').style.display='none';
        }

        async function loadSt() {
            const t = document.getElementById('s-tray');
            const s = await getDocs(query(collection(db,"stories"), orderBy("timestamp","desc")));
            while(t.children.length>1) t.removeChild(t.lastChild);
            s.forEach(d => {
                const k = d.data();
                const v = document.createElement('div'); v.className='story-card';
                v.innerHTML = `<img src="${k.url}"><img src="${k.userPic}" class="s-ava"><div class="s-user">${k.userName}</div>`;
                t.appendChild(v);
            });
        }
        window.upStory = async(i) => {
            if(i.files[0]) {
                const fd=new FormData(); fd.append('file',i.files[0]); fd.append('upload_preset',C_PRE);
                const r = await fetch(C_URL,{method:'POST',body:fd}); const d=await r.json();
                const u = (await getDoc(doc(db,"users",me.uid))).data();
                await addDoc(collection(db,"stories"),{uid:me.uid, url:d.secure_url, userName:u.fullName, userPic:u.profilePic, timestamp:new Date().toISOString()});
                loadSt();
            }
        }

        window.openSearch = () => document.getElementById('srch-pg').style.display='flex';
        window.doSrch = async(v) => {
            if(v.length<3) return;
            const r = document.getElementById('s-out');
            const s = await getDocs(query(collection(db,"users"), where("fullName",">=",v), where("fullName","<=",v+"\uf8ff")));
            r.innerHTML="";
            s.forEach(d=>{ const k=d.data(); r.innerHTML+=`<div class="s-row" onclick="vwProf('${k.uid}')"><img src="${k.profilePic}" class="u-ava"><b>${k.fullName}</b></div>`; });
        }

        window.vwProf = async(id) => {
            if(id===me.uid) { nav('profile'); return; }
            guestId = id;
            nav('view');
            const d = (await getDoc(doc(db,"users",id))).data();
            document.getElementById('vp-cvr').src = d.coverPic;
            document.getElementById('vp-img').src = d.profilePic;
            document.getElementById('vp-nm').innerText = d.fullName;
            document.getElementById('vp-bio').innerText = d.bio||"";
            closeAll();
            
            const myD = (await getDoc(doc(db,"users",me.uid))).data();
            const btn = document.getElementById('vp-btn');
            if(myD.friends?.includes(id)) { btn.innerText="Friends"; btn.className="pf-btn btn-s"; }
            else if(d.friendRequests?.includes(me.uid)) { btn.innerText="Sent"; btn.disabled=true; }
            else { btn.innerText="Add Friend"; btn.className="pf-btn btn-p"; btn.disabled=false; }

            const c = document.getElementById('vp-posts');
            const s = await getDocs(query(collection(db,"posts"), orderBy("timestamp","desc")));
            let h = "";
            s.forEach(x => { if(x.data().uid===id) h+=mkP(x.data(), x.id); });
            c.innerHTML = h;
        }

        window.frAct = async() => {
            await updateDoc(doc(db,"users",guestId),{friendRequests:arrayUnion(me.uid)});
            document.getElementById('vp-btn').innerText="Sent";
        }

        window.openEdit = () => {
            document.getElementById('edit-mod').style.display='flex';
            document.getElementById('e-nm').value = document.getElementById('pf-nm').innerText;
            document.getElementById('e-bio').value = document.getElementById('pf-bio').innerText;
        }

        window.savePf = async() => {
            const n = document.getElementById('e-nm').value;
            const b = document.getElementById('e-bio').value;
            const pp = document.getElementById('e-pp').files[0];
            const cp = document.getElementById('e-cp').files[0];
            
            const upD = {fullName:n, bio:b};
            
            if(pp) {
                const fd=new FormData(); fd.append('file',pp); fd.append('upload_preset',C_PRE);
                const r=await fetch(C_URL,{method:'POST',body:fd}); const d=await r.json();
                upD.profilePic = d.secure_url;
            }
            if(cp) {
                const fd=new FormData(); fd.append('file',cp); fd.append('upload_preset',C_PRE);
                const r=await fetch(C_URL,{method:'POST',body:fd}); const d=await r.json();
                upD.coverPic = d.secure_url;
            }

            await updateDoc(doc(db,"users",me.uid), upD);
            location.reload();
        }

        async function loadReq() {
            const c = document.getElementById('req-list');
            const u = (await getDoc(doc(db,"users",me.uid))).data();
            c.innerHTML="";
            u.friendRequests?.forEach(async id => {
                const f = (await getDoc(doc(db,"users",id))).data();
                c.innerHTML+=`<div class="s-row"><img src="${f.profilePic}" class="u-ava"><b>${f.fullName}</b> <button style="margin-left:auto" onclick="acp('${id}')">Confirm</button></div>`;
            });
        }
        window.acp = async(id) => {
            await updateDoc(doc(db,"users",me.uid),{friendRequests:arrayRemove(id),friends:arrayUnion(id)});
            await updateDoc(doc(db,"users",id),{friends:arrayUnion(me.uid)});
            loadReq();
        }

        async function loadSugg() {
            const c = document.getElementById('sugg-list');
            const s = await getDocs(collection(db,"users"));
            const md = (await getDoc(doc(db,"users",me.uid))).data();
            c.innerHTML="";
            s.forEach(d=>{
                const u=d.data();
                if(u.uid!==me.uid && !md.friends?.includes(u.uid)) {
                    c.innerHTML+=`<div class="s-row"><img src="${u.profilePic}" class="u-ava"><b>${u.fullName}</b> <button style="margin-left:auto" onclick="snd('${u.uid}',this)">Add</button></div>`;
                }
            });
        }
        window.snd = async(id,b) => {
            await updateDoc(doc(db,"users",id),{friendRequests:arrayUnion(me.uid)});
            b.innerText="Sent";
        }

        async function loadVid() {
            const c=document.getElementById('v-feed');
            if(c.children.length)return;
            const s=await getDocs(query(collection(db,"posts"),orderBy("timestamp","desc")));
            s.forEach(d=>{ const p=d.data(); if(p.type==='video'||p.type==='youtube') c.innerHTML+=mkP(p,d.id); });
        }

        async function loadMyP() {
            const c=document.getElementById('my-posts');
            const s=await getDocs(query(collection(db,"posts"),orderBy("timestamp","desc")));
            let h=""; s.forEach(d=>{ if(d.data().uid===me.uid) h+=mkP(d.data(),d.id); });
            c.innerHTML=h;
        }

        window.togDark = () => document.body.classList.toggle('dark-mode');
        window.logout = () => signOut(auth);

    </script>
</body>
</html>
