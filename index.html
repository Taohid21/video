<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>tio - Social</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --bg: #f0f2f5;
            --card: #ffffff;
            --text: #050505;
            --text-sec: #65676b;
            --accent: #1877f2;
            --border: #e4e6eb;
            --hover: #f2f2f2;
            --input: #f0f2f5;
            --shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            --story-gradient: linear-gradient(to bottom, rgba(0,0,0,0) 50%, rgba(0,0,0,0.7) 100%);
        }
        body.dark-mode {
            --bg: #18191a;
            --card: #242526;
            --text: #e4e6eb;
            --text-sec: #b0b3b8;
            --accent: #2d88ff;
            --border: #3e4042;
            --hover: #3a3b3c;
            --input: #3a3b3c;
            --shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body { background-color: var(--bg); color: var(--text); padding-top: 100px; padding-bottom: 60px; min-height: 100vh; overflow-x: hidden; transition: background 0.3s, color 0.3s; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; backdrop-filter: blur(5px); opacity: 0; transition: opacity 0.3s; }
        .overlay.active { display: block; opacity: 1; }
        .header { position: fixed; top: 0; left: 0; width: 100%; height: 55px; background: var(--card); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; z-index: 1000; border-bottom: 1px solid var(--border); box-shadow: var(--shadow); }
        .logo { font-size: 30px; font-weight: 800; color: var(--accent); letter-spacing: -1px; cursor: pointer; }
        .h-icons { display: flex; gap: 8px; }
        .h-btn { width: 35px; height: 35px; background: var(--input); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--text); cursor: pointer; transition: 0.2s; font-size: 16px; }
        .h-btn:active { transform: scale(0.95); background: var(--hover); }
        .tabs { position: fixed; top: 55px; left: 0; width: 100%; height: 45px; background: var(--card); display: flex; align-items: center; z-index: 999; border-bottom: 1px solid var(--border); }
        .tab { flex: 1; height: 100%; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; transition: 0.2s; }
        .tab i { font-size: 22px; color: var(--text-sec); }
        .tab.active i { color: var(--accent); }
        .tab.active::after { content: ''; position: absolute; bottom: 0; width: 60%; height: 3px; background: var(--accent); border-radius: 3px 3px 0 0; }
        .section { display: none; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }
        .create-box { background: var(--card); padding: 12px 15px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; box-shadow: var(--shadow); }
        .u-ava { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #555; border: 1px solid var(--border); }
        .c-in { flex: 1; background: var(--input); height: 40px; border-radius: 20px; padding: 0 15px; display: flex; align-items: center; color: var(--text-sec); cursor: pointer; transition: 0.2s; font-size: 15px; justify-content: space-between; }
        .c-in:active { background: var(--hover); }
        .plus-icon-box { width: 32px; height: 32px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; margin-left: 5px; font-size: 14px; }
        .story-tray { background: var(--card); padding: 15px 12px; margin-bottom: 10px; overflow-x: auto; display: flex; gap: 8px; scrollbar-width: none; box-shadow: var(--shadow); }
        /* min-width ‡¶ï‡¶Æ‡¶ø‡ßü‡ßá ‡¶è‡¶¨‡¶Ç width ‡¶´‡¶ø‡¶ï‡ßç‡¶∏ ‡¶ï‡¶∞‡ßá ‡¶ö‡¶ø‡¶ï‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá */
        .story-card { width: 100px; min-width: 100px; height: 170px; border-radius: 12px; position: relative; overflow: hidden; background: #333; flex-shrink: 0; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.2s; }
        .story-card:active { transform: scale(0.96); }
        .story-img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; }
        .story-card:hover .story-img { transform: scale(1.05); }
        .story-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: var(--story-gradient); pointer-events: none; }
        .s-ava { position: absolute; top: 10px; left: 10px; width: 36px; height: 36px; border-radius: 50%; border: 3px solid var(--accent); object-fit: cover; z-index: 2; background: var(--card); }
        .s-user { position: absolute; bottom: 8px; left: 8px; right: 8px; color: white; font-weight: 600; font-size: 12px; z-index: 2; line-height: 1.2; text-shadow: 0 1px 2px rgba(0,0,0,0.8); pointer-events: none;}
        .s-create .s-plus { position: absolute; bottom: 35px; left: 50%; transform: translateX(-50%); background: var(--accent); color: white; width: 32px; height: 32px; border-radius: 50%; border: 3px solid var(--card); display: flex; align-items: center; justify-content: center; font-size: 18px; z-index: 5; }
        .s-create .s-label { position: absolute; bottom: 0; width: 100%; background: var(--card); height: 50px; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 8px; color: var(--text); font-weight: 600; font-size: 13px; z-index: 4; }
        .post { background: var(--card); margin-bottom: 10px; width: 100%; box-shadow: var(--shadow); }
        .p-head { padding: 12px 15px; display: flex; align-items: center; gap: 10px; position: relative; }
        .p-nm h4 { font-size: 15px; font-weight: 600; color: var(--text); cursor: pointer; }
        .p-nm span { font-size: 12px; color: var(--text-sec); display: block; margin-top: 2px; }
        .p-del { position: absolute; right: 15px; color: var(--text-sec); cursor: pointer; padding: 8px; font-size: 14px; }
        .p-txt { font-size: 15px; color: var(--text); padding: 0 15px 12px; line-height: 1.4; word-wrap: break-word; user-select: text; }
        .p-med { width: 100%; background: #000; display: flex; justify-content: center; align-items: center; max-height: 600px; overflow: hidden; }
        .p-med img, .p-med video { width: 100%; max-height: 600px; object-fit: contain; }
        .p-med iframe { width: 100%; aspect-ratio: 16/9; border: none; }
        .p-stat { padding: 10px 15px; display: flex; justify-content: space-between; border-bottom: 1px solid var(--border); color: var(--text-sec); font-size: 13px; }
        .p-stat i { color: var(--accent); margin-right: 4px; }
        .p-act { display: flex; height: 44px; align-items: center; padding: 0 5px; }
        .btn { flex: 1; display: flex; align-items: center; justify-content: center; color: var(--text-sec); font-weight: 600; font-size: 14px; gap: 6px; cursor: pointer; height: 36px; border-radius: 4px; transition: 0.2s; margin: 0 2px; }
        .btn:active { background: var(--hover); transform: scale(0.97); }
        .btn.liked { color: var(--accent); }
        .btn i { font-size: 18px; }
        .sugg-container { padding: 15px; background: var(--card); margin-bottom: 10px; box-shadow: var(--shadow); }
        .sec-title { font-weight: 700; color: var(--text); margin-bottom: 10px; font-size: 16px; }
        .h-scroll { display: flex; overflow-x: auto; gap: 10px; scrollbar-width: none; padding-bottom: 5px; }
        .fr-card { min-width: 140px; background: var(--bg); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; display: flex; flex-direction: column; align-items: center; padding-bottom: 10px; }
        .fr-img { width: 100%; height: 140px; object-fit: cover; }
        .fr-name { font-weight: 600; font-size: 14px; margin: 8px 5px 5px; text-align: center; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 90%; }
        .fr-btn { background: var(--accent); color: white; border: none; padding: 6px 15px; border-radius: 6px; font-weight: 600; font-size: 13px; cursor: pointer; margin-top: auto; }
        .sheet { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--card); z-index: 2500; border-radius: 15px 15px 0 0; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.1, 0.7, 0.1, 1); box-shadow: 0 -5px 20px rgba(0,0,0,0.2); height: 75vh; max-height: 90vh; display: flex; flex-direction: column; }
        .sheet.open { transform: translateY(0); }
        .sh-drag { width: 40px; height: 4px; background: var(--text-sec); border-radius: 2px; margin: 10px auto; opacity: 0.3; }
        .sh-head { padding: 10px 15px; text-align: center; border-bottom: 1px solid var(--border); font-weight: 700; color: var(--text); font-size: 16px; position: relative; }
        .sh-close { position: absolute; right: 15px; top: 10px; font-size: 20px; color: var(--text-sec); padding: 5px; cursor: pointer; }
        .sh-body { flex: 1; overflow-y: auto; padding: 15px; }
        .cmt-item { display: flex; gap: 10px; margin-bottom: 15px; }
        .cmt-bub { background: var(--input); padding: 10px 14px; border-radius: 18px; position: relative; max-width: 85%; }
        .cmt-n { font-weight: 700; font-size: 13px; color: var(--text); margin-bottom: 2px; }
        .cmt-t { font-size: 14px; color: var(--text); }
        .cmt-in-box { padding: 15px; border-top: 1px solid var(--border); display: flex; gap: 10px; align-items: flex-end; background: var(--card); }
        .cmt-in { flex: 1; background: var(--input); border: none; padding: 12px 15px; border-radius: 24px; color: var(--text); outline: none; transition: 0.2s; min-height: 48px; font-size: 15px; }
        .cmt-in:focus { background: var(--hover); }
        .cmt-send { color: var(--accent); font-size: 22px; padding: 10px; cursor: pointer; margin-bottom: 2px; }
        .pf-head { background: var(--card); text-align: center; padding-bottom: 20px; margin-bottom: 10px; border-bottom: 1px solid var(--border); }
        .pf-cvr-wrap { position: relative; width: 100%; height: 200px; }
        .pf-cvr { width: 100%; height: 100%; object-fit: cover; background: #333; }
        .pf-main { width: 130px; height: 130px; border-radius: 50%; border: 4px solid var(--card); margin-top: -65px; background: var(--input); object-fit: cover; position: relative; z-index: 2; }
        .pf-nm { font-size: 26px; font-weight: 700; color: var(--text); margin-top: 10px; }
        .pf-bio { color: var(--text-sec); margin-bottom: 15px; padding: 0 20px; font-size: 15px; }
        .pf-act { padding: 0 20px; display: flex; gap: 10px; justify-content: center; }
        .pf-btn { flex: 1; padding: 10px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; font-size: 15px; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-p { background: var(--accent); color: white; }
        .btn-s { background: var(--input); color: var(--text); }
        .btn-s:active { background: var(--hover); }
        #menu-pg { position: fixed; top: 0; right: 0; width: 280px; height: 100%; background: var(--card); z-index: 2200; transform: translateX(100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: -5px 0 20px rgba(0,0,0,0.2); padding-top: 20px; }
        #menu-pg.open { transform: translateX(0); }
        .m-head { padding: 0 20px 20px; font-size: 24px; font-weight: 800; color: var(--text); border-bottom: 1px solid var(--border); }
        .m-row { display: flex; align-items: center; justify-content: space-between; padding: 15px 20px; border-bottom: 1px solid var(--border); font-weight: 600; cursor: pointer; color: var(--text); font-size: 16px; transition: 0.2s; }
        .m-row:active { background: var(--hover); }
        #srch-pg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--card); z-index: 2100; display: none; flex-direction: column; }
        .s-bar { padding: 10px 15px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; height: 60px; }
        .s-inp { flex: 1; background: var(--input); border: none; padding: 10px 15px; border-radius: 20px; color: var(--text); outline: none; }
        .s-res { flex: 1; padding: 10px; overflow-y: auto; }
        .s-row { display: flex; align-items: center; gap: 12px; padding: 10px; border-radius: 8px; cursor: pointer; margin-bottom: 5px; }
        .s-row:active { background: var(--hover); }
        #edit-mod { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--card); z-index: 3000; display: none; flex-direction: column; }
        .em-bod { padding: 20px; overflow-y: auto; }
        .em-grp { margin-bottom: 20px; position: relative; }
        .em-lbl { font-weight: 600; font-size: 14px; color: var(--text); margin-bottom: 8px; display: block; }
        .em-inp { width: 100%; padding: 12px; border: 1px solid var(--border); background: var(--input); color: var(--text); border-radius: 8px; }
        .em-btn { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px; margin-top: 10px; }
        .img-edit-ov { position: absolute; right: 10px; bottom: 10px; background: var(--card); width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow); cursor: pointer; }
        /* Story Editor High Level Design */
        #story-editor { position: fixed; top:0; left:0; width:100%; height:100%; background: #000; z-index: 4000; display:none; flex-direction: column; }
        .se-prev { flex:1; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; background: #111; }
        .se-img { width: 100%; height: 100%; object-fit: contain; }
        
        .se-top-bar { position: absolute; top: 10px; left: 0; width: 100%; padding: 10px 15px; z-index: 20; display: flex; justify-content: space-between; pointer-events: none; }
        .se-icon-close { pointer-events: auto; width: 40px; height: 40px; background: rgba(0,0,0,0.5); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; backdrop-filter: blur(4px); }

        .se-sidebar { position: absolute; top: 60px; right: 15px; display: flex; flex-direction: column; gap: 20px; z-index: 25; pointer-events: auto; }
        .se-tool { display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; }
        .se-tool i { width: 45px; height: 45px; background: rgba(0,0,0,0.6); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; backdrop-filter: blur(5px); box-shadow: 0 2px 5px rgba(0,0,0,0.3); transition: 0.2s; }
        .se-tool span { color: white; font-size: 11px; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }
        .se-tool:active i { transform: scale(0.9); background: var(--accent); }

        .se-float-inp { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); width: 85%; z-index: 30; display: none; }
        .se-float-inp.show { display: block; }
        #se-caption { width: 100%; background: rgba(0,0,0,0.6); border: none; color: white; padding: 15px; border-radius: 12px; font-size: 20px; text-align: center; backdrop-filter: blur(10px); outline: none; font-weight: 600; }
        
        .se-txt { position: absolute; color: white; font-weight: 800; font-size: 28px; text-shadow: 0 2px 8px rgba(0,0,0,0.8); cursor: move; width: 100%; text-align: center; top: 50%; left: 0; padding: 10px; pointer-events: auto; user-select: none; }

        .se-bottom-bar { position: absolute; bottom: 0; left: 0; width: 100%; padding: 20px; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); display: flex; justify-content: space-between; align-items: center; z-index: 20; }
        .se-user-info { display: flex; align-items: center; gap: 8px; color: white; font-weight: 600; font-size: 14px; opacity: 0.9; }
        .se-share-btn { background: var(--accent); color: white; border: none; padding: 12px 25px; border-radius: 30px; font-weight: 700; font-size: 16px; cursor: pointer; box-shadow: 0 4px 15px rgba(24, 119, 242, 0.4); display: flex; align-items: center; gap: 8px; transition: 0.2s; pointer-events: auto; }
        .se-share-btn:active { transform: scale(0.95); }

        .tag-btn { background: var(--input); padding: 8px 14px; border-radius: 20px; font-size: 13px; font-weight: 600; white-space: nowrap; cursor: pointer; border: 1px solid var(--border); transition: 0.2s; }
        .tag-btn:active { background: var(--accent); color: white; border-color: var(--accent); }
        
        .m-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; transition: 0.2s; }
        .m-item:active { background: var(--hover); }
        .m-thumb { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; background: #333; }
        .m-info { flex: 1; }
        .m-title { font-weight: 700; font-size: 15px; color: var(--text); margin-bottom: 3px; }
        .m-artist { font-size: 13px; color: var(--text-sec); }
        #story-viewer { position: fixed; top:0; left:0; width:100%; height:100%; background: black; z-index: 5000; display: none; flex-direction: column; }
        .sv-progress { height: 4px; background: rgba(255,255,255,0.3); margin: 10px 10px 0; border-radius: 2px; overflow: hidden; }
        .sv-bar { height: 100%; background: white; width: 0%; transition: width 0.1s linear; }
        .sv-head { display: flex; align-items: center; padding: 15px; gap: 10px; color: white; z-index: 10; }
        .sv-body { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .sv-img { width: 100%; height: 100%; object-fit: contain; }
        .sv-txt { position: absolute; width: 100%; text-align: center; color: white; font-weight: 700; font-size: 24px; text-shadow: 0 2px 4px rgba(0,0,0,0.8); pointer-events: none; }
        .sv-footer { padding: 15px; display: flex; gap: 15px; justify-content: center; align-items: center; padding-bottom: 30px; z-index: 10; }
        .sv-react { font-size: 35px; transition: 0.2s; cursor: pointer; }
        .sv-react:active { transform: scale(1.3); }
        .flying-emoji { position: absolute; bottom: 80px; font-size: 40px; animation: flyUp 1.5s ease-out forwards; pointer-events: none; z-index: 100; left: 50%; }
        @keyframes flyUp { 0% { transform: translate(-50%, 0) scale(0.5); opacity: 0; } 20% { opacity: 1; transform: translate(-50%, -50px) scale(1.2); } 100% { transform: translate(-50%, -300px) scale(1); opacity: 0; } }
        @keyframes fadeIn { from{opacity:0; transform: translateY(10px);} to{opacity:1; transform: translateY(0);} }
        #loader { position:fixed;top:0;left:0;width:100%;height:100%;background:var(--bg);z-index:9999;display:flex;justify-content:center;align-items:center;flex-direction:column; transition: 0.3s; }
        .share-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 20px 10px; }
        .sh-icon { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; }
        .si-box { width: 50px; height: 50px; border-radius: 50%; background: var(--input); display: flex; align-items: center; justify-content: center; font-size: 20px; color: var(--text); transition: 0.2s; }
        .si-box:active { background: var(--hover); transform: scale(0.95); }
        .si-lbl { font-size: 12px; color: var(--text-sec); text-align: center; }
/* ‡¶Æ‡¶ø‡¶â‡¶ú‡¶ø‡¶ï ‡¶∂‡ßÄ‡¶ü ‡¶∏‡¶¨‡¶æ‡¶∞ ‡¶â‡¶™‡¶∞‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø */
#music-modal { z-index: 4500 !important; }

/* ‡¶™‡ßç‡¶≤‡ßá ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶¨‡¶æ‡¶ü‡¶® ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
.m-act-box { display: flex; align-items: center; gap: 15px; }
.m-play-btn { font-size: 30px; color: var(--accent); cursor: pointer; padding: 5px; transition: 0.2s; }
.m-play-btn:active { transform: scale(0.9); }
.m-sel-btn { background: var(--input); color: var(--text); border: 1px solid var(--border); padding: 8px 16px; border-radius: 20px; font-weight: 600; cursor: pointer; font-size: 13px; }
.m-sel-btn:active { background: var(--accent); color: white; border-color: var(--accent); }
    </style>
</head>
<body class="dark-mode"> 

    <div id="loader">
        <h1 style="color:var(--accent);font-size:45px;font-weight:800;letter-spacing:-2px;margin-bottom:15px;">tio</h1>
        <i class="fas fa-circle-notch fa-spin" style="color:var(--accent);font-size:30px;"></i>
    </div>

    <div id="overlay" class="overlay" onclick="closeAll()"></div>

    <div class="header">
        <div class="logo" onclick="nav('home')">tio</div>
        <div class="h-icons">
    <div class="h-btn" onclick="openSearch()"><i class="fas fa-search"></i></div>
    <div class="h-btn" onclick="location.href='chat.html'"><i class="fab fa-facebook-messenger"></i></div>
    <div class="h-btn" onclick="openMenu()"><i class="fas fa-bars"></i></div>
</div>
    </div>

    <div class="tabs">
        <div class="tab active" id="t-home" onclick="nav('home')"><i class="fas fa-house"></i></div>
        <div class="tab" id="t-video" onclick="nav('video')"><i class="fas fa-play-circle"></i></div>
        <div class="tab" id="t-friends" onclick="nav('friends')"><i class="fas fa-user-group"></i></div>
        <div class="tab" id="t-profile" onclick="nav('profile')"><i class="fas fa-user-circle"></i></div>
    </div>

    <div id="p-home" class="section active">
        <div class="create-box">
            <img id="my-pic" class="u-ava">
            <div class="c-in" onclick="location.href='post.html'">
                <span>What's on your mind?</span>
                <div class="plus-icon-box"><i class="fas fa-plus"></i></div>
            </div>
        </div>

        <div class="story-tray" id="s-tray">
            <div class="story-card s-create" onclick="document.getElementById('s-in').click()">
                <img id="my-s-pic" class="story-img" style="filter: brightness(0.6);">
                <div class="story-overlay"></div>
                <div class="s-plus"><i class="fas fa-plus"></i></div>
                <div class="s-label">Create Story</div>
                <input type="file" id="s-in" hidden accept="image/*" onchange="openStoryEditor(this)">
            </div>
        </div>

        <div id="feed"></div>
    </div>

    <div id="p-video" class="section">
        <div id="v-feed"></div>
    </div>

    <div id="p-friends" class="section">
        <div class="sugg-container" id="req-cont" style="display:none">
            <div class="sec-title">Friend Requests <span id="req-cnt" style="color:var(--accent); margin-left:5px;"></span></div>
            <div id="req-list"></div>
        </div>
        <div class="sugg-container">
            <div class="sec-title">People You May Know</div>
            <div class="h-scroll" id="sugg-list"></div>
        </div>
    </div>

    <div id="p-profile" class="section">
        <div class="pf-head">
            <div class="pf-cvr-wrap"><img id="pf-cvr" class="pf-cvr"></div>
            <img id="pf-img" class="pf-main">
            <h1 id="pf-nm" class="pf-nm">Loading...</h1>
            <p id="pf-bio" class="pf-bio"></p>
            <div class="pf-act">
                <button class="pf-btn btn-s" onclick="openEdit()"><i class="fas fa-pen"></i> Edit Profile</button>
                <button class="pf-btn btn-s" onclick="logout()" style="flex:0.3; background: #ffebee; color:#d32f2f;"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
        <div id="my-posts"></div>
    </div>

    <div id="p-view" class="section">
        <div class="pf-head">
            <i class="fas fa-arrow-left" style="position:absolute;top:70px;left:15px;background:var(--card);padding:10px;border-radius:50%;cursor:pointer;color:var(--text);box-shadow:var(--shadow);z-index:5;" onclick="nav('home')"></i>
            <div class="pf-cvr-wrap"><img id="vp-cvr" class="pf-cvr"></div>
            <img id="vp-img" class="pf-main">
            <h1 id="vp-nm" class="pf-nm"></h1>
            <p id="vp-bio" class="pf-bio"></p>
            <div class="pf-act">
                <button id="vp-btn" class="pf-btn btn-p" onclick="frAct()">Add Friend</button>
                <button class="pf-btn btn-s"><i class="fab fa-facebook-messenger"></i> Message</button>
            </div>
        </div>
        <div id="vp-posts"></div>
    </div>

    <div id="menu-pg">
        <div class="m-head">Menu</div>
        <div class="m-row" onclick="togDark()"><span>Dark Mode</span><i class="fas fa-moon" id="dk-icn"></i></div>
        <div class="m-row" onclick="nav('profile'); closeAll()"><span>My Profile</span><i class="fas fa-user"></i></div>
        <div class="m-row" onclick="logout()" style="color:#ef5350"><span>Log Out</span><i class="fas fa-sign-out-alt"></i></div>
    </div>

    <div id="srch-pg">
        <div class="s-bar">
            <i class="fas fa-arrow-left" style="font-size:20px; color:var(--text-sec); padding:10px;" onclick="closeAll()"></i>
            <input class="s-inp" id="s-input-box" placeholder="Search people..." onkeyup="doSrch(this.value)">
        </div>
        <div id="s-out" class="s-res"></div>
    </div>

    <div id="edit-mod">
        <div style="padding:15px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
            <h3 style="font-size:18px;">Edit Profile</h3> 
            <i class="fas fa-times" onclick="closeAll()" style="font-size:20px; padding:5px; cursor:pointer;"></i>
        </div>
        <div class="em-bod">
            <div class="em-grp">
                <label class="em-lbl">Profile Picture</label>
                <div style="text-align:center; position:relative; width:100px; margin:0 auto;">
                    <img id="e-prev-pp" style="width:100px; height:100px; border-radius:50%; object-fit:cover; border:1px solid var(--border);">
                    <label for="e-pp" class="img-edit-ov"><i class="fas fa-camera"></i></label>
                </div>
                <input type="file" id="e-pp" hidden accept="image/*" onchange="prevImg(this, 'e-prev-pp')">
            </div>
            <div class="em-grp">
                <label class="em-lbl">Cover Photo</label>
                <div style="position:relative;">
                    <img id="e-prev-cp" style="width:100%; height:120px; object-fit:cover; border-radius:8px; border:1px solid var(--border);">
                    <label for="e-cp" class="img-edit-ov" style="bottom:5px; right:5px;"><i class="fas fa-camera"></i></label>
                </div>
                <input type="file" id="e-cp" hidden accept="image/*" onchange="prevImg(this, 'e-prev-cp')">
            </div>
            <div class="em-grp"><label class="em-lbl">Full Name</label><input id="e-nm" class="em-inp" type="text"></div>
            <div class="em-grp"><label class="em-lbl">Bio</label><input id="e-bio" class="em-inp" type="text"></div>
            <button class="em-btn" onclick="savePf()" id="sv-btn">Save Changes</button>
        </div>
    </div>

    <!-- ‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø ‡¶è‡¶°‡¶ø‡¶ü‡¶∞ -->
    <div id="story-editor">
        <div class="se-top-bar">
            <div class="se-icon-close" onclick="closeStoryEditor()"><i class="fas fa-times"></i></div>
        </div>
        
        <div class="se-prev">
            <img id="se-prev-img" class="se-img">
            <div id="se-drag-txt" class="se-txt" ontouchstart="dragStart(event)" ontouchmove="dragMove(event)"></div>
        </div>

        <!-- ‡¶°‡¶æ‡¶®‡¶™‡¶æ‡¶∂‡ßá‡¶∞ ‡¶ü‡ßÅ‡¶≤‡¶¨‡¶æ‡¶∞ -->
        <div class="se-sidebar">
            <div class="se-tool" onclick="document.getElementById('se-caption-box').classList.toggle('show'); document.getElementById('se-caption').focus();">
                <i class="fas fa-font"></i>
                <span>Text</span>
            </div>
            <div class="se-tool" onclick="openMusicModal()">
                <i class="fas fa-music"></i>
                <span id="music-tool-lbl">Music</span>
            </div>
        </div>

        <!-- ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶á‡¶®‡¶™‡ßÅ‡¶ü -->
        <div id="se-caption-box" class="se-float-inp">
            <input id="se-caption" placeholder="Type caption..." oninput="updateSeText(this.value)">
        </div>

        <div class="se-bottom-bar">
            <div class="se-user-info">
                <img id="se-my-pic" class="u-ava" style="width:30px;height:30px;border:none;">
                <span>Your Story</span>
            </div>
            <button class="se-share-btn" onclick="uploadStory()" id="st-up-btn">
                Share <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- ‡¶®‡¶§‡ßÅ‡¶® ‡¶Æ‡¶ø‡¶â‡¶ú‡¶ø‡¶ï ‡¶∂‡ßÄ‡¶ü -->
    <div id="music-modal" class="sheet">
        <div class="sh-drag"></div>
        <div class="sh-head">Add Music <i class="fas fa-times sh-close" onclick="document.getElementById('music-modal').classList.remove('open'); document.getElementById('m-preview-player').pause();"></i></div>
        
        <!-- ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶è‡¶¨‡¶Ç ‡¶ü‡ßç‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç ‡¶¨‡¶æ‡¶ü‡¶® -->
        <div style="padding:10px 15px; display:flex; gap:10px; flex-direction:column;">
            <input id="m-search" class="s-inp" placeholder="Search song or artist..." onkeyup="searchMusic(this.value)" style="background:var(--input); border:none; padding:12px; border-radius:12px;">
            <div style="display:flex; gap:8px; overflow-x:auto; padding-bottom:5px; scrollbar-width:none;">
                <span class="tag-btn" onclick="searchMusic('Tanveer Evan')">üé§ Tanveer Evan</span>
                <span class="tag-btn" onclick="searchMusic('Bangla New Song')">üî• Trending BD</span>
                <span class="tag-btn" onclick="searchMusic('Hindi Trending')">‚ù§Ô∏è Hindi Hits</span>
                <span class="tag-btn" onclick="searchMusic('English Pop')">üåç Global</span>
            </div>
        </div>

        <div id="m-list" class="sh-body" style="padding-top:0;"></div>
        <audio id="m-preview-player" hidden></audio>
    </div>

    <!-- Story Viewer (‡¶è‡¶ü‡¶ø ‡¶Æ‡¶ø‡¶∏‡¶ø‡¶Ç ‡¶õ‡¶ø‡¶≤) -->
    <div id="story-viewer">
        <div class="sv-progress"><div id="sv-bar" class="sv-bar"></div></div>
        <div class="sv-head">
            <img id="sv-ava" class="u-ava" style="border:none;">
            <div style="font-weight:600;" id="sv-name"></div>
            <i class="fas fa-times" style="margin-left:auto; font-size:22px; cursor:pointer;" onclick="closeStoryView()"></i>
        </div>
        <div class="sv-body" onclick="nextStoryStep()">
            <img id="sv-main-img" class="sv-img">
            <div id="sv-caption" class="sv-txt"></div>
        </div>
        <div class="sv-footer">
            <div class="sv-react" onclick="sendReact('‚ù§Ô∏è')">‚ù§Ô∏è</div>
            <div class="sv-react" onclick="sendReact('üòÇ')">üòÇ</div>
            <div class="sv-react" onclick="sendReact('üòÆ')">üòÆ</div>
            <div class="sv-react" onclick="sendReact('üò¢')">üò¢</div>
            <div class="sv-react" onclick="sendReact('üò°')">üò°</div>
            <div class="sv-react" onclick="sendReact('üëç')">üëç</div>
        </div>
    </div>

    <div id="cmt-sht" class="sheet">
        <div class="sh-drag"></div>
        <div class="sh-head">Comments <i class="fas fa-times sh-close" onclick="closeAll()"></i></div>
        <div id="clist" class="sh-body"></div>
        <div class="cmt-in-box">
            <img id="cmt-my-pic" class="u-ava" style="width:38px;height:38px;margin-bottom:5px;">
            <input id="cin" class="cmt-in" placeholder="Write a comment...">
            <i class="fas fa-paper-plane cmt-send" onclick="postCmt()"></i>
        </div>
    </div>

    <div id="shr-sht" class="sheet">
        <div class="sh-drag"></div>
        <div class="sh-head">Share</div>
        <div class="share-grid">
            <div class="sh-icon" onclick="shareFeed()"><div class="si-box"><i class="fas fa-rss"></i></div><span class="si-lbl">Feed</span></div>
            <div class="sh-icon" onclick="copyL()"><div class="si-box"><i class="fas fa-link"></i></div><span class="si-lbl">Copy Link</span></div>
            <div class="sh-icon"><div class="si-box"><i class="fab fa-whatsapp"></i></div><span class="si-lbl">WhatsApp</span></div>
            <div class="sh-icon"><div class="si-box"><i class="fab fa-facebook-messenger"></i></div><span class="si-lbl">Messenger</span></div>
        </div>
        <button onclick="closeAll()" style="width:90%; margin:0 auto 20px; padding:12px; border:none; background:var(--input); color:var(--text); font-weight:600; border-radius:8px;">Cancel</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, orderBy, limit, getDocs, updateDoc, arrayUnion, arrayRemove, addDoc, deleteDoc, where, onSnapshot, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const cfg = { apiKey: "AIzaSyD_HBGuQSh_GzqrHqHbgdaoBikLZsK3Qqs", authDomain: "new-all-f99f7.firebaseapp.com", projectId: "new-all-f99f7", storageBucket: "new-all-f99f7.appspot.com", messagingSenderId: "1069748173900", appId: "1:1069748173900:web:158d6336c0f4628133c8e9" };
        
        const C_URL = "https://api.cloudinary.com/v1_1/dwgvvzbvn/auto/upload";
        const C_PRE = "storyapp";
        
        const app = initializeApp(cfg);
        const auth = getAuth(app);
        const db = getFirestore(app);
// --- ‡¶è‡¶ñ‡¶æ‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡¶™‡¶ø ‡¶∂‡ßÅ‡¶∞‡ßÅ ---
// ‡ßß. ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï ‡¶¨‡¶æ‡¶ü‡¶® ‡¶≤‡¶ú‡¶ø‡¶ï
window.history.pushState({modal: null}, '', '');

window.onpopstate = (event) => {
    // ‡¶∏‡¶¨ ‡¶Æ‡¶°‡¶æ‡¶≤ ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ï‡ßã‡¶°
    document.querySelectorAll('.sheet').forEach(e => e.classList.remove('open'));
    document.getElementById('overlay').classList.remove('active');
    document.getElementById('menu-pg').classList.remove('open');
    document.getElementById('srch-pg').style.display='none';
    document.getElementById('edit-mod').style.display='none';
    document.getElementById('story-editor').style.display='none';
    document.getElementById('story-viewer').style.display='none';
    
    // ‡¶Ö‡¶°‡¶ø‡¶ì ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶æ
    if(typeof storyAudio !== 'undefined') { storyAudio.pause(); storyAudio.currentTime = 0; }
    if(typeof previewAudio !== 'undefined') { previewAudio.pause(); }
    if(typeof activeStoryTimer !== 'undefined') clearTimeout(activeStoryTimer);
};
// --- ‡¶ï‡¶™‡¶ø ‡¶∂‡ßá‡¶∑ ---
        
        let me = null;
        let actP = null;
        let guestId = null;
        let storyFile = null;
        let storyYPos = 50;
        let activeStoryTimer = null;
        let selectedMusic = null; // ‡¶Æ‡¶ø‡¶â‡¶ú‡¶ø‡¶ï ‡¶≠‡ßá‡¶∞‡¶ø‡ßü‡ßá‡¶¨‡¶≤

        const initTheme = () => {
            const t = localStorage.getItem('theme');
            if(t === 'light') {
                document.body.classList.remove('dark-mode');
                document.getElementById('dk-icn').className = 'fas fa-sun';
            } else {
                document.body.classList.add('dark-mode');
                document.getElementById('dk-icn').className = 'fas fa-moon';
            }
        };
        initTheme();

        window.togDark = () => {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('dk-icn').className = isDark ? 'fas fa-moon' : 'fas fa-sun';
        };

        onAuthStateChanged(auth, async (u) => {
            if(u) {
                me = u;
                const d = (await getDoc(doc(db,"users",u.uid))).data();
                document.getElementById('my-pic').src = d.profilePic;
                document.getElementById('my-s-pic').src = d.profilePic;
                document.getElementById('cmt-my-pic').src = d.profilePic;
                document.getElementById('pf-img').src = d.profilePic;
                document.getElementById('pf-cvr').src = d.coverPic || '';
                document.getElementById('pf-nm').innerText = d.fullName;
                document.getElementById('pf-bio').innerText = d.bio || "";
                loadAll();
                setTimeout(() => document.getElementById('loader').style.display='none', 500);
            } else {
                location.href="Account.html";
            }
        });

        function loadAll() { loadFeed(); loadSt(); loadReq(); loadSugg(); }

        window.nav = (p) => {
            document.querySelectorAll('.section').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
            document.getElementById('p-'+p).classList.add('active');
            if(p !== 'view') document.getElementById('t-'+p).classList.add('active');
            window.scrollTo(0,0);
            if(p === 'video') loadVid();
            if(p === 'profile') loadMyP();
        }

        async function loadFeed() {
            const c = document.getElementById('feed');
            const s = await getDocs(query(collection(db,"posts"), orderBy("timestamp","desc"), limit(20)));
            let h = "";
            s.forEach(d => h += mkP(d.data(), d.id));
            c.innerHTML = h;
            
            // ‡¶®‡¶§‡ßÅ‡¶®: ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶Ö‡¶ü‡ßã ‡¶™‡¶ú ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ‡¶ï‡¶≤
            initHomeVideoObserver();
        }

        // ‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®: ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶≤ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶™‡¶ú ‡¶π‡¶¨‡ßá
        function initHomeVideoObserver() {
            const videos = document.querySelectorAll('#feed video');
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (!entry.isIntersecting) {
                        entry.target.pause(); // ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡ßá‡¶∞ ‡¶¨‡¶æ‡¶á‡¶∞‡ßá ‡¶ó‡ßá‡¶≤‡ßá ‡¶™‡¶ú
                    }
                });
            }, { threshold: 0.5 });
            videos.forEach(v => observer.observe(v));
        }

        function mkP(p, id) {
            const isLiked = p.likes?.includes(me.uid);
            const lkCls = isLiked ? 'liked' : '';
            const lkCnt = p.likes?.length || 0;
            const del = p.uid === me.uid ? `<i class="fas fa-trash p-del" onclick="delP('${id}')"></i>` : '';
            
            // --- ‡¶®‡¶§‡ßÅ‡¶®: ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á‡¶° ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ú ‡¶≤‡¶ú‡¶ø‡¶ï ---
            const badge = p.isVerified ? `<i class="fas fa-check-circle" style="color:#1877f2;font-size:14px;margin-left:4px;" title="Verified"></i>` : '';
            // --------------------------------

            let m = "";
            let txtHtml = `<div class="p-txt">${urlify(p.text)}</div>`;

            if(p.type === 'bg_text') {
                txtHtml = ""; 
                m = `<div class="p-med" style="background:${p.mediaUrl}; min-height:320px; display:flex; align-items:center; justify-content:center; padding:30px; text-align:center; font-weight:700; font-size:26px; color:white; line-height:1.4;">${p.text}</div>`;
            } 
            else if(p.mediaUrl) {
                if(p.type === 'video') m = `<div class="p-med"><video src="${p.mediaUrl}" controls></video></div>`;
                else if(p.type === 'youtube') m = `<div class="p-med"><iframe src="${p.mediaUrl}" allowfullscreen></iframe></div>`;
                else m = `<div class="p-med"><img src="${p.mediaUrl}" loading="lazy"></div>`;
            }

            return `<div class="post" id="post-${id}">
                <div class="p-head">
                    <img src="${p.userPic}" class="u-ava" onclick="vwProf('${p.uid}')">
                    <!-- ‡¶®‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá badge ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá -->
                    <div class="p-nm"><h4 onclick="vwProf('${p.uid}')">${p.userName} ${badge}</h4><span>${timeAgo(new Date(p.timestamp))}</span></div>${del}
                </div>
                ${txtHtml}
                ${m}
                <div class="p-stat"><span><i class="fas fa-thumbs-up"></i> <span id="lc-${id}">${lkCnt}</span></span><span onclick="opCmt('${id}')">Comments</span></div>
                <div class="p-act">
                    <div class="btn ${lkCls}" id="lb-${id}" onclick="lk('${id}')"><i class="${isLiked ? 'fas' : 'far'} fa-thumbs-up"></i> Like</div>
                    <div class="btn" onclick="opCmt('${id}')"><i class="far fa-comment-alt"></i> Comment</div>
                    <div class="btn" onclick="opShr('${id}')"><i class="fas fa-share"></i> Share</div>
                </div>
            </div>`;
        }

        window.lk = async(id) => {
            const btns = document.querySelectorAll(`[id="lb-${id}"]`);
            const cnts = document.querySelectorAll(`[id="lc-${id}"]`);
            if(btns.length === 0) return;
            const isLiked = btns[0].classList.contains('liked');
            
            btns.forEach(b => {
                const icon = b.querySelector('i');
                if(isLiked) {
                    b.classList.remove('liked');
                    icon.className = 'far fa-thumbs-up';
                } else {
                    b.classList.add('liked');
                    icon.className = 'fas fa-thumbs-up';
                }
            });

            cnts.forEach(c => {
                let cv = parseInt(c.innerText);
                c.innerText = isLiked ? (cv > 0 ? cv - 1 : 0) : (cv + 1);
            });

            if(isLiked) {
                await updateDoc(doc(db,"posts",id), { likes: arrayRemove(me.uid) });
            } else {
                await updateDoc(doc(db,"posts",id), { likes: arrayUnion(me.uid) });
            }
        }

        function timeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + "y";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + "mo";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + "d";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + "h";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + "m";
            return "Just now";
        }
        
        function urlify(text) {
            var urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.replace(urlRegex, function(url) {
                return '<a href="' + url + '" style="color:var(--accent);text-decoration:none;" target="_blank">' + url + '</a>';
            });
        }

        window.delP = async(id) => {
            if(confirm("Delete this post?")) {
                document.getElementById(`post-${id}`).style.opacity = '0.5';
                await deleteDoc(doc(db,"posts",id));
                document.getElementById(`post-${id}`).remove();
            }
        }

        window.opCmt = async(id) => {
    actP = id;
    window.history.pushState({modal: 'comments'}, '', '');
    document.getElementById('overlay').classList.add('active');
    document.getElementById('cmt-sht').classList.add('open');
    const c = document.getElementById('clist'); 
    c.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-sec);">Loading...</div>';
    const s = await getDocs(query(collection(db,"posts",id,"comments"), orderBy("timestamp","asc")));
    let h = "";
    s.forEach(d => { 
        const k = d.data(); 
        h += `<div class="cmt-item">
            <img src="${k.uPic}" class="u-ava" style="width:32px;height:32px;">
            <div class="cmt-bub"><div class="cmt-n">${k.uName}</div><div class="cmt-t">${k.txt}</div></div>
        </div>`; 
    });
    c.innerHTML = h || '<div style="text-align:center;padding:20px;color:var(--text-sec);">No comments yet.</div>';
    c.scrollTop = c.scrollHeight;
}

        window.postCmt = async() => {
            const inBox = document.getElementById('cin');
            const t = inBox.value.trim();
            if(!t) return;
            inBox.value = ""; 
            const u = (await getDoc(doc(db,"users",me.uid))).data();
            const tempHtml = `<div class="cmt-item" style="opacity:0.7;">
                <img src="${u.profilePic}" class="u-ava" style="width:32px;height:32px;">
                <div class="cmt-bub"><div class="cmt-n">${u.fullName}</div><div class="cmt-t">${t}</div></div>
            </div>`;
            const c = document.getElementById('clist');
            if(c.innerHTML.includes('No comments')) c.innerHTML = "";
            c.insertAdjacentHTML('beforeend', tempHtml);
            c.scrollTop = c.scrollHeight;
            await addDoc(collection(db,"posts",actP,"comments"), {
                uid: me.uid, uName: u.fullName, uPic: u.profilePic, txt: t, timestamp: new Date().toISOString()
            });
            window.opCmt(actP);
        }

        // --- UPDATED STORY FUNCTIONS (Upload Fix & Auto Delete) ---

        // ‡ßß. ‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶è‡¶¨‡¶Ç ‡ß®‡ß™ ‡¶ò‡¶®‡ßç‡¶ü‡¶æ‡¶∞ ‡¶™‡ßÅ‡¶∞‡¶®‡ßã ‡¶π‡¶≤‡ßá ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ
        async function loadSt() {
            const t = document.getElementById('s-tray');
            while(t.children.length > 1) t.removeChild(t.lastChild);
            
            const s = await getDocs(query(collection(db,"stories"), orderBy("timestamp","desc")));
            
            s.forEach(async d => {
                const k = d.data();
                const timeDiff = new Date().getTime() - new Date(k.timestamp).getTime();
                
                // ‡ß®‡ß™ ‡¶ò‡¶®‡ßç‡¶ü‡¶æ ‡¶ö‡ßá‡¶ï
                if(timeDiff > 86400000) { 
                    await deleteDoc(doc(db,"stories",d.id));
                    return; 
                } 
                
                const v = document.createElement('div'); 
                v.className = 'story-card';
                v.innerHTML = `<img src="${k.url}" class="story-img"><div class="story-overlay"></div><img src="${k.userPic}" class="s-ava"><div class="s-user">${k.userName}</div>`;
                v.onclick = () => viewStory(k);
                t.appendChild(v);
            });
        }

        window.openStoryEditor = async (inp) => {
    if(inp.files && inp.files[0]) {
        window.history.pushState({modal: 'editor'}, '', '');
        storyFile = inp.files[0];
        selectedMusic = null;
        document.getElementById('se-caption').value = '';
        document.getElementById('se-drag-txt').innerText = '';
        document.getElementById('se-caption-box').classList.remove('show');
        document.getElementById('music-tool-lbl').innerText = "Music";
        document.getElementById('music-tool-lbl').style.color = "white";
        
        const d = (await getDoc(doc(db,"users",me.uid))).data();
        document.getElementById('se-my-pic').src = d.profilePic;

        const r = new FileReader();
        r.onload = (e) => {
            document.getElementById('se-prev-img').src = e.target.result;
            document.getElementById('story-editor').style.display = 'flex';
        }
        r.readAsDataURL(storyFile);
    }
}

        window.closeStoryEditor = () => {
            document.getElementById('story-editor').style.display = 'none';
            document.getElementById('se-caption').value = '';
            document.getElementById('se-drag-txt').innerText = '';
            document.getElementById('s-in').value = '';
            storyFile = null;
        }

        window.updateSeText = (val) => {
            document.getElementById('se-drag-txt').innerText = val;
        }

        window.dragStart = (e) => { e.preventDefault(); }
        window.dragMove = (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const cont = document.querySelector('.se-prev');
            const rect = cont.getBoundingClientRect();
            let y = touch.clientY - rect.top;
            if(y < 0) y = 0;
            if(y > rect.height) y = rect.height;
            const yPerc = (y / rect.height) * 100;
            storyYPos = yPerc;
            document.getElementById('se-drag-txt').style.top = yPerc + '%';
        }

        // ‡ß®. ‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶´‡¶ø‡¶ï‡ßç‡¶∏ (Error fix)
        window.uploadStory = async() => {
            const b = document.getElementById('st-up-btn');
            const originalText = b.innerText;
            b.innerText = "Sharing...";
            b.disabled = true;
            try {
                let url = null;
                if (storyFile) {
                    const fd = new FormData(); 
                    fd.append('file', storyFile); 
                    fd.append('upload_preset', C_PRE);
                    const r = await fetch(C_URL, {method:'POST', body:fd});
                    if(!r.ok) throw new Error("Upload failed");
                    const d = await r.json();
                    url = d.secure_url;
                }
                
                const u = (await getDoc(doc(db,"users",me.uid))).data();
                
                await addDoc(collection(db,"stories"),{
                    uid: me.uid, 
                    url: url, 
                    userName: u.fullName, 
                    userPic: u.profilePic,
                    timestamp: new Date().toISOString(), 
                    caption: document.getElementById('se-caption').value,
                    yPos: storyYPos,
                    musicUrl: selectedMusic ? selectedMusic.url : null,
                    musicName: selectedMusic ? selectedMusic.name : null
                });
                
                selectedMusic = null;
                document.getElementById('music-tool-lbl').innerText = "Music";
                document.getElementById('music-tool-lbl').style.color = "white";
                const ap = document.getElementById('m-preview-player');
                if(ap) { ap.pause(); ap.src=""; }

                closeStoryEditor();
                loadSt();
                alert("Story Shared Successfully!"); 
            } catch(e) { 
                console.error(e); 
                alert("Error sharing story: " + e.message); 
            } finally {
                b.innerText = originalText;
                b.disabled = false;
            }
        }

        let storyAudio = new Audio();

        window.viewStory = (data) => {
    window.history.pushState({modal: 'story'}, '', '');
    const v = document.getElementById('story-viewer');
    v.style.display = 'flex';
    document.getElementById('sv-main-img').src = data.url;
    document.getElementById('sv-ava').src = data.userPic;
    
    let nameTxt = data.userName;
    if(data.musicName) nameTxt += ` üéµ ${data.musicName}`;
    document.getElementById('sv-name').innerText = nameTxt;

    const cap = document.getElementById('sv-caption');
    cap.innerText = data.caption || "";
    cap.style.top = (data.yPos || 50) + '%';
    
    if(data.musicUrl) {
        storyAudio.src = data.musicUrl;
        storyAudio.volume = 1.0;
        storyAudio.play().catch(e => console.log("Auto-play blocked"));
    }

    const bar = document.getElementById('sv-bar');
    bar.style.width = '0%';
    setTimeout(() => bar.style.width = '100%', 100);
    bar.style.transition = 'width 5s linear';
    
    if(activeStoryTimer) clearTimeout(activeStoryTimer);
    activeStoryTimer = setTimeout(closeStoryView, 5000);
}

        window.closeStoryView = () => {
            document.getElementById('story-viewer').style.display = 'none';
            if(activeStoryTimer) clearTimeout(activeStoryTimer);
            storyAudio.pause();
            storyAudio.currentTime = 0;
        }

        window.sendReact = (emoji) => {
            const el = document.createElement('div');
            el.className = 'flying-emoji';
            el.innerText = emoji;
            document.getElementById('story-viewer').appendChild(el);
            setTimeout(() => el.remove(), 1500);
        }

        window.openSearch = () => {
    window.history.pushState({modal: 'search'}, '', '');
    document.getElementById('srch-pg').style.display='flex';
    document.getElementById('s-input-box').focus();
}
        
        window.doSrch = async(v) => {
            if(v.length < 2) return;
            const r = document.getElementById('s-out');
            const end = v + "\uf8ff";
            const s = await getDocs(query(collection(db,"users"), where("fullName", ">=", v), where("fullName", "<=", end)));
            r.innerHTML="";
            s.forEach(d => { 
                const k = d.data(); 
                r.innerHTML += `<div class="s-row" onclick="vwProf('${k.uid}')">
                    <img src="${k.profilePic}" class="u-ava">
                    <div><div style="font-weight:600;color:var(--text)">${k.fullName}</div><div style="font-size:12px;color:var(--text-sec)">User</div></div>
                </div>`; 
            });
        }

        // ‡ß©. ‡¶≠‡¶ø‡¶â ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü (‡¶Æ‡ßá‡¶∏‡ßá‡¶û‡ßç‡¶ú‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡¶∂‡¶® ‡¶∏‡¶π)
        window.vwProf = async(id) => {
            closeAll();
            if(id === me.uid) { nav('profile'); return; }
            document.getElementById('loader').style.display='flex';
            guestId = id;
            const d = (await getDoc(doc(db,"users",id))).data();
            document.getElementById('vp-cvr').src = d.coverPic || '';
            document.getElementById('vp-img').src = d.profilePic;
            document.getElementById('vp-nm').innerText = d.fullName;
            document.getElementById('vp-bio').innerText = d.bio || "No bio";
            
            const myD = (await getDoc(doc(db,"users",me.uid))).data();
            const btn = document.getElementById('vp-btn');
            
            // ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶¨‡¶æ‡¶ü‡¶® ‡¶≤‡¶ú‡¶ø‡¶ï
            const msgBtn = document.querySelector('#p-view .btn-s');
            if(msgBtn) {
                msgBtn.innerHTML = '<i class="fab fa-facebook-messenger"></i> Message';
                msgBtn.setAttribute('onclick', `location.href='chat.html?uid=${id}'`);
            }

            const friends = myD.friends || [];
            const incoming = myD.friendRequests || [];
            const outgoing = d.friendRequests || [];
            
            btn.disabled = false;
            btn.className = "pf-btn btn-p";
            btn.onclick = () => frAct();

            if(friends.includes(id)) { 
                btn.innerHTML = '<i class="fas fa-check"></i> Friends'; 
                btn.className = "pf-btn btn-s"; 
                btn.onclick = null; 
            }
            else if(outgoing.includes(me.uid)) { 
                btn.innerHTML = '<i class="fas fa-paper-plane"></i> Sent'; 
                btn.disabled = true; 
                btn.className = "pf-btn btn-s"; 
            }
            else if(incoming.includes(id)) { 
                btn.innerHTML = 'Respond'; 
                btn.onclick = () => { nav('friends'); }; 
            }
            else { 
                btn.innerHTML = '<i class="fas fa-user-plus"></i> Add Friend'; 
            }

            const c = document.getElementById('vp-posts');
            const s = await getDocs(query(collection(db,"posts"), orderBy("timestamp","desc")));
            let h = "";
            s.forEach(x => { if(x.data().uid === id) h += mkP(x.data(), x.id); });
            c.innerHTML = h || '<div style="padding:20px;text-align:center;color:var(--text-sec)">No posts yet</div>';
            nav('view');
            document.getElementById('loader').style.display='none';
        }

        window.frAct = async() => {
            const btn = document.getElementById('vp-btn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            await updateDoc(doc(db,"users",guestId), { friendRequests: arrayUnion(me.uid) });
            btn.innerHTML = '<i class="fas fa-paper-plane"></i> Sent';
            btn.className = "pf-btn btn-s";
            btn.disabled = true;
        }

        window.openEdit = () => {
    window.history.pushState({modal: 'edit'}, '', '');
    document.getElementById('edit-mod').style.display='flex';
    document.getElementById('e-nm').value = document.getElementById('pf-nm').innerText;
    document.getElementById('e-bio').value = document.getElementById('pf-bio').innerText;
    document.getElementById('e-prev-pp').src = document.getElementById('pf-img').src;
    document.getElementById('e-prev-cp').src = document.getElementById('pf-cvr').src || '';
}

        window.prevImg = (inpt, imgId) => {
            if (inpt.files && inpt.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) { document.getElementById(imgId).src = e.target.result; }
                reader.readAsDataURL(inpt.files[0]);
            }
        }

        window.savePf = async() => {
            const b = document.getElementById('sv-btn');
            b.innerText = "Saving...";
            b.disabled = true;
            const n = document.getElementById('e-nm').value;
            const bio = document.getElementById('e-bio').value;
            const pp = document.getElementById('e-pp').files[0];
            const cp = document.getElementById('e-cp').files[0];
            const upD = { fullName: n, bio: bio };
            try {
                if(pp) {
                    const fd = new FormData(); fd.append('file', pp); fd.append('upload_preset', C_PRE);
                    const r = await fetch(C_URL, {method:'POST', body:fd}); const d = await r.json();
                    upD.profilePic = d.secure_url;
                }
                if(cp) {
                    const fd = new FormData(); fd.append('file', cp); fd.append('upload_preset', C_PRE);
                    const r = await fetch(C_URL, {method:'POST', body:fd}); const d = await r.json();
                    upD.coverPic = d.secure_url;
                }
                await updateDoc(doc(db,"users",me.uid), upD);
                location.reload();
            } catch(e) { alert("Error saving profile"); b.innerText = "Save Changes"; b.disabled = false; }
        }

        // ‡ß™. ‡¶∞‡¶ø‡ßü‡ßá‡¶≤-‡¶ü‡¶æ‡¶á‡¶Æ ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü (Live Update)
        function loadReq() {
            onSnapshot(doc(db, "users", me.uid), (ds) => {
                if (!ds.exists()) return;
                const u = ds.data();
                const reqs = u.friendRequests || [];
                const cont = document.getElementById('req-cont');
                const list = document.getElementById('req-list');
                
                if(reqs.length === 0) { 
                    cont.style.display = 'none'; 
                    return; 
                }
                
                cont.style.display = 'block';
                document.getElementById('req-cnt').innerText = reqs.length;
                list.innerHTML = "";
                
                reqs.forEach(async id => {
                    const f = (await getDoc(doc(db,"users",id))).data();
                    const div = document.createElement('div');
                    div.className = 's-row';
                    div.style.background = 'var(--bg)';
                    div.innerHTML = `<img src="${f.profilePic}" class="u-ava" style="width:50px;height:50px;"><div style="flex:1;"><div style="font-weight:600; margin-bottom:5px;">${f.fullName}</div><div style="display:flex; gap:10px;"><button onclick="acp('${id}', this)" style="flex:1;background:var(--accent);color:white;border:none;padding:6px;border-radius:6px;font-weight:600;">Confirm</button><button onclick="delReq('${id}', this)" style="flex:1;background:var(--input);color:var(--text);border:none;padding:6px;border-radius:6px;font-weight:600;">Delete</button></div></div>`;
                    list.appendChild(div);
                });
            });
        }

        window.acp = async(id, btn) => {
            btn.parentNode.parentNode.innerHTML = '<span style="color:var(--text-sec)">Request Accepted</span>';
            await updateDoc(doc(db,"users",me.uid), { friendRequests: arrayRemove(id), friends: arrayUnion(id) });
            await updateDoc(doc(db,"users",id), { friends: arrayUnion(me.uid) });
        }
        
        window.delReq = async(id, btn) => {
            btn.parentNode.parentNode.innerHTML = '<span style="color:var(--text-sec)">Request Removed</span>';
            await updateDoc(doc(db,"users",me.uid), { friendRequests: arrayRemove(id) });
        }

        async function loadSugg() {
            const c = document.getElementById('sugg-list');
            const s = await getDocs(collection(db,"users"));
            const md = (await getDoc(doc(db,"users",me.uid))).data();
            const friends = md.friends || [];
            const reqs = md.friendRequests || [];
            c.innerHTML = "";
            s.forEach(d => {
                const u = d.data();
                if(u.uid !== me.uid && !friends.includes(u.uid) && !reqs.includes(u.uid)) {
                    const isSent = u.friendRequests && u.friendRequests.includes(me.uid);
                    let btn = `<button class="fr-btn" onclick="snd('${u.uid}',this)">Add Friend</button>`;
                    if(isSent) btn = `<button class="fr-btn" style="background:var(--input); color:var(--text); cursor:default;">Sent</button>`;

                    c.innerHTML += `<div class="fr-card"><img src="${u.profilePic}" class="fr-img" onclick="vwProf('${u.uid}')"><div class="fr-name">${u.fullName}</div>${btn}</div>`;
                }
            });
        }

        window.snd = async(id, b) => {
            b.innerText = "Sent"; b.style.background = "var(--input)"; b.style.color = "var(--text)";
            await updateDoc(doc(db,"users",id), { friendRequests: arrayUnion(me.uid) });
        }

        function loadVid() {
            const c = document.getElementById('v-feed');
            // ‡¶´‡¶ø‡¶ï‡ßç‡¶∏: position fixed ‡¶è‡¶¨‡¶Ç height ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá ‡¶Ø‡¶æ‡¶§‡ßá ‡¶®‡¶ø‡¶ö‡ßá ‡¶ó‡ßç‡¶Ø‡¶æ‡¶™ ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá
            c.innerHTML = `<iframe src="reels.html" style="position:fixed; top:100px; left:0; width:100%; height:calc(100% - 100px); border:none; background:black; z-index:5;"></iframe>`;
        }

        async function loadMyP() {
            const c = document.getElementById('my-posts');
            const s = await getDocs(query(collection(db,"posts"), orderBy("timestamp","desc")));
            let h = ""; 
            s.forEach(d => { if(d.data().uid === me.uid) h += mkP(d.data(), d.id); });
            c.innerHTML = h || '<div style="padding:20px;text-align:center;color:var(--text-sec)">No posts yet</div>';
        }

        window.openMenu = () => { 
    window.history.pushState({modal: 'menu'}, '', '');
    document.getElementById('overlay').classList.add('active'); 
    document.getElementById('menu-pg').classList.add('open'); 
}
        window.opShr = (id) => { 
    actP = id; 
    window.history.pushState({modal: 'share'}, '', '');
    document.getElementById('overlay').classList.add('active'); 
    document.getElementById('shr-sht').classList.add('open'); 
}
        
        window.closeAll = () => {
    history.back();
}

        window.shareFeed = async () => {
            const btn = document.querySelector('.sh-icon');
            if(!actP) return;
            try {
                const pDoc = await getDoc(doc(db, "posts", actP));
                if(!pDoc.exists()) return;
                const pData = pDoc.data();
                const uData = (await getDoc(doc(db,"users",me.uid))).data();
                await addDoc(collection(db,"posts"), {
                    uid: me.uid,
                    userName: uData.fullName,
                    userPic: uData.profilePic,
                    text: `Shared a post: ${pData.text || ''}`,
                    mediaUrl: pData.mediaUrl || null,
                    type: pData.type || 'text',
                    likes: [],
                    timestamp: new Date().toISOString()
                });
                alert("Post shared to your timeline!");
                closeAll();
                loadFeed();
            } catch(e) {
                alert("Error sharing: " + e.message);
            }
        }
        window.copyL = () => { navigator.clipboard.writeText("tio.app/p/"+actP); alert("Link Copied"); closeAll(); }
        window.logout = () => signOut(auth);

        window.openMusicModal = () => {
    window.history.pushState({modal: 'music'}, '', '');
    document.getElementById('music-modal').classList.add('open');
    if(document.getElementById('m-list').innerHTML === "") {
        searchMusic('Tanveer Evan');
    }
}

        let previewAudio = document.getElementById('m-preview-player');

        window.searchMusic = async (q) => {
            if(q.length < 2) return;
            const resBox = document.getElementById('m-list');
            resBox.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-sec);"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
            stopPreview();

            const url = `https://itunes.apple.com/search?term=${encodeURIComponent(q)}&entity=song&limit=20`;
            try {
                const req = await fetch(url);
                const data = await req.json();
                resBox.innerHTML = "";
                if(data.results.length === 0) {
                    resBox.innerHTML = '<div style="padding:20px; text-align:center;">No songs found.</div>';
                    return;
                }
                data.results.forEach(track => {
                    const safeName = track.trackName.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    const safeUrl = track.previewUrl;
                    const row = document.createElement('div');
                    row.className = 'm-item';
                    row.innerHTML = `
                        <img src="${track.artworkUrl100}" class="m-thumb">
                        <div class="m-info">
                            <div class="m-title">${track.trackName}</div>
                            <div class="m-artist">${track.artistName}</div>
                        </div>
                        <div class="m-act-box">
                            <i class="fas fa-play-circle m-play-btn" onclick="playPreview('${safeUrl}', this)"></i>
                            <button class="m-sel-btn" onclick="selectMusic('${safeUrl}', '${safeName}')">Select</button>
                        </div>
                    `;
                    resBox.appendChild(row);
                });
            } catch(e) { 
                resBox.innerHTML = '<div style="padding:20px; text-align:center;">Error loading music.</div>';
            }
        }

        window.playPreview = (url, btn) => {
            if(previewAudio.src === url && !previewAudio.paused) {
                previewAudio.pause();
                btn.className = "fas fa-play-circle m-play-btn";
                return;
            }
            document.querySelectorAll('.m-play-btn').forEach(b => b.className = "fas fa-play-circle m-play-btn");
            previewAudio.src = url;
            previewAudio.volume = 0.8;
            previewAudio.play();
            btn.className = "fas fa-pause-circle m-play-btn";
        }

        function stopPreview() {
            previewAudio.pause();
            previewAudio.currentTime = 0;
            document.querySelectorAll('.m-play-btn').forEach(b => b.className = "fas fa-play-circle m-play-btn");
        }

        window.selectMusic = (url, name) => {
            stopPreview();
            selectedMusic = { url: url, name: name };
            const shortName = name.length > 12 ? name.substring(0,10)+'..' : name;
            document.getElementById('music-tool-lbl').innerText = shortName;
            document.getElementById('music-tool-lbl').style.color = '#4cd137';
            document.getElementById('music-modal').classList.remove('open');
        }
    </script>
</body>
</html>
