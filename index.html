<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>tio</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { --bg: #f0f2f5; --card: #ffffff; --text: #050505; --sub: #65676b; --icon: #e4e6eb; --accent: #1877f2; --border: #ddd; }
        .dark-mode { --bg: #18191a; --card: #242526; --text: #e4e6eb; --sub: #b0b3b8; --icon: #3a3b3c; --border: #3e4042; }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); color: var(--text); padding-top: 105px; padding-bottom: 60px; min-height: 100vh; }
        
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; }
        .header { position: fixed; top: 0; left: 0; width: 100%; height: 55px; background: var(--card); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; z-index: 1000; border-bottom: 1px solid var(--border); }
        .logo { font-size: 28px; font-weight: 800; color: var(--accent); }
        .h-icons i { font-size: 18px; background: var(--icon); width: 35px; height: 35px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-left: 8px; color: var(--text); cursor: pointer; }

        .tabs { position: fixed; top: 55px; left: 0; width: 100%; height: 50px; background: var(--card); display: flex; align-items: center; z-index: 999; border-bottom: 1px solid var(--border); }
        .tab { flex: 1; height: 100%; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; }
        .tab i { font-size: 24px; color: var(--sub); }
        .tab.active i { color: var(--accent); }
        .tab.active::after { content: ''; position: absolute; bottom: 0; width: 100%; height: 3px; background: var(--accent); }

        .section { display: none; }
        .section.active { display: block; }

        .create-box { background: var(--card); padding: 12px 15px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .u-ava { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .c-in { flex: 1; background: var(--bg); height: 40px; border-radius: 20px; padding: 0 15px; display: flex; align-items: center; color: var(--sub); border: 1px solid var(--border); cursor: pointer; }

        .post { background: var(--card); margin-bottom: 10px; width: 100%; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); }
        .p-head { padding: 12px 15px; display: flex; align-items: center; gap: 10px; }
        .p-nm h4 { font-size: 16px; font-weight: 600; color: var(--text); }
        .p-nm span { font-size: 12px; color: var(--sub); }
        .p-txt { font-size: 15px; color: var(--text); padding: 0 15px 10px; }
        .p-med { width: 100%; display: block; background: #000; overflow: hidden; }
        .p-med img, .p-med video { width: 100%; max-height: 600px; object-fit: contain; }
        .p-med iframe { width: 100%; aspect-ratio: 16/9; border: none; }
        .p-act { display: flex; height: 44px; align-items: center; border-top: 1px solid var(--border); }
        .btn { flex: 1; display: flex; align-items: center; justify-content: center; color: var(--sub); font-weight: 600; font-size: 14px; gap: 6px; cursor: pointer; }
        .btn.liked { color: var(--accent); }

        /* Menu Modal */
        #menu-pg { position: fixed; top: 0; right: 0; width: 100%; height: 100%; background: var(--bg); z-index: 2000; transform: translateX(100%); transition: 0.3s; padding: 20px; overflow-y: auto; }
        #menu-pg.open { transform: translateX(0); }
        .m-head { font-size: 24px; font-weight: 700; margin-bottom: 20px; display: flex; justify-content: space-between; }
        .m-item { background: var(--card); padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; font-weight: 600; box-shadow: 0 1px 2px rgba(0,0,0,0.1); cursor: pointer; }

        /* Search Modal */
        #srch-pg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--card); z-index: 2000; display: none; flex-direction: column; }
        .s-bar { padding: 15px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
        .s-in { flex: 1; background: var(--bg); border: none; padding: 10px 15px; border-radius: 20px; color: var(--text); outline: none; }
        .s-res { padding: 15px; overflow-y: auto; }
        .s-it { display: flex; align-items: center; gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--border); }

        /* Edit Profile Modal */
        #edit-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; background: var(--card); padding: 20px; border-radius: 10px; z-index: 3000; display: none; box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
        .e-inp { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid var(--border); border-radius: 5px; background: var(--bg); color: var(--text); }

    </style>
</head>
<body>
    
    <div id="overlay" class="overlay" onclick="closeAll()"></div>

    <!-- Header -->
    <div class="header">
        <div class="logo" onclick="location.reload()">tio</div>
        <div class="h-icons">
            <i class="fas fa-plus" onclick="location.href='post.html'"></i>
            <i class="fas fa-search" onclick="openSearch()"></i>
            <i class="fas fa-bars" onclick="openMenu()"></i>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <div class="tab active" id="t-home" onclick="nav('home')"><i class="fas fa-home"></i></div>
        <div class="tab" id="t-video" onclick="nav('video')"><i class="fas fa-video"></i></div>
        <div class="tab" id="t-friends" onclick="nav('friends')"><i class="fas fa-user-friends"></i></div>
        <div class="tab" id="t-profile" onclick="nav('profile')"><i class="fas fa-user-circle"></i></div>
    </div>

    <!-- Home -->
    <div id="p-home" class="section active">
        <div class="create-box">
            <img id="u-pic" class="u-ava">
            <div class="c-in" onclick="location.href='post.html'">Write something...</div>
        </div>
        <div id="feed"></div>
    </div>

    <!-- Video (Classic Style) -->
    <div id="p-video" class="section">
        <div id="v-feed"></div>
    </div>

    <!-- Friends -->
    <div id="p-friends" class="section">
        <div style="padding:15px; font-weight:700;">Friend Requests</div>
        <div id="req-list" style="padding:0 15px;"></div>
    </div>

    <!-- Profile -->
    <div id="p-profile" class="section">
        <div style="background:var(--card); text-align:center; padding-bottom:15px; margin-bottom:10px;">
            <img id="pf-cover" style="width:100%; height:180px; object-fit:cover; background:#333;">
            <img id="pf-pic" style="width:110px; height:110px; border-radius:50%; border:4px solid var(--card); margin-top:-55px; background:#eee; object-fit:cover;">
            <h2 id="pf-name" style="margin-top:10px; font-size:24px; color:var(--text);"></h2>
            <p id="pf-bio" style="color:var(--sub); margin-bottom:10px;"></p>
            <button onclick="openEdit()" style="background:var(--icon); color:var(--text); border:none; padding:8px 20px; font-weight:600; border-radius:6px;">Edit Profile</button>
        </div>
        <div id="my-posts"></div>
    </div>

    <!-- Menu Page -->
    <div id="menu-pg">
        <div class="m-head">Menu <i class="fas fa-times" onclick="closeAll()"></i></div>
        <div class="m-item" onclick="toggleDark()">
            <span>Dark Mode</span> <i class="fas fa-moon"></i>
        </div>
        <div class="m-item" onclick="logout()">
            <span style="color:red;">Log Out</span> <i class="fas fa-sign-out-alt"></i>
        </div>
    </div>

    <!-- Search Page -->
    <div id="srch-pg">
        <div class="s-bar">
            <i class="fas fa-arrow-left" onclick="closeAll()"></i>
            <input type="text" class="s-in" placeholder="Search friends..." onkeyup="doSearch(this.value)">
        </div>
        <div id="s-res" class="s-res"></div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="edit-modal">
        <h3>Edit Profile</h3>
        <input type="text" id="e-name" class="e-inp" placeholder="Full Name">
        <input type="text" id="e-bio" class="e-inp" placeholder="Bio">
        <button onclick="saveProfile()" style="width:100%; background:var(--accent); color:white; padding:10px; border:none; border-radius:5px;">Save</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, orderBy, limit, getDocs, updateDoc, arrayUnion, arrayRemove, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const cfg = { apiKey: "AIzaSyD_HBGuQSh_GzqrHqHbgdaoBikLZsK3Qqs", authDomain: "new-all-f99f7.firebaseapp.com", projectId: "new-all-f99f7", storageBucket: "new-all-f99f7.appspot.com", messagingSenderId: "1069748173900", appId: "1:1069748173900:web:158d6336c0f4628133c8e9" };
        const app = initializeApp(cfg);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let curUser = null;

        onAuthStateChanged(auth, async (u) => {
            if(u) {
                curUser = u;
                const d = (await getDoc(doc(db,"users",u.uid))).data();
                document.getElementById('u-pic').src = d.profilePic;
                document.getElementById('pf-pic').src = d.profilePic;
                document.getElementById('pf-cover').src = d.coverPic;
                document.getElementById('pf-name').innerText = d.fullName;
                document.getElementById('pf-bio').innerText = d.bio || "No bio";
                loadFeed();
            } else location.href="Account.html";
        });

        window.nav = (p) => {
            document.querySelectorAll('.section').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));
            document.getElementById('p-'+p).classList.add('active');
            document.getElementById('t-'+p).classList.add('active');
            if(p==='video') loadVid();
            if(p==='profile') loadMine();
            if(p==='friends') loadReq();
        }

        async function loadFeed() {
            const c = document.getElementById('feed');
            const s = await getDocs(query(collection(db,"posts"), orderBy("timestamp","desc"), limit(20)));
            let h = "";
            s.forEach(d => h+=mkPost(d.data(), d.id));
            c.innerHTML = h;
        }

        async function loadVid() {
            const c = document.getElementById('v-feed');
            if(c.children.length) return;
            const s = await getDocs(query(collection(db,"posts"), orderBy("timestamp","desc")));
            s.forEach(d => {
                const p = d.data();
                if(p.type==='video' || p.type==='youtube') c.innerHTML += mkPost(p, d.id);
            });
        }

        function mkPost(p, id) {
            const lk = p.likes?.includes(curUser.uid) ? 'liked' : '';
            let m = "";
            if(p.mediaUrl) {
                if(p.type==='video') m = `<div class="p-med"><video src="${p.mediaUrl}" controls></video></div>`;
                else if(p.type==='youtube') m = `<div class="p-med"><iframe src="${p.mediaUrl}" allowfullscreen></iframe></div>`;
                else m = `<div class="p-med"><img src="${p.mediaUrl}"></div>`;
            }
            return `<div class="post">
                <div class="p-head"><img src="${p.userPic}" class="u-ava"><div class="p-nm"><h4>${p.userName}</h4><span>Just now</span></div></div>
                <div class="p-txt">${p.text}</div>${m}
                <div class="p-act"><div class="btn ${lk}" id="l-${id}" onclick="like('${id}')"><i class="fas fa-thumbs-up"></i> Like</div><div class="btn"><i class="far fa-comment-alt"></i> Comment</div><div class="btn"><i class="fas fa-share"></i> Share</div></div>
            </div>`;
        }

        window.like = async(id) => {
            const b = document.getElementById(`l-${id}`);
            if(b.classList.contains('liked')) { b.classList.remove('liked'); updateDoc(doc(db,"posts",id),{likes:arrayRemove(curUser.uid)}); }
            else { b.classList.add('liked'); updateDoc(doc(db,"posts",id),{likes:arrayUnion(curUser.uid)}); }
        }

        window.openMenu = () => document.getElementById('menu-pg').classList.add('open');
        window.openSearch = () => document.getElementById('srch-pg').style.display='flex';
        window.closeAll = () => {
            document.getElementById('menu-pg').classList.remove('open');
            document.getElementById('srch-pg').style.display='none';
            document.getElementById('edit-modal').style.display='none';
            document.getElementById('overlay').style.display='none';
        }

        window.toggleDark = () => document.body.classList.toggle('dark-mode');
        window.logout = () => signOut(auth);

        window.doSearch = async (val) => {
            if(val.length<3) return;
            const res = document.getElementById('s-res');
            const s = await getDocs(query(collection(db,"users"), where("fullName", ">=", val), where("fullName", "<=", val+"\uf8ff")));
            res.innerHTML = "";
            s.forEach(d => {
                const u = d.data();
                res.innerHTML += `<div class="s-it"><img src="${u.profilePic}" class="u-ava"><b>${u.fullName}</b></div>`;
            });
        }

        window.openEdit = () => {
            document.getElementById('e-name').value = document.getElementById('pf-name').innerText;
            document.getElementById('e-bio').value = document.getElementById('pf-bio').innerText;
            document.getElementById('overlay').style.display='block';
            document.getElementById('edit-modal').style.display='block';
        }

        window.saveProfile = async () => {
            const n = document.getElementById('e-name').value;
            const b = document.getElementById('e-bio').value;
            await updateDoc(doc(db,"users",curUser.uid), {fullName:n, bio:b});
            location.reload();
        }

        async function loadReq() {
            const c = document.getElementById('req-list');
            const u = (await getDoc(doc(db,"users",curUser.uid))).data();
            c.innerHTML = "";
            u.friendRequests?.forEach(async id => {
                const f = (await getDoc(doc(db,"users",id))).data();
                c.innerHTML += `<div style="display:flex;align-items:center;padding:10px;gap:10px;"><img src="${f.profilePic}" class="u-ava"><b>${f.fullName}</b><button onclick="acc('${id}')">Confirm</button></div>`;
            });
        }
        window.acc = async(id) => {
            await updateDoc(doc(db,"users",curUser.uid),{friendRequests:arrayRemove(id),friends:arrayUnion(id)});
            await updateDoc(doc(db,"users",id),{friends:arrayUnion(curUser.uid)});
            loadReq();
        }
        async function loadMine() {
            const c = document.getElementById('my-posts');
            const s = await getDocs(query(collection(db,"posts"), orderBy("timestamp","desc")));
            let h = "";
            s.forEach(d => { if(d.data().uid===curUser.uid) h+=mkPost(d.data(),d.id); });
            c.innerHTML = h;
        }
    </script>
</body>
</html>
