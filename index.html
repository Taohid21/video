<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>tio</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: #f0f2f5; padding-top: 100px; padding-bottom: 60px; min-height: 100vh; overscroll-behavior-y: none; }

        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 9999; display: flex; flex-direction: column;
            justify-content: center; align-items: center; transition: opacity 0.4s;
        }
        .splash-logo { font-size: 50px; font-weight: 800; color: #1877f2; letter-spacing: -2px; }
        .splash-spinner { margin-top: 20px; width: 30px; height: 30px; border: 3px solid #ddd; border-top-color: #1877f2; border-radius: 50%; animation: spin 0.8s infinite linear; }

        .header { position: fixed; top: 0; left: 0; width: 100%; height: 55px; background: #fff; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; z-index: 1000; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .logo { font-size: 28px; font-weight: 800; color: #1877f2; }
        .header-icons i { font-size: 20px; background: #e4e6eb; width: 35px; height: 35px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-left: 8px; cursor: pointer; color: #050505; }

        .nav-tabs { position: fixed; top: 55px; left: 0; width: 100%; height: 45px; background: #fff; display: flex; align-items: center; z-index: 999; border-bottom: 1px solid #ddd; }
        .tab { flex: 1; height: 100%; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; }
        .tab i { font-size: 24px; color: #65676b; }
        .tab.active i { color: #1877f2; }
        .tab.active::after { content: ''; position: absolute; bottom: 0; width: 100%; height: 3px; background: #1877f2; }

        .page-section { display: none; padding-bottom: 20px; }
        .page-section.active { display: block; }

        .create-post-container { background: #fff; padding: 12px 16px; margin-bottom: 8px; display: flex; align-items: center; gap: 12px; }
        .user-avatar-sm { width: 40px; height: 40px; border-radius: 50%; background: #ddd; object-fit: cover; }
        .post-trigger { flex: 1; background: #f0f2f5; height: 40px; border-radius: 20px; display: flex; align-items: center; padding-left: 15px; color: #65676b; font-size: 15px; cursor: pointer; border: 1px solid #ddd; }

        .story-tray { background: #fff; padding: 12px 0; margin-bottom: 8px; overflow-x: auto; display: flex; gap: 8px; padding-left: 12px; scrollbar-width: none; }
        .story-card { min-width: 105px; height: 180px; border-radius: 12px; position: relative; overflow: hidden; border: 1px solid #ddd; flex-shrink: 0; cursor: pointer; }
        .story-card img { width: 100%; height: 100%; object-fit: cover; }
        .create-story-overlay { position: absolute; bottom: 0; width: 100%; background: #fff; height: 45px; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 5px; font-weight: 600; font-size: 13px; }
        .plus-icon { position: absolute; bottom: 30px; background: #1877f2; color: #fff; width: 30px; height: 30px; border-radius: 50%; border: 3px solid #fff; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .story-user { position: absolute; bottom: 8px; left: 8px; color: #fff; font-weight: 600; font-size: 12px; text-shadow: 0 1px 2px rgba(0,0,0,0.6); }

        .post { background: #fff; margin-bottom: 8px; width: 100%; }
        .post-header { padding: 12px 16px; display: flex; align-items: center; gap: 10px; }
        .post-info h4 { font-size: 15px; font-weight: 600; color: #050505; }
        .post-info span { font-size: 12px; color: #65676b; }
        .post-content { font-size: 15px; color: #050505; line-height: 1.5; padding: 0 16px 12px; }
        .post-media { width: 100%; display: block; background: #000; }
        .post-media img, .post-media video { width: 100%; max-height: 550px; object-fit: contain; display: block; }
        .post-stats { padding: 10px 16px; display: flex; justify-content: space-between; border-bottom: 1px solid #ddd; color: #65676b; font-size: 13px; }
        .post-actions { display: flex; height: 45px; align-items: center; }
        .action-btn { flex: 1; display: flex; align-items: center; justify-content: center; height: 100%; color: #65676b; font-weight: 600; font-size: 14px; gap: 8px; cursor: pointer; }
        .action-btn.liked { color: #1877f2; }

        .profile-header { background: #fff; padding-bottom: 15px; margin-bottom: 8px; text-align: center; }
        .cover-pic { width: 100%; height: 200px; object-fit: cover; background: #ccc; }
        .profile-pic { width: 120px; height: 120px; border-radius: 50%; border: 4px solid #fff; margin-top: -60px; background: #ddd; object-fit: cover; position: relative; }
        .profile-name { font-size: 22px; font-weight: 700; color: #050505; margin-top: 10px; }

        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="splash-screen">
        <div class="splash-logo">tio</div>
        <div class="splash-spinner"></div>
    </div>

    <div class="header">
        <div class="logo" onclick="window.location.reload()">tio</div>
        <div class="header-icons">
            <i class="fas fa-search"></i>
            <i class="fas fa-sign-out-alt" onclick="window.logoutApp()"></i>
        </div>
    </div>

    <div class="nav-tabs">
        <div class="tab active" id="tab-home" onclick="window.nav('home')"><i class="fas fa-home"></i></div>
        <div class="tab" id="tab-video" onclick="window.nav('video')"><i class="fas fa-video"></i></div>
        <div class="tab" id="tab-friends" onclick="window.nav('friends')"><i class="fas fa-user-friends"></i></div>
        <div class="tab" id="tab-profile" onclick="window.nav('profile')"><i class="fas fa-user-circle"></i></div>
    </div>

    <!-- HOME -->
    <div id="page-home" class="page-section active">
        <div class="create-post-container">
            <img id="my-avatar-sm" class="user-avatar-sm">
            <div class="post-trigger" onclick="window.location.href='post.html'">What's on your mind?</div>
            <i class="fas fa-images" style="font-size: 22px; color: #45bd62; margin-left: 5px;"></i>
        </div>
        <div class="story-tray" id="story-tray">
            <div class="story-card" onclick="document.getElementById('story-upload').click()">
                <img id="my-story-pic" src="https://via.placeholder.com/150">
                <div class="create-story-overlay">Create Story</div>
                <div class="plus-icon">+</div>
                <input type="file" id="story-upload" hidden accept="image/*" onchange="window.uploadStory(this)">
            </div>
        </div>
        <div id="news-feed" style="min-height: 200px; text-align: center; padding: 20px;">Loading posts...</div>
    </div>

    <!-- VIDEO -->
    <div id="page-video" class="page-section">
        <div id="video-feed" style="background: #000; min-height: 100vh;"></div>
    </div>

    <!-- FRIENDS -->
    <div id="page-friends" class="page-section">
        <div style="padding: 15px; font-weight: 700; font-size: 20px; background: #fff;">Friend Requests</div>
        <div id="friend-requests-list"></div>
    </div>

    <!-- PROFILE -->
    <div id="page-profile" class="page-section">
        <div class="profile-header">
            <img id="p-cover" class="cover-pic">
            <img id="p-pic" class="profile-pic">
            <h1 id="p-name" class="profile-name">Loading...</h1>
            <button style="background:#e4e6eb; border:none; padding:8px 20px; border-radius:6px; font-weight:600; margin-top:10px;">Edit Profile</button>
        </div>
        <div id="my-posts-feed"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, orderBy, limit, getDocs, updateDoc, arrayUnion, arrayRemove, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyD_HBGuQSh_GzqrHqHbgdaoBikLZsK3Qqs", authDomain: "new-all-f99f7.firebaseapp.com", projectId: "new-all-f99f7", storageBucket: "new-all-f99f7.appspot.com", messagingSenderId: "1069748173900", appId: "1:1069748173900:web:158d6336c0f4628133c8e9" };
        const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dwgvvzbvn/auto/upload";
        const CLOUDINARY_PRESET = "storyapp";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;

        onAuthStateChanged(auth, async (user) => {
            const splash = document.getElementById('splash-screen');
            if (user) {
                currentUser = user;
                try {
                    const snap = await getDoc(doc(db, "users", user.uid));
                    if(snap.exists()) {
                        const d = snap.data();
                        const pUrl = d.profilePic || "https://via.placeholder.com/150";
                        document.getElementById('my-avatar-sm').src = pUrl;
                        document.getElementById('my-story-pic').src = pUrl;
                        document.getElementById('p-pic').src = pUrl;
                        document.getElementById('p-cover').src = d.coverPic || "https://via.placeholder.com/400x200";
                        document.getElementById('p-name').innerText = d.fullName;
                        loadFeed();
                        loadStories();
                    }
                    splash.style.opacity = '0';
                    setTimeout(() => splash.style.display = 'none', 500);
                } catch (e) {
                    console.error(e);
                    splash.style.display = 'none'; // Force hide on error
                }
            } else {
                window.location.href = "Account.html";
            }
        });

        window.nav = (pid) => {
            document.querySelectorAll('.page-section').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
            document.getElementById('page-'+pid).classList.add('active');
            document.getElementById('tab-'+pid).classList.add('active');
            if(pid === 'video') loadVideos();
            if(pid === 'friends') loadRequests();
            if(pid === 'profile') loadMyPosts();
        };

        async function loadFeed() {
            const cont = document.getElementById('news-feed');
            try {
                const q = query(collection(db, "posts"), orderBy("timestamp", "desc"), limit(20));
                const snaps = await getDocs(q);
                let html = "";
                snaps.forEach(doc => html += makePost(doc.data(), doc.id));
                cont.innerHTML = html || "<div style='padding:20px'>No posts yet.</div>";
            } catch (e) { console.log(e); }
        }

        function makePost(p, id) {
            const liked = p.likes && p.likes.includes(currentUser.uid) ? 'liked' : '';
            const likes = p.likes ? p.likes.length : 0;
            let media = "";
            if(p.mediaUrl) {
                if(p.type === 'video') media = `<div class="post-media"><video src="${p.mediaUrl}" controls></video></div>`;
                else media = `<div class="post-media"><img src="${p.mediaUrl}"></div>`;
            }
            return `<div class="post">
                <div class="post-header"><img src="${p.userPic}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;"><div class="post-info"><h4>${p.userName}</h4><span>Just now</span></div></div>
                <div class="post-content">${p.text}</div>${media}
                <div class="post-stats"><span id="l-${id}">${likes} Likes</span><span>Comment</span></div>
                <div class="post-actions"><div class="action-btn ${liked}" id="b-${id}" onclick="window.doLike('${id}')"><i class="fas fa-thumbs-up"></i> Like</div><div class="action-btn"><i class="far fa-comment-alt"></i> Comment</div><div class="action-btn"><i class="fas fa-share"></i> Share</div></div>
            </div>`;
        }

        window.doLike = async (id) => {
            const btn = document.getElementById(`b-${id}`);
            const txt = document.getElementById(`l-${id}`);
            let n = parseInt(txt.innerText);
            if(btn.classList.contains('liked')) {
                btn.classList.remove('liked'); n--;
                updateDoc(doc(db,"posts",id), {likes: arrayRemove(currentUser.uid)});
            } else {
                btn.classList.add('liked'); n++;
                updateDoc(doc(db,"posts",id), {likes: arrayUnion(currentUser.uid)});
            }
            txt.innerText = n + " Likes";
        };

        window.uploadStory = async (inp) => {
            if(!inp.files[0]) return;
            const f = inp.files[0];
            const fd = new FormData(); fd.append('file',f); fd.append('upload_preset',CLOUDINARY_PRESET);
            alert("Uploading Story...");
            try {
                const res = await fetch(CLOUDINARY_URL, {method:'POST', body:fd});
                const d = await res.json();
                const u = (await getDoc(doc(db,"users",currentUser.uid))).data();
                await addDoc(collection(db,"stories"), {
                    uid: currentUser.uid, url: d.secure_url, userName: u.fullName, userPic: u.profilePic, timestamp: new Date().toISOString()
                });
                loadStories();
            } catch(e) { alert("Failed"); }
        };

        async function loadStories() {
            const tray = document.getElementById('story-tray');
            const q = query(collection(db,"stories"), orderBy("timestamp","desc"), limit(10));
            const snaps = await getDocs(q);
            while(tray.children.length > 1) tray.removeChild(tray.lastChild);
            snaps.forEach(d => {
                const s = d.data();
                const div = document.createElement('div');
                div.className = 'story-card';
                div.innerHTML = `<img src="${s.url}"><div class="story-user">${s.userName}</div>`;
                tray.appendChild(div);
            });
        }

        async function loadVideos() {
            const vf = document.getElementById('video-feed');
            if(vf.children.length > 0) return;
            const q = query(collection(db,"posts"), orderBy("timestamp","desc"));
            const snaps = await getDocs(q);
            snaps.forEach(d => {
                const p = d.data();
                if(p.type === 'video') vf.innerHTML += `<div style="margin-bottom:5px; background:black;"><video src="${p.mediaUrl}" controls style="width:100%"></video><div style="padding:10px;color:white"><b>${p.userName}</b><br>${p.text}</div></div>`;
            });
        }

        async function loadRequests() {
            const l = document.getElementById('friend-requests-list');
            const u = (await getDoc(doc(db,"users",currentUser.uid))).data();
            const reqs = u.friendRequests || [];
            l.innerHTML = reqs.length ? "" : "<div style='padding:20px;text-align:center'>No requests</div>";
            reqs.forEach(async id => {
                const f = (await getDoc(doc(db,"users",id))).data();
                l.innerHTML += `<div style="padding:15px;background:white;border-bottom:1px solid #eee;display:flex;align-items:center;gap:10px;" id="r-${id}">
                    <img src="${f.profilePic}" style="width:60px;height:60px;border-radius:50%;object-fit:cover;">
                    <div style="flex:1"><b>${f.fullName}</b><br><button onclick="window.ans('${id}',true)" style="background:#1877f2;color:white;border:none;padding:5px 10px;border-radius:4px;margin-top:5px;">Confirm</button> <button onclick="window.ans('${id}',false)" style="background:#eee;border:none;padding:5px 10px;border-radius:4px;">Delete</button></div>
                </div>`;
            });
        }

        window.ans = async (id, y) => {
            document.getElementById(`r-${id}`).remove();
            await updateDoc(doc(db,"users",currentUser.uid), {friendRequests: arrayRemove(id)});
            if(y) {
                await updateDoc(doc(db,"users",currentUser.uid), {friends: arrayUnion(id)});
                await updateDoc(doc(db,"users",id), {friends: arrayUnion(currentUser.uid)});
            }
        };

        async function loadMyPosts() {
            const c = document.getElementById('my-posts-feed');
            const q = query(collection(db,"posts"), orderBy("timestamp","desc"));
            const s = await getDocs(q);
            c.innerHTML = "";
            s.forEach(d => { if(d.data().uid === currentUser.uid) c.innerHTML += makePost(d.data(), d.id); });
        }

        window.logoutApp = () => signOut(auth).then(() => window.location.href="Account.html");

    </script>
</body>
</html>
