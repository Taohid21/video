<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Messenger Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { --primary: #0084ff; --grad: linear-gradient(135deg, #0084ff 0%, #0060ff 100%); --bg: #fff; --txt: #050505; --gray: #65676b; --red: #ff3b30; --green: #34c759; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background: var(--bg); color: var(--txt); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .av { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; flex-shrink: 0; background: #eee; }
        .av.xl { width: 100px; height: 100px; border: 4px solid rgba(255,255,255,0.2); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        #view-ib { width: 100%; height: 100%; display: flex; flex-direction: column; background: var(--bg); z-index: 10; }
        .head { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); z-index: 20; border-bottom: 1px solid #f0f0f0; }
        .tt { font-size: 26px; font-weight: 700; background: var(--grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .lst { flex: 1; overflow-y: auto; }
        .itm { display: flex; align-items: center; padding: 12px 20px; gap: 15px; cursor: pointer; transition: 0.2s; }
        .itm:active { background: #f5f5f5; }
        .det { flex: 1; border-bottom: 1px solid #f9f9f9; padding-bottom: 12px; }
        .nm { font-weight: 600; font-size: 16px; margin-bottom: 4px; }
        .prv { font-size: 14px; color: var(--gray); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px; }
        .prv.new { font-weight: 700; color: var(--txt); }
        #view-ch { width: 100%; height: 100%; display: none; flex-direction: column; background: var(--bg); position: fixed; top: 0; left: 0; z-index: 20; }
        .ch-h { height: 60px; display: flex; align-items: center; padding: 0 15px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-bottom: 1px solid #eee; justify-content: space-between; }
        .usr { display: flex; align-items: center; gap: 10px; }
        .bk { font-size: 20px; padding: 10px; color: var(--primary); cursor: pointer; }
        .act i { padding: 10px; color: var(--primary); font-size: 20px; cursor: pointer; }
        #msgs { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 2px; background: var(--bg); }
        .row { display: flex; flex-direction: column; max-width: 75%; margin-bottom: 5px; animation: pop 0.2s ease; }
        .row.s { align-self: flex-end; align-items: flex-end; }
        .row.r { align-self: flex-start; align-items: flex-start; }
        .bub { padding: 10px 16px; border-radius: 20px; font-size: 15px; line-height: 1.4; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.05); max-width: 100%; }
        .s .bub { background: var(--grad); color: white; border-bottom-right-radius: 4px; }
        .r .bub { background: #f0f2f5; color: var(--txt); border-bottom-left-radius: 4px; }
        .rep-p { font-size: 11px; margin-bottom: -5px; padding: 4px 10px; background: rgba(0,0,0,0.05); border-left: 3px solid var(--primary); border-radius: 8px 8px 0 0; opacity: 0.7; }
        .foot { padding: 8px 12px; display: flex; align-items: flex-end; gap: 8px; border-top: 1px solid #eee; position: relative; background: #fff; }
        #rep-box { position: absolute; bottom: 100%; left: 0; width: 100%; background: #f0f2f5; padding: 8px; display: none; justify-content: space-between; border-left: 4px solid var(--primary); font-size: 13px; z-index: 5; }
        .ibox { flex: 1; background: #f0f2f5; border-radius: 24px; padding: 10px 15px; display: flex; align-items: center; }
        .in { border: none; background: transparent; width: 100%; max-height: 100px; resize: none; font-size: 15px; }
        .icn { font-size: 22px; color: var(--primary); padding: 8px; cursor: pointer; }
        #ctx { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.2); z-index: 100; display: none; align-items: center; justify-content: center; }
        .c-box { background: white; width: 200px; border-radius: 12px; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
        .c-i { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; gap: 10px; }
        #call-ui { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, #1a2a3a 0%, #000 100%); z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: space-between; padding: 60px 20px 40px; color: white; }
        .pulse { position: absolute; width: 100px; height: 100px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.5); animation: png 1.5s infinite; z-index: -1; }
        .tm { font-size: 24px; font-weight: 500; margin-top: 10px; }
        .acts { width: 100%; display: flex; justify-content: space-evenly; align-items: center; }
        .btn { width: 65px; height: 65px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: 0.2s; }
        .btn:active { transform: scale(0.9); }
        .b-r { background: var(--red); color: white; }
        .b-g { background: var(--green); color: white; animation: bnc 1s infinite; }
        .b-s { background: rgba(255,255,255,0.2); color: white; width: 50px; height: 50px; font-size: 18px; }
        .b-s.on { background: white; color: black; }
        @keyframes pop { from{opacity:0;transform:scale(0.9);} to{opacity:1;transform:scale(1);} }
        @keyframes png { 75%, 100% { transform: scale(2); opacity: 0; } }
        @keyframes bnc { 50% {transform:translateY(-10px);} }
    </style>
</head>
<body>

    <div id="load" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#fff;z-index:999;display:flex;justify-content:center;align-items:center;">
        <i class="fas fa-circle-notch fa-spin" style="color:#0084ff;font-size:30px;"></i>
    </div>

    <div id="view-ib">
        <div class="head">
            <span class="tt">Chats</span>
            <div class="av" style="width:35px;height:35px;display:flex;justify-content:center;align-items:center;cursor:pointer;" onclick="location.reload()"><i class="fas fa-sync-alt" style="font-size:14px;color:#666"></i></div>
        </div>
        <div class="lst" id="clist"></div>
        <div style="position:fixed;bottom:25px;right:25px;width:55px;height:55px;background:var(--grad);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-size:22px;box-shadow:0 5px 15px rgba(0,132,255,0.4);" onclick="openF()">
            <i class="fas fa-pen"></i>
        </div>
    </div>

    <div id="f-mod" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#fff;z-index:50;flex-direction:column;">
        <div class="head">
            <span class="nm">New Message</span>
            <span style="color:var(--primary);cursor:pointer;" onclick="document.getElementById('f-mod').style.display='none'">Cancel</span>
        </div>
        <div class="lst" id="flist"></div>
    </div>

    <div id="view-ch">
        <div class="ch-h">
            <div class="usr">
                <i class="fas fa-chevron-left bk" onclick="closeC()"></i>
                <img id="c-img" class="av" style="width:38px;height:38px;">
                <div>
                    <div id="c-nm" class="nm" style="font-size:15px;">User</div>
                    <div style="font-size:11px;color:var(--green);">Active now</div>
                </div>
            </div>
            <div class="act"><i class="fas fa-phone-alt" onclick="doCall()"></i></div>
        </div>
        <div id="msgs"></div>
        <div class="foot">
            <div id="rep-box"><span id="rep-t">Replying...</span><i class="fas fa-times" onclick="noRep()"></i></div>
            <i class="fas fa-plus-circle icn" onclick="document.getElementById('fin').click()"></i>
            <input type="file" id="fin" hidden onchange="upFile(this)">
            <div class="ibox"><textarea id="in-txt" class="in" rows="1" placeholder="Message..." oninput="rez(this)"></textarea></div>
            <i class="fas fa-paper-plane icn" onclick="snd()"></i>
        </div>
    </div>

    <div id="ctx" onclick="this.style.display='none'">
        <div class="c-box" onclick="event.stopPropagation()">
            <div class="c-i" onclick="exeRep()"><i class="fas fa-reply"></i> Reply</div>
            <div class="c-i" onclick="exeCp()"><i class="fas fa-copy"></i> Copy</div>
        </div>
    </div>

    <div id="call-ui">
        <div style="display:flex;flex-direction:column;align-items:center;margin-top:40px;">
            <div style="position:relative;"><div class="pulse" id="pul"></div><img id="cl-img" class="av xl"></div>
            <div id="cl-nm" style="font-size:26px;font-weight:700;margin-top:15px;">User</div>
            <div id="cl-st" style="opacity:0.7;margin-top:5px;">Calling...</div>
            <div id="cl-tm" class="tm" style="display:none;">00:00</div>
        </div>
        <audio id="rem-aud" autoplay playsinline></audio>
        <div class="acts">
            <div class="btn b-s" id="b-mt" style="display:none;" onclick="tMute()"><i class="fas fa-microphone-slash"></i></div>
            <div class="btn b-r" onclick="endC()"><i class="fas fa-phone-slash"></i></div>
            <div class="btn b-g" id="b-ans" style="display:none;" onclick="ansC()"><i class="fas fa-phone"></i></div>
            <div class="btn b-s" id="b-sp" style="display:none;" onclick="tSpk()"><i class="fas fa-volume-up"></i></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, orderBy, addDoc, onSnapshot, where, setDoc, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const cfg = { apiKey: "AIzaSyD_HBGuQSh_GzqrHqHbgdaoBikLZsK3Qqs", authDomain: "new-all-f99f7.firebaseapp.com", projectId: "new-all-f99f7", storageBucket: "new-all-f99f7.appspot.com", messagingSenderId: "1069748173900", appId: "1:1069748173900:web:158d6336c0f4628133c8e9" };
        const C_URL = "https://api.cloudinary.com/v1_1/dwgvvzbvn/auto/upload";
        const C_PRE = "storyapp";

        const app = initializeApp(cfg);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let me, cid, oUser, sMsg, repTo, pc, lStrm, cDid, cInt, sec = 0;
        const srv = { iceServers: [{ urls: ['stun:stun1.l.google.com:19302'] }] };

        const snd_out = new Audio('https://upload.wikimedia.org/wikipedia/commons/e/ea/Dial_tone_us.ogg'); 
        snd_out.loop = true;
        const snd_in = new Audio('https://upload.wikimedia.org/wikipedia/commons/6/6c/G_major.ogg'); 
        snd_in.loop = true;
        const snd_msg = new Audio('https://upload.wikimedia.org/wikipedia/commons/2/22/Pop_cork.ogg');

        onAuthStateChanged(auth, async (u) => {
            if(u) {
                me = u;
                document.getElementById('load').style.display = 'none';
                ldIb();
                lsnCall();
            } else location.href = "Account.html";
        });

        window.rez = (e) => { e.style.height='auto'; e.style.height=e.scrollHeight+'px'; }

        function ldIb() {
            onSnapshot(query(collection(db, "chats"), where("users", "array-contains", me.uid)), (s) => {
                const l = document.getElementById('clist'); l.innerHTML = "";
                let d = []; s.forEach(x => d.push({id:x.id, ...x.data()}));
                d.sort((a,b)=>(b.lastMsgTime?.toMillis()||0)-(a.lastMsgTime?.toMillis()||0));
                d.forEach(c => {
                    const oid = c.users.find(i => i !== me.uid);
                    const inf = c.userInfo?.[oid] || {name:"Unknown",pic:""};
                    const cls = (c.lastMsgSender!==me.uid && !c.seen) ? 'new' : '';
                    l.innerHTML += `<div class="itm" onclick="goChat('${oid}')"><img src="${inf.pic}" class="av"><div class="det"><div class="nm">${inf.name}</div><div class="prv ${cls}">${c.lastMsgSender===me.uid?'You: ':''}${c.lastMsg}</div></div></div>`;
                });
            });
        }

        window.openF = async () => {
            document.getElementById('f-mod').style.display = 'flex';
            const l = document.getElementById('flist'); l.innerHTML = 'Loading...';
            const f = (await getDoc(doc(db,"users",me.uid))).data().friends || [];
            l.innerHTML = "";
            for(const id of f) {
                const u = (await getDoc(doc(db,"users",id))).data();
                l.innerHTML += `<div class="itm" onclick="goChat('${id}');document.getElementById('f-mod').style.display='none'"><img src="${u.profilePic}" class="av"><div class="det"><div class="nm">${u.fullName}</div></div></div>`;
            }
        }

        window.goChat = async (uid) => {
            document.getElementById('view-ib').style.display = 'none';
            document.getElementById('view-ch').style.display = 'flex';
            const u = (await getDoc(doc(db,"users",uid))).data();
            oUser = {uid, name:u.fullName, pic:u.profilePic};
            document.getElementById('c-nm').innerText = u.fullName;
            document.getElementById('c-img').src = u.profilePic;
            cid = me.uid<uid ? `${me.uid}_${uid}` : `${uid}_${me.uid}`;
            setDoc(doc(db,"chats",cid), {seen:true}, {merge:true});
            onSnapshot(query(collection(db,"chats",cid,"messages"), orderBy("time","asc")), (s) => {
                const a = document.getElementById('msgs'); a.innerHTML = "";
                s.docChanges().forEach(c => {
                    if(c.type==='added' && document.getElementById('view-ch').style.display==='flex' && c.doc.data().sender!==me.uid) snd_msg.play();
                });
                s.forEach(d => rMsg(d.data(), d.id, a));
                a.scrollTop = a.scrollHeight;
            });
        }

        function rMsg(m, id, a) {
            const me_ = m.sender === me.uid;
            let c = m.type==='text' ? `<div class="bub">${m.replyTo?`<div class="rep-p">${m.replyTo}</div>`:''}${m.txt}</div>` : `<img src="${m.url}" style="width:100%;border-radius:15px;" onclick="window.open('${m.url}')">`;
            const d = document.createElement('div'); d.className = `row ${me_?'s':'r'}`; d.innerHTML = c;
            d.oncontextmenu = (e) => { e.preventDefault(); sMsg={txt:m.txt||'Media',id}; document.getElementById('ctx').style.display='flex'; };
            a.appendChild(d);
        }

        window.exeRep = () => { repTo = sMsg.txt; document.getElementById('rep-box').style.display='flex'; document.getElementById('rep-t').innerText=repTo; document.getElementById('ctx').style.display='none'; }
        window.exeCp = () => { navigator.clipboard.writeText(sMsg.txt); document.getElementById('ctx').style.display='none'; }
        window.noRep = () => { repTo=null; document.getElementById('rep-box').style.display='none'; }
        
        window.snd = async () => {
            const el = document.getElementById('in-txt'); const t = el.value.trim();
            if(!t) return; el.value=''; el.style.height='auto';
            const d = {sender:me.uid, txt:t, type:'text', time:serverTimestamp(), replyTo:repTo};
            noRep(); await psM(d);
        }

        window.upFile = async (e) => {
            if(e.files[0]) {
                const fd = new FormData(); fd.append('file',e.files[0]); fd.append('upload_preset',C_PRE);
                const r = await fetch(C_URL,{method:'POST',body:fd}); const d = await r.json();
                await psM({sender:me.uid, type:'image', url:d.secure_url, time:serverTimestamp()});
            }
        }

        async function psM(d) {
            await addDoc(collection(db,"chats",cid,"messages"), d);
            const mi = (await getDoc(doc(db,"users",me.uid))).data();
            await setDoc(doc(db,"chats",cid), {users:[me.uid,oUser.uid], lastMsg:d.type==='text'?d.txt:'Image', lastMsgSender:me.uid, lastMsgTime:serverTimestamp(), seen:false, userInfo:{[me.uid]:{name:mi.fullName,pic:mi.profilePic},[oUser.uid]:{name:oUser.name,pic:oUser.pic}}}, {merge:true});
        }

        window.closeC = () => { document.getElementById('view-ch').style.display='none'; document.getElementById('view-ib').style.display='flex'; cid=null; }

        function upCUI(s) {
            const p=document.getElementById('pul'), st=document.getElementById('cl-st'), tm=document.getElementById('cl-tm');
            const ab=document.getElementById('b-ans'), mb=document.getElementById('b-mt'), sb=document.getElementById('b-sp');
            if(s==='ing' || s==='inc') {
                p.style.animation='png 1.5s infinite'; st.style.display='block'; tm.style.display='none'; mb.style.display='none'; sb.style.display='none';
                if(s==='inc') ab.style.display='flex';
            } else {
                p.style.animation='none'; p.style.border='2px solid #34c759'; st.style.display='none'; tm.style.display='block'; mb.style.display='flex'; sb.style.display='flex'; ab.style.display='none';
                snd_in.pause(); snd_out.pause();
                sec=0; if(cInt) clearInterval(cInt); cInt=setInterval(()=>{sec++; let m=Math.floor(sec/60), s=sec%60; tm.innerText=`${m}:${s<10?'0':''}${s}`;},1000);
            }
        }

        window.doCall = async () => {
            document.getElementById('call-ui').style.display='flex';
            document.getElementById('cl-nm').innerText=oUser.name; document.getElementById('cl-img').src=oUser.pic;
            document.getElementById('cl-st').innerText='Calling...';
            snd_out.currentTime=0; snd_out.play();
            upCUI('ing');

            cDid = doc(collection(db,"calls")).id;
            pc = new RTCPeerConnection(srv);
            lStrm = await navigator.mediaDevices.getUserMedia({audio:true});
            lStrm.getTracks().forEach(t=>pc.addTrack(t,lStrm));
            
            pc.onicecandidate = e => { if(e.candidate) addDoc(collection(db,"calls",cDid,"oCan"), e.candidate.toJSON()); };
            pc.ontrack = e => document.getElementById('rem-aud').srcObject=e.streams[0];
            
            const off = await pc.createOffer(); await pc.setLocalDescription(off);
            await setDoc(doc(db,"calls",cDid), {caller:me.uid, rec:oUser.uid, offer:{type:off.type,sdp:off.sdp}, st:'ring'});
            
            onSnapshot(doc(db,"calls",cDid), d => {
                const v = d.data(); if(!v) return;
                if(v.ans && !pc.currentRemoteDescription) { pc.setRemoteDescription(new RTCSessionDescription(v.ans)); upCUI('con'); }
                if(v.st==='end') endL();
            });
            onSnapshot(collection(db,"calls",cDid,"aCan"), s => s.docChanges().forEach(c=>{ if(c.type==='added') pc.addIceCandidate(new RTCIceCandidate(c.doc.data())); }));
        }

        function lsnCall() {
            onSnapshot(query(collection(db,"calls"), where("rec","==",me.uid), where("st","==","ring")), async s => {
                s.docChanges().forEach(async c => {
                    if(c.type==='added') {
                        cDid = c.doc.id;
                        const d = c.doc.data();
                        const u = (await getDoc(doc(db,"users",d.caller))).data();
                        document.getElementById('call-ui').style.display='flex';
                        document.getElementById('cl-nm').innerText=u.fullName; document.getElementById('cl-img').src=u.profilePic;
                        document.getElementById('cl-st').innerText='Incoming Call...';
                        snd_in.currentTime=0; snd_in.play();
                        upCUI('inc');
                    }
                });
            });
            onSnapshot(query(collection(db,"calls"), where("rec","==",me.uid)), s => s.docChanges().forEach(c => { if(c.type==='modified' && c.doc.data().st==='end') endL(); }));
        }

        window.ansC = async () => {
            pc = new RTCPeerConnection(srv);
            lStrm = await navigator.mediaDevices.getUserMedia({audio:true});
            lStrm.getTracks().forEach(t=>pc.addTrack(t,lStrm));
            pc.ontrack = e => document.getElementById('rem-aud').srcObject=e.streams[0];
            pc.onicecandidate = e => { if(e.candidate) addDoc(collection(db,"calls",cDid,"aCan"), e.candidate.toJSON()); };
            
            const d = (await getDoc(doc(db,"calls",cDid))).data();
            await pc.setRemoteDescription(new RTCSessionDescription(d.offer));
            const ans = await pc.createAnswer(); await pc.setLocalDescription(ans);
            
            await updateDoc(doc(db,"calls",cDid), {ans:{type:ans.type,sdp:ans.sdp}, st:'con'});
            upCUI('con');
            onSnapshot(collection(db,"calls",cDid,"oCan"), s => s.docChanges().forEach(c=>{ if(c.type==='added') pc.addIceCandidate(new RTCIceCandidate(c.doc.data())); }));
        }

        window.endC = async () => { if(cDid) await updateDoc(doc(db,"calls",cDid), {st:'end'}); endL(); }
        function endL() {
            document.getElementById('call-ui').style.display='none';
            if(pc) { pc.close(); pc=null; }
            if(lStrm) { lStrm.getTracks().forEach(t=>t.stop()); lStrm=null; }
            if(cInt) clearInterval(cInt);
            snd_in.pause(); snd_out.pause();
            cDid=null; document.getElementById('cl-tm').innerText="00:00";
        }

        window.tMute = () => { if(lStrm) { lStrm.getAudioTracks()[0].enabled = !lStrm.getAudioTracks()[0].enabled; document.getElementById('b-mt').classList.toggle('on'); } }
        window.tSpk = () => { document.getElementById('b-sp').classList.toggle('on'); }

    </script>
</body>
</html>
