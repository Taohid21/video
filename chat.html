<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Messenger Ultra</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { --p: #0084ff; --g: linear-gradient(135deg, #0084ff, #0060ff); --bg: #fff; --t: #050505; --bub-s: #0084ff; --bub-r: #f0f0f0; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background: var(--bg); color: var(--t); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .h { padding: 15px; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.95); border-bottom: 1px solid #eee; z-index: 20; }
        .tt { font-size: 26px; font-weight: 700; background: var(--g); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .lst { flex: 1; overflow-y: auto; }
        .itm { display: flex; align-items: center; padding: 12px 15px; gap: 12px; cursor: pointer; }
        .itm:active { background: #f5f5f5; }
        .av { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background: #eee; flex-shrink: 0; }
        .nm { font-weight: 600; font-size: 16px; }
        .sub { font-size: 14px; color: #65676b; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 250px; }
        .sub.b { font-weight: 700; color: #000; }
        #v-ch { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 30; display: none; flex-direction: column; }
        .ch-h { height: 60px; display: flex; align-items: center; padding: 0 10px; border-bottom: 1px solid #eee; justify-content: space-between; background: #fff; }
        .u-bx { display: flex; align-items: center; gap: 10px; }
        .act i { font-size: 20px; color: var(--p); padding: 10px; cursor: pointer; }
        #msgs { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 4px; }
        .r { display: flex; flex-direction: column; max-width: 75%; margin-bottom: 2px; }
        .r.s { align-self: flex-end; align-items: flex-end; }
        .r.r { align-self: flex-start; align-items: flex-start; }
        .bub { padding: 8px 14px; border-radius: 18px; font-size: 15px; word-wrap: break-word; }
        .s .bub { background: var(--bub-s); color: #fff; border-bottom-right-radius: 4px; }
        .r .bub { background: var(--bub-r); color: #000; border-bottom-left-radius: 4px; }
        .m-im, .m-vd { width: 100%; border-radius: 12px; margin-top: 5px; border: 1px solid #eee; }
        .m-au { height: 40px; margin-top: 5px; border-radius: 20px; max-width: 220px; }
        .ft { padding: 8px; display: flex; align-items: center; gap: 8px; border-top: 1px solid #eee; background: #fff; }
        .bx { flex: 1; background: #f0f2f5; border-radius: 20px; padding: 8px 12px; display: flex; }
        .in { border: none; background: transparent; width: 100%; font-size: 15px; }
        .ic { font-size: 22px; color: var(--p); padding: 6px; cursor: pointer; }
        .m-on { color: red !important; animation: pl 1s infinite; }
        #c-ui { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, #1e3c72, #000); z-index: 9999; display: none; flex-direction: column; align-items: center; padding-top: 60px; color: #fff; }
        .c-p { position: relative; margin-bottom: 20px; }
        .c-av { width: 110px; height: 110px; border-radius: 50%; border: 4px solid rgba(255,255,255,0.2); }
        .pl { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; border: 2px solid rgba(255,255,255,0.5); animation: pg 1.5s infinite; }
        .tm { font-size: 20px; font-weight: 500; margin-top: 10px; display: none; }
        .bts { position: absolute; bottom: 50px; width: 100%; display: flex; justify-content: space-evenly; align-items: center; }
        .bt { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; background: rgba(255,255,255,0.2); transition: 0.2s; }
        .bt:active { transform: scale(0.9); }
        .br { background: #ff3b30; }
        .bg { background: #34c759; animation: bn 1s infinite; }
        .bs { width: 50px; height: 50px; font-size: 20px; }
        .bs.a { background: #fff; color: #000; }
        @keyframes pl { 0%{opacity:1} 50%{opacity:0.5} 100%{opacity:1} }
        @keyframes pg { 75%,100%{transform:scale(1.8);opacity:0} }
        @keyframes bn { 50%{transform:translateY(-10px)} }
    </style>
</head>
<body>
    <div id="ld" style="position:fixed;width:100%;height:100%;background:#fff;z-index:9999;display:flex;justify-content:center;align-items:center;"><i class="fas fa-circle-notch fa-spin" style="color:var(--p);font-size:30px;"></i></div>

    <div id="v-ib">
        <div class="h"><span class="tt">Chats</span><img src="https://via.placeholder.com/30" class="av" style="width:30px;height:30px;" onclick="location.reload()"></div>
        <div class="lst" id="cl"></div>
        <div style="position:fixed;bottom:20px;right:20px;width:55px;height:55px;background:var(--p);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:22px;box-shadow:0 4px 10px rgba(0,0,0,0.3);" onclick="oFr()"><i class="fas fa-edit"></i></div>
    </div>

    <div id="md" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#fff;z-index:40;flex-direction:column;">
        <div class="h"><span class="nm">New Message</span><span style="color:var(--p);cursor:pointer;" onclick="document.getElementById('md').style.display='none'">Cancel</span></div>
        <div class="lst" id="fl"></div>
    </div>

    <div id="v-ch">
        <div class="ch-h">
            <div class="u-bx"><i class="fas fa-arrow-left" style="font-size:20px;color:var(--p);padding:5px;cursor:pointer;" onclick="xCh()"></i><img id="c-im" class="av"><div class="nm" id="c-nm">User</div></div>
            <div class="act"><i class="fas fa-phone-alt" onclick="goC()"></i><i class="fas fa-video"></i></div>
        </div>
        <div id="msgs"></div>
        <div class="ft">
            <i class="fas fa-image ic" onclick="document.getElementById('fi').click()"></i><input type="file" id="fi" hidden onchange="uF(this)">
            <div class="bx"><input id="tx" class="in" placeholder="Message..." onkeyup="kT(this)"></div>
            <i class="fas fa-microphone ic" id="mb" onclick="rec()"></i><i class="fas fa-paper-plane ic" id="sb" style="display:none" onclick="sn()"></i>
        </div>
    </div>

    <div id="c-ui">
        <div class="c-p"><div class="pl" id="pl"></div><img id="cl-im" class="c-av"></div>
        <div id="cl-nm" style="font-size:24px;font-weight:700;margin-bottom:5px;">User</div>
        <div id="cl-st" style="opacity:0.8;">Calling...</div>
        <div id="tm" class="tm">00:00</div>
        <audio id="rm" autoplay playsinline></audio>
        <div class="bts">
            <div class="bt bs" id="bm" style="display:none" onclick="tM()"><i class="fas fa-microphone-slash"></i></div>
            <div class="bt br" onclick="eC()"><i class="fas fa-phone-slash"></i></div>
            <div class="bt bg" id="ba" style="display:none" onclick="aC()"><i class="fas fa-phone"></i></div>
            <div class="bt bs" id="bs" style="display:none" onclick="tS()"><i class="fas fa-volume-up"></i></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, orderBy, addDoc, onSnapshot, where, setDoc, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const app = initializeApp({ apiKey: "AIzaSyD_HBGuQSh_GzqrHqHbgdaoBikLZsK3Qqs", authDomain: "new-all-f99f7.firebaseapp.com", projectId: "new-all-f99f7", storageBucket: "new-all-f99f7.appspot.com", messagingSenderId: "1069748173900", appId: "1:1069748173900:web:158d6336c0f4628133c8e9" });
        const db=getFirestore(app), auth=getAuth(app);
        const CU="https://api.cloudinary.com/v1_1/dwgvvzbvn/auto/upload", CP="storyapp";
        
        let me, cid, ou, pc, ls, cd, mr, ach=[], tmI, sc=0;
        const srv={iceServers:[{urls:['stun:stun1.l.google.com:19302']}]};
        const so=new Audio('https://www.soundjay.com/phone/telephone-ring-03a.mp3'); so.loop=true;
        const si=new Audio('https://www.soundjay.com/phone/phone-calling-1.mp3'); si.loop=true;

        onAuthStateChanged(auth, u=>{
            if(u){ me=u; document.getElementById('ld').style.display='none'; lI(); lC(); }
            else location.href="Account.html";
        });

        function lI(){
            onSnapshot(query(collection(db,"chats"),where("users","array-contains",me.uid)), s=>{
                const l=document.getElementById('cl'); l.innerHTML="";
                let d=[]; s.forEach(x=>d.push({id:x.id,...x.data()}));
                d.sort((a,b)=>(b.lastMsgTime?.toMillis()||0)-(a.lastMsgTime?.toMillis()||0));
                d.forEach(c=>{
                    const o=c.users.find(i=>i!==me.uid), i=c.userInfo?.[o]||{name:"User",pic:""};
                    let t=c.lastMsg; if(c.lastMsgType==='image')t='Sent a photo'; if(c.lastMsgType==='audio')t='Sent a voice message';
                    l.innerHTML+=`<div class="itm" onclick="sC('${o}')"><img src="${i.pic}" class="av"><div><div class="nm">${i.name}</div><div class="sub ${c.lastMsgSender!==me.uid&&!c.seen?'b':''}">${c.lastMsgSender===me.uid?'You: ':''}${t}</div></div></div>`;
                });
            });
        }

        window.oFr=async()=>{
            document.getElementById('md').style.display='flex';
            const l=document.getElementById('fl'); l.innerHTML='Loading...';
            const f=(await getDoc(doc(db,"users",me.uid))).data().friends||[];
            l.innerHTML="";
            for(const id of f){
                const u=(await getDoc(doc(db,"users",id))).data();
                l.innerHTML+=`<div class="itm" onclick="sC('${id}');document.getElementById('md').style.display='none'"><img src="${u.profilePic}" class="av"><div class="nm">${u.fullName}</div></div>`;
            }
        }

        window.sC=async(id)=>{
            document.getElementById('v-ib').style.display='none';
            document.getElementById('v-ch').style.display='flex';
            const u=(await getDoc(doc(db,"users",id))).data();
            ou={id,name:u.fullName,pic:u.profilePic};
            document.getElementById('c-nm').innerText=ou.name; document.getElementById('c-im').src=ou.pic;
            cid=me.uid<id?`${me.uid}_${id}`:`${id}_${me.uid}`;
            setDoc(doc(db,"chats",cid),{seen:true},{merge:true});
            onSnapshot(query(collection(db,"chats",cid,"messages"),orderBy("time","asc")), s=>{
                const a=document.getElementById('msgs'); a.innerHTML="";
                s.forEach(d=>rM(d.data(),a)); a.scrollTop=a.scrollHeight;
            });
        }

        function rM(m,a){
            let c=`<div class="bub">${m.txt}</div>`;
            if(m.type==='image')c=`<img src="${m.url}" class="m-im" onclick="window.open('${m.url}')">`;
            if(m.type==='video')c=`<video src="${m.url}" controls class="m-vd"></video>`;
            if(m.type==='audio')c=`<audio src="${m.url}" controls class="m-au"></audio>`;
            a.innerHTML+=`<div class="r ${m.sender===me.uid?'s':'r'}">${c}</div>`;
        }

        window.kT=e=>{ const h=e.value.trim().length>0; document.getElementById('sb').style.display=h?'block':'none'; document.getElementById('mb').style.display=h?'none':'block'; }
        window.sn=async()=>{ const i=document.getElementById('tx'), t=i.value.trim(); if(!t)return; i.value=""; kT(i); await pM({sender:me.uid,txt:t,type:'text',time:serverTimestamp()}); }
        window.uF=async(e)=>{ if(e.files[0]){ const f=e.files[0], ty=f.type.startsWith('video')?'video':'image', fd=new FormData(); fd.append('file',f); fd.append('upload_preset',CP); const r=await fetch(CU,{method:'POST',body:fd}), d=await r.json(); await pM({sender:me.uid,type:ty,url:d.secure_url,time:serverTimestamp()}); } }
        
        window.rec=async()=>{
            const b=document.getElementById('mb');
            if(!mr||mr.state==='inactive'){
                const s=await navigator.mediaDevices.getUserMedia({audio:true}); mr=new MediaRecorder(s); ach=[];
                mr.ondataavailable=e=>ach.push(e.data);
                mr.onstop=async()=>{
                    const fd=new FormData(); fd.append('file',new Blob(ach,{type:'audio/webm'})); fd.append('upload_preset',CP);
                    const r=await fetch(CU,{method:'POST',body:fd}), d=await r.json();
                    await pM({sender:me.uid,type:'audio',url:d.secure_url,time:serverTimestamp()}); s.getTracks().forEach(t=>t.stop());
                }; mr.start(); b.classList.add('m-on');
            } else { mr.stop(); b.classList.remove('m-on'); }
        }

        async function pM(d){ await addDoc(collection(db,"chats",cid,"messages"),d); const i=(await getDoc(doc(db,"users",me.uid))).data(); await setDoc(doc(db,"chats",cid),{users:[me.uid,ou.id],lastMsg:d.txt||'Media',lastMsgType:d.type,lastMsgSender:me.uid,lastMsgTime:serverTimestamp(),seen:false,userInfo:{[me.uid]:{name:i.fullName,pic:i.profilePic},[ou.id]:{name:ou.name,pic:ou.pic}}},{merge:true}); }
        window.xCh=()=>{ document.getElementById('v-ch').style.display='none'; document.getElementById('v-ib').style.display='flex'; }

        function uUI(s){
            const pl=document.getElementById('pl'), st=document.getElementById('cl-st'), tm=document.getElementById('tm'), ba=document.getElementById('ba'), bm=document.getElementById('bm'), bs=document.getElementById('bs');
            if(s==='r'||s==='i'){ pl.style.animation='pg 1.5s infinite'; st.style.display='block'; tm.style.display='none'; bm.style.display='none'; bs.style.display='none'; if(s==='i')ba.style.display='flex'; }
            else { pl.style.animation='none'; pl.style.border='2px solid #34c759'; st.style.display='none'; tm.style.display='block'; bm.style.display='flex'; bs.style.display='flex'; ba.style.display='none'; si.pause(); so.pause(); sT(); }
        }

        function sT(){ sc=0; if(tmI)clearInterval(tmI); tmI=setInterval(()=>{ sc++; let m=Math.floor(sc/60), s=sc%60; document.getElementById('tm').innerText=`${m}:${s<10?'0':''}${s}`; },1000); }

        window.goC=async()=>{
            document.getElementById('c-ui').style.display='flex'; document.getElementById('cl-nm').innerText=ou.name; document.getElementById('cl-im').src=ou.pic; document.getElementById('cl-st').innerText="Calling...";
            so.currentTime=0; so.play().catch(()=>{}); uUI('r');
            cd=doc(collection(db,"calls")).id; pc=new RTCPeerConnection(srv);
            ls=await navigator.mediaDevices.getUserMedia({audio:true}); ls.getTracks().forEach(t=>pc.addTrack(t,ls));
            pc.ontrack=e=>document.getElementById('rm').srcObject=e.streams[0];
            pc.onicecandidate=e=>{if(e.candidate)addDoc(collection(db,"calls",cd,"oc"),e.candidate.toJSON())};
            const o=await pc.createOffer(); await pc.setLocalDescription(o);
            await setDoc(doc(db,"calls",cd),{c:me.uid,r:ou.id,o:{type:o.type,sdp:o.sdp},st:'ring'});
            onSnapshot(doc(db,"calls",cd),d=>{ const v=d.data(); if(v?.a&&!pc.currentRemoteDescription){pc.setRemoteDescription(new RTCSessionDescription(v.a));uUI('c');} if(v?.st==='end')eL(); });
            onSnapshot(collection(db,"calls",cd,"ac"),s=>s.docChanges().forEach(c=>{if(c.type==='added')pc.addIceCandidate(new RTCIceCandidate(c.doc.data()))}));
        }

        function lC(){
            onSnapshot(query(collection(db,"calls"),where("r","==",me.uid),where("st","==","ring")),async s=>{
                s.docChanges().forEach(async c=>{
                    if(c.type==='added'){
                        cd=c.doc.id; const d=c.doc.data(), u=(await getDoc(doc(db,"users",d.c))).data();
                        document.getElementById('c-ui').style.display='flex'; document.getElementById('cl-nm').innerText=u.fullName; document.getElementById('cl-im').src=u.profilePic; document.getElementById('cl-st').innerText="Incoming Call...";
                        si.currentTime=0; si.play().catch(()=>{}); uUI('i');
                    }
                });
            });
            onSnapshot(query(collection(db,"calls"),where("r","==",me.uid)),s=>s.docChanges().forEach(c=>{if(c.type==='modified'&&c.doc.data().st==='end')eL()}));
        }

        window.aC=async()=>{
            pc=new RTCPeerConnection(srv); ls=await navigator.mediaDevices.getUserMedia({audio:true}); ls.getTracks().forEach(t=>pc.addTrack(t,ls));
            pc.ontrack=e=>document.getElementById('rm').srcObject=e.streams[0];
            pc.onicecandidate=e=>{if(e.candidate)addDoc(collection(db,"calls",cd,"ac"),e.candidate.toJSON())};
            const d=(await getDoc(doc(db,"calls",cd))).data(); await pc.setRemoteDescription(new RTCSessionDescription(d.o));
            const a=await pc.createAnswer(); await pc.setLocalDescription(a);
            await updateDoc(doc(db,"calls",cd),{a:{type:a.type,sdp:a.sdp},st:'con'}); uUI('c');
            onSnapshot(collection(db,"calls",cd,"oc"),s=>s.docChanges().forEach(c=>{if(c.type==='added')pc.addIceCandidate(new RTCIceCandidate(c.doc.data()))}));
        }

        window.eC=async()=>{ if(cd)await updateDoc(doc(db,"calls",cd),{st:'end'}); eL(); }
        function eL(){ document.getElementById('c-ui').style.display='none'; if(pc){pc.close();pc=null;} if(ls){ls.getTracks().forEach(t=>t.stop());ls=null;} so.pause(); si.pause(); if(tmI)clearInterval(tmI); cd=null; }
        window.tM=()=>{ if(ls){ ls.getAudioTracks()[0].enabled=!ls.getAudioTracks()[0].enabled; document.getElementById('bm').classList.toggle('a'); } }
        window.tS=()=>{ document.getElementById('bs').classList.toggle('a'); }
    </script>
</body>
</html>
