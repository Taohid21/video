<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Messenger</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { --bg: #ffffff; --text: #050505; --bubble-sent: #0084ff; --bubble-rec: #e4e6eb; --input-bg: #f0f2f5; }
        body.dark-mode { --bg: #000000; --text: #e4e6eb; --bubble-sent: #0084ff; --bubble-rec: #303030; --input-bg: #1f1f1f; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background-color: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* HEADER */
        .chat-head { height: 60px; display: flex; align-items: center; padding: 0 15px; border-bottom: 1px solid rgba(0,0,0,0.1); flex-shrink: 0; justify-content: space-between; }
        .dark-mode .chat-head { border-color: rgba(255,255,255,0.1); }
        .head-left { display: flex; align-items: center; gap: 10px; }
        .back-btn { font-size: 24px; color: var(--bubble-sent); cursor: pointer; padding: 5px; }
        .u-ava { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #ccc; }
        .u-nm { font-weight: 700; font-size: 17px; }
        .head-act i { font-size: 22px; color: var(--bubble-sent); margin-left: 20px; cursor: pointer; }

        /* INBOX LIST */
        #inbox-view { width: 100%; height: 100%; display: flex; flex-direction: column; position: absolute; background: var(--bg); z-index: 10; }
        .ib-title { font-size: 26px; font-weight: 800; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .ib-list { flex: 1; overflow-y: auto; }
        .ib-item { display: flex; align-items: center; gap: 12px; padding: 12px 15px; cursor: pointer; transition: 0.2s; }
        .ib-item:active { background: rgba(0,0,0,0.05); }
        .ib-det { flex: 1; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 12px; }
        .ib-n { font-weight: 600; font-size: 16px; margin-bottom: 3px; }
        .ib-m { font-size: 13px; color: #65676b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px; }
        .dark-mode .ib-m { color: #b0b3b8; }
        
        /* Floating Button for New Chat */
        .fab { position: fixed; bottom: 20px; right: 20px; width: 55px; height: 55px; background: var(--bubble-sent); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; box-shadow: 0 4px 10px rgba(0,132,255,0.3); cursor: pointer; z-index: 20; }

        /* FRIENDS LIST MODAL */
        #fr-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 30; display: none; flex-direction: column; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from {transform: translateY(100%);} to {transform: translateY(0);} }

        /* CHAT AREA */
        #chat-interface { width: 100%; height: 100%; display: none; flex-direction: column; background: var(--bg); position: absolute; z-index: 15; }
        #msg-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        
        .msg-row { display: flex; flex-direction: column; max-width: 70%; position: relative; }
        .msg-row.sent { align-self: flex-end; align-items: flex-end; }
        .msg-row.rec { align-self: flex-start; align-items: flex-start; }
        
        .msg-bub { padding: 10px 14px; border-radius: 18px; font-size: 15px; line-height: 1.4; word-wrap: break-word; position: relative; }
        .sent .msg-bub { background: var(--bubble-sent); color: white; border-bottom-right-radius: 4px; }
        .rec .msg-bub { background: var(--bubble-rec); color: var(--text); border-bottom-left-radius: 4px; }
        
        /* Media in Chat */
        .msg-img, .msg-vid { width: 100%; max-width: 200px; border-radius: 15px; margin-bottom: 5px; border: 1px solid rgba(0,0,0,0.1); }
        .msg-aud { height: 40px; max-width: 220px; border-radius: 20px; }

        /* INPUT BAR */
        .chat-foot { padding: 8px 10px; display: flex; align-items: center; gap: 10px; border-top: 1px solid rgba(0,0,0,0.1); background: var(--bg); }
        .cf-icon { font-size: 22px; color: var(--bubble-sent); padding: 5px; cursor: pointer; }
        .cf-in-box { flex: 1; background: var(--input-bg); border-radius: 20px; display: flex; align-items: center; padding: 8px 12px; }
        .cf-in { background: transparent; border: none; flex: 1; outline: none; color: var(--text); font-size: 15px; }
        .mic-active { color: red !important; animation: pulse 1s infinite; }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.2);} 100% {transform: scale(1);} }

        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--bg); z-index: 100; display:flex; justify-content:center; align-items:center; }
    </style>
</head>
<body>

    <div id="loader"><i class="fas fa-circle-notch fa-spin" style="color:#0084ff;font-size:30px;"></i></div>

    <!-- INBOX VIEW -->
    <div id="inbox-view">
        <div class="ib-title">
            <span>Chats</span>
            <i class="fas fa-home" style="font-size:22px; color:#0084ff; cursor:pointer;" onclick="location.href='index.html'"></i>
        </div>
        <div class="ib-list" id="chat-list"></div>
        <div class="fab" onclick="openFriends()"><i class="fas fa-edit"></i></div>
    </div>

    <!-- FRIEND SELECTOR -->
    <div id="fr-modal">
        <div class="ib-title">
            <span>New Message</span>
            <span style="font-size:16px; color:#0084ff; cursor:pointer;" onclick="document.getElementById('fr-modal').style.display='none'">Cancel</span>
        </div>
        <div class="ib-list" id="fr-list"></div>
    </div>

    <!-- CHAT INTERFACE -->
    <div id="chat-interface">
        <div class="chat-head">
            <div class="head-left">
                <i class="fas fa-arrow-left back-btn" onclick="closeChat()"></i>
                <img id="c-ava" class="u-ava">
                <div id="c-name" class="u-nm">User</div>
            </div>
            <div class="head-act">
                <i class="fas fa-phone-alt"></i>
                <i class="fas fa-video"></i>
                <i class="fas fa-info-circle"></i>
            </div>
        </div>

        <div id="msg-area"></div>

        <div class="chat-foot">
            <i class="fas fa-image cf-icon" onclick="document.getElementById('media-in').click()"></i>
            <input type="file" id="media-in" hidden accept="image/*,video/*" onchange="uploadMedia(this)">
            
            <div class="cf-in-box">
                <input id="msg-in" class="cf-in" placeholder="Message..." onkeyup="chkTyping(this)">
            </div>
            
            <i class="fas fa-microphone cf-icon" id="mic-btn" onclick="toggleMic()"></i>
            <i class="fas fa-paper-plane cf-icon" id="send-btn" style="display:none;" onclick="sendTxt()"></i>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, orderBy, addDoc, onSnapshot, where, setDoc, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const cfg = { apiKey: "AIzaSyD_HBGuQSh_GzqrHqHbgdaoBikLZsK3Qqs", authDomain: "new-all-f99f7.firebaseapp.com", projectId: "new-all-f99f7", storageBucket: "new-all-f99f7.appspot.com", messagingSenderId: "1069748173900", appId: "1:1069748173900:web:158d6336c0f4628133c8e9" };
        const C_URL = "https://api.cloudinary.com/v1_1/dwgvvzbvn/auto/upload";
        const C_PRE = "storyapp"; // Using same preset for simplicity

        const app = initializeApp(cfg);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let me = null;
        let chatId = null;
        let otherUser = null;
        let unsubMsg = null;
        let mediaRecorder = null;
        let audioChunks = [];

        // Dark Mode Check
        if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');

        onAuthStateChanged(auth, async (u) => {
            if(u) {
                me = u;
                document.getElementById('loader').style.display = 'none';
                
                // Load Inbox List First
                loadInbox();

                // Check URL for Direct Chat
                const urlParams = new URLSearchParams(window.location.search);
                const targetUid = urlParams.get('uid');
                if(targetUid) startChat(targetUid);
            } else {
                location.href = "Account.html";
            }
        });

        // 1. INBOX LOGIC
        function loadInbox() {
            const q = query(collection(db, "chats"), where("users", "array-contains", me.uid), orderBy("lastMsgTime", "desc"));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('chat-list');
                list.innerHTML = "";
                
                if(snap.empty) {
                    list.innerHTML = `
                        <div style="text-align:center; padding:40px 20px;">
                            <div style="font-size:60px; color:#ddd; margin-bottom:10px;"><i class="fab fa-facebook-messenger"></i></div>
                            <h3 style="color:var(--text)">No messages yet</h3>
                            <p style="color:#888; margin-top:5px;">Tap the pencil icon to start chatting with friends.</p>
                        </div>`;
                    return;
                }

                snap.forEach(d => {
                    const data = d.data();
                    const otherId = data.users.find(id => id !== me.uid);
                    // Safeguard if userInfo is missing
                    const info = data.userInfo && data.userInfo[otherId] ? data.userInfo[otherId] : { name: "User", pic: "" };
                    
                    // Format Time
                    let timeStr = "";
                    if(data.lastMsgTime) {
                        const date = data.lastMsgTime.toDate();
                        timeStr = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    }

                    list.innerHTML += `
                        <div class="ib-item" onclick="startChat('${otherId}')">
                            <img src="${info.pic}" class="u-ava">
                            <div class="ib-det">
                                <div style="display:flex; justify-content:space-between;">
                                    <div class="ib-n">${info.name}</div>
                                    <div style="font-size:12px; color:#888;">${timeStr}</div>
                                </div>
                                <div class="ib-m">${data.lastMsg || "Media sent"}</div>
                            </div>
                        </div>
                    `;
                });
            });
        }

        // 2. FRIEND LIST LOGIC (FOR NEW CHAT)
        window.openFriends = async () => {
            document.getElementById('fr-modal').style.display = 'flex';
            const list = document.getElementById('fr-list');
            list.innerHTML = '<div style="padding:20px; text-align:center;">Loading friends...</div>';

            const myDoc = await getDoc(doc(db, "users", me.uid));
            const friends = myDoc.data().friends || [];

            list.innerHTML = "";
            if(friends.length === 0) {
                list.innerHTML = '<div style="padding:20px; text-align:center;">You have no friends yet. Add friends from the main app!</div>';
                return;
            }

            friends.forEach(async fid => {
                const fDoc = await getDoc(doc(db, "users", fid));
                const f = fDoc.data();
                const div = document.createElement('div');
                div.className = 'ib-item';
                div.innerHTML = `<img src="${f.profilePic}" class="u-ava"><div class="ib-n">${f.fullName}</div>`;
                div.onclick = () => {
                    document.getElementById('fr-modal').style.display = 'none';
                    startChat(fid);
                };
                list.appendChild(div);
            });
        }

        // 3. START CHAT LOGIC
        window.startChat = async (uid) => {
            document.getElementById('inbox-view').style.display = 'none';
            document.getElementById('chat-interface').style.display = 'flex';
            document.getElementById('msg-area').innerHTML = '';

            // Fetch info
            const uDoc = await getDoc(doc(db, "users", uid));
            const uData = uDoc.data();
            otherUser = { uid: uid, name: uData.fullName, pic: uData.profilePic };
            
            document.getElementById('c-name').innerText = otherUser.name;
            document.getElementById('c-ava').src = otherUser.pic;

            // Chat ID: Always smaller_bigger
            chatId = me.uid < uid ? `${me.uid}_${uid}` : `${uid}_${me.uid}`;

            // Listen Messages
            const q = query(collection(db, "chats", chatId, "messages"), orderBy("time", "asc"));
            unsubMsg = onSnapshot(q, (snap) => {
                const area = document.getElementById('msg-area');
                area.innerHTML = "";
                snap.forEach(d => {
                    renderMsg(d.data(), area);
                });
                area.scrollTop = area.scrollHeight;
            });
        }

        function renderMsg(m, area) {
            const isMe = m.sender === me.uid;
            const cls = isMe ? 'sent' : 'rec';
            let content = `<div class="msg-bub">${m.txt}</div>`;
            
            if(m.type === 'image') content = `<img src="${m.url}" class="msg-img">`;
            if(m.type === 'video') content = `<video src="${m.url}" controls class="msg-vid"></video>`;
            if(m.type === 'audio') content = `<audio src="${m.url}" controls class="msg-aud"></audio>`;

            area.innerHTML += `<div class="msg-row ${cls}">${content}</div>`;
        }

        // 4. SENDING LOGIC (Text, Media, Voice)
        window.chkTyping = (el) => {
            const sendBtn = document.getElementById('send-btn');
            const micBtn = document.getElementById('mic-btn');
            if(el.value.trim().length > 0) {
                sendBtn.style.display = 'block';
                micBtn.style.display = 'none';
            } else {
                sendBtn.style.display = 'none';
                micBtn.style.display = 'block';
            }
        }

        window.sendTxt = async () => {
            const inp = document.getElementById('msg-in');
            const txt = inp.value.trim();
            if(!txt) return;
            inp.value = "";
            chkTyping(inp);
            await pushMsg(txt, 'text', null);
        }

        // Upload Image/Video
        window.uploadMedia = async (inp) => {
            if(inp.files && inp.files[0]) {
                const file = inp.files[0];
                const type = file.type.startsWith('video') ? 'video' : 'image';
                
                // Show loading placeholder
                const area = document.getElementById('msg-area');
                area.innerHTML += `<div class="msg-row sent"><div class="msg-bub"><i class="fas fa-spinner fa-spin"></i> Sending ${type}...</div></div>`;
                area.scrollTop = area.scrollHeight;

                const fd = new FormData();
                fd.append('file', file);
                fd.append('upload_preset', C_PRE);
                
                try {
                    const r = await fetch(C_URL, {method:'POST', body:fd});
                    const d = await r.json();
                    await pushMsg(type + ' sent', type, d.secure_url);
                } catch(e) { alert('Upload failed'); }
            }
        }

        // Voice Message
        window.toggleMic = async () => {
            const btn = document.getElementById('mic-btn');
            if(!mediaRecorder || mediaRecorder.state === 'inactive') {
                // Start Recording
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = uploadVoice;
                    mediaRecorder.start();
                    btn.classList.add('mic-active');
                } catch(e) { alert('Microphone access denied'); }
            } else {
                // Stop Recording
                mediaRecorder.stop();
                btn.classList.remove('mic-active');
            }
        }

        async function uploadVoice() {
            const blob = new Blob(audioChunks, { type: 'audio/webm' });
            const area = document.getElementById('msg-area');
            area.innerHTML += `<div class="msg-row sent"><div class="msg-bub"><i class="fas fa-spinner fa-spin"></i> Sending voice...</div></div>`;
            area.scrollTop = area.scrollHeight;

            const fd = new FormData();
            fd.append('file', blob);
            fd.append('upload_preset', C_PRE); // Using same preset, cloud will detect as video/raw usually which is fine for audio playback in HTML5
            
            try {
                const r = await fetch(C_URL, {method:'POST', body:fd});
                const d = await r.json();
                await pushMsg('Voice message', 'audio', d.secure_url);
            } catch(e) { alert('Voice upload failed'); }
        }

        // Core Push Message Function
        async function pushMsg(txt, type, url) {
            // 1. Add to Subcollection
            await addDoc(collection(db, "chats", chatId, "messages"), {
                sender: me.uid,
                txt: txt,
                type: type,
                url: url || null,
                time: serverTimestamp()
            });

            // 2. Update Main Chat Doc (Important for Inbox)
            const myInfo = (await getDoc(doc(db, "users", me.uid))).data();
            
            const chatData = {
                users: [me.uid, otherUser.uid],
                lastMsg: txt,
                lastMsgTime: serverTimestamp(),
                userInfo: {
                    [me.uid]: { name: myInfo.fullName, pic: myInfo.profilePic },
                    [otherUser.uid]: { name: otherUser.name, pic: otherUser.pic }
                }
            };

            await setDoc(doc(db, "chats", chatId), chatData, { merge: true });
        }

        window.closeChat = () => {
            if(unsubMsg) unsubMsg();
            document.getElementById('chat-interface').style.display = 'none';
            document.getElementById('inbox-view').style.display = 'flex';
            history.pushState(null, "", "chat.html"); // Clean URL
        }
    </script>
</body>
</html>
