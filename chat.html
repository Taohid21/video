<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Messenger Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { --primary: #0084ff; --grad: linear-gradient(135deg, #0084ff 0%, #0060ff 100%); --bg: #fff; --txt: #050505; --gray: #65676b; --msg-sent: #0084ff; --msg-rec: #f0f0f0; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background: var(--bg); color: var(--txt); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* HEADER & LISTS */
        .app-h { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.95); border-bottom: 1px solid #f0f0f0; z-index: 20; }
        .tt { font-size: 26px; font-weight: 700; background: var(--grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .lst { flex: 1; overflow-y: auto; }
        .itm { display: flex; align-items: center; padding: 12px 20px; gap: 15px; cursor: pointer; transition: 0.2s; }
        .itm:active { background: #f5f5f5; }
        .av { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background: #eee; flex-shrink: 0; }
        .nm { font-weight: 600; font-size: 16px; margin-bottom: 4px; }
        .prv { font-size: 14px; color: var(--gray); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px; }
        .prv.new { font-weight: 700; color: #000; }

        /* CHAT AREA */
        #v-ch { width: 100%; height: 100%; display: none; flex-direction: column; background: #fff; position: fixed; top: 0; left: 0; z-index: 20; }
        .ch-h { height: 60px; display: flex; align-items: center; padding: 0 15px; border-bottom: 1px solid #eee; justify-content: space-between; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); }
        .u-box { display: flex; align-items: center; gap: 10px; }
        .act i { font-size: 22px; color: var(--primary); padding: 10px; cursor: pointer; }
        #msgs { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 5px; }
        
        .row { display: flex; flex-direction: column; max-width: 75%; margin-bottom: 5px; position: relative; }
        .row.s { align-self: flex-end; align-items: flex-end; }
        .row.r { align-self: flex-start; align-items: flex-start; }
        .bub { padding: 10px 16px; border-radius: 20px; font-size: 15px; line-height: 1.4; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .s .bub { background: var(--grad); color: white; border-bottom-right-radius: 4px; }
        .r .bub { background: var(--msg-rec); color: #000; border-bottom-left-radius: 4px; }
        
        /* MEDIA STYLES */
        .m-img, .m-vid { width: 100%; border-radius: 15px; margin-top: 5px; border: 1px solid rgba(0,0,0,0.1); }
        .m-aud { margin-top: 5px; height: 40px; border-radius: 20px; max-width: 220px; }

        /* FOOTER & INPUT */
        .foot { padding: 8px 10px; display: flex; align-items: center; gap: 8px; border-top: 1px solid #eee; position: relative; background: #fff; }
        .ibox { flex: 1; background: #f0f2f5; border-radius: 24px; padding: 8px 15px; display: flex; align-items: center; }
        .in { border: none; background: transparent; width: 100%; max-height: 100px; resize: none; font-size: 15px; }
        .ic { font-size: 22px; color: var(--primary); padding: 8px; cursor: pointer; }
        .mic-on { color: red !important; animation: pulse 1s infinite; }

        /* CALL OVERLAY */
        #v-call { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1a2a3a, #000); z-index: 9999; display: none; flex-direction: column; align-items: center; padding-top: 80px; color: white; }
        .c-av { width: 120px; height: 120px; border-radius: 50%; border: 4px solid rgba(255,255,255,0.2); margin-bottom: 20px; box-shadow: 0 0 30px rgba(0,132,255,0.5); }
        .c-nm { font-size: 28px; font-weight: 700; margin-bottom: 5px; }
        .c-st { font-size: 16px; opacity: 0.8; margin-bottom: 80px; }
        .c-act { display: flex; gap: 40px; align-items: center; }
        .btn { width: 65px; height: 65px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; cursor: pointer; transition: 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .btn:active { transform: scale(0.9); }
        .b-r { background: #ff3b30; color: white; }
        .b-g { background: #34c759; color: white; animation: bounce 1.5s infinite; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    </style>
</head>
<body>

    <div id="load" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#fff;z-index:999;display:flex;justify-content:center;align-items:center;">
        <i class="fas fa-circle-notch fa-spin" style="color:#0084ff;font-size:40px;"></i>
    </div>

    <!-- INBOX -->
    <div id="v-ib" style="width:100%;height:100%;display:flex;flex-direction:column;">
        <div class="app-h">
            <span class="tt">Chats</span>
            <div class="av" style="width:35px;height:35px;display:flex;justify-content:center;align-items:center;cursor:pointer;" onclick="location.reload()"><i class="fas fa-sync"></i></div>
        </div>
        <div class="lst" id="clist"></div>
        <div style="position:fixed;bottom:25px;right:25px;width:60px;height:60px;background:var(--grad);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-size:24px;box-shadow:0 5px 20px rgba(0,132,255,0.4);" onclick="opnFr()"><i class="fas fa-pen"></i></div>
    </div>

    <!-- FRIENDS MODAL -->
    <div id="f-mod" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#fff;z-index:50;flex-direction:column;">
        <div class="app-h"><span class="nm" style="font-size:20px;">New Message</span><span style="color:var(--primary);cursor:pointer;" onclick="document.getElementById('f-mod').style.display='none'">Cancel</span></div>
        <div class="lst" id="flist"></div>
    </div>

    <!-- CHAT INTERFACE -->
    <div id="v-ch">
        <div class="ch-h">
            <div class="u-box">
                <i class="fas fa-arrow-left" style="font-size:22px;color:var(--primary);padding:10px;cursor:pointer;" onclick="clsCh()"></i>
                <img id="c-img" class="av">
                <div><div id="c-nm" class="nm">User</div><div style="font-size:12px;color:green;">Active now</div></div>
            </div>
            <div class="act"><i class="fas fa-phone-alt" onclick="doCall()"></i></div>
        </div>
        <div id="msgs"></div>
        <div class="foot">
            <i class="fas fa-image ic" onclick="document.getElementById('fin').click()"></i>
            <input type="file" id="fin" hidden accept="image/*,video/*" onchange="upFile(this)">
            <div class="ibox"><input id="in-txt" class="in" placeholder="Message..." onkeyup="chkTyp(this)"></div>
            <i class="fas fa-microphone ic" id="mic-btn" onclick="tMic()"></i>
            <i class="fas fa-paper-plane ic" id="snd-btn" style="display:none;color:var(--primary);" onclick="snd()"></i>
        </div>
    </div>

    <!-- CALL OVERLAY -->
    <div id="v-call">
        <img id="cl-img" class="c-av">
        <div id="cl-nm" class="c-nm">User Name</div>
        <div id="cl-st" class="c-st">Calling...</div>
        <audio id="rem-aud" autoplay playsinline></audio>
        <div class="c-act">
            <div class="btn b-r" onclick="endC()"><i class="fas fa-phone-slash"></i></div>
            <div class="btn b-g" id="b-ans" style="display:none;" onclick="ansC()"><i class="fas fa-phone"></i></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, orderBy, addDoc, onSnapshot, where, setDoc, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const cfg = { apiKey: "AIzaSyD_HBGuQSh_GzqrHqHbgdaoBikLZsK3Qqs", authDomain: "new-all-f99f7.firebaseapp.com", projectId: "new-all-f99f7", storageBucket: "new-all-f99f7.appspot.com", messagingSenderId: "1069748173900", appId: "1:1069748173900:web:158d6336c0f4628133c8e9" };
        const C_URL = "https://api.cloudinary.com/v1_1/dwgvvzbvn/auto/upload";
        const C_PRE = "storyapp";

        const app = initializeApp(cfg);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let me, cid, oUser, pc, lStrm, cDid, mRec, aChks=[];
        const srv = { iceServers: [{ urls: ['stun:stun1.l.google.com:19302'] }] };
        
        // RINGTONES
        const s_out = new Audio('https://www.soundjay.com/phone/telephone-ring-03a.mp3'); 
        s_out.loop = true;
        const s_in = new Audio('https://www.soundjay.com/phone/phone-calling-1.mp3'); 
        s_in.loop = true;

        onAuthStateChanged(auth, async (u) => {
            if(u) {
                me = u;
                document.getElementById('load').style.display = 'none';
                ldIb();
                lsnCall();
            } else location.href = "Account.html";
        });

        function ldIb() {
            onSnapshot(query(collection(db,"chats"), where("users","array-contains",me.uid)), s => {
                const l = document.getElementById('clist'); l.innerHTML = "";
                let d=[]; s.forEach(x=>d.push({id:x.id,...x.data()}));
                d.sort((a,b)=>(b.lastMsgTime?.toMillis()||0)-(a.lastMsgTime?.toMillis()||0));
                d.forEach(c => {
                    const oid = c.users.find(i=>i!==me.uid);
                    const inf = c.userInfo?.[oid] || {name:"Unknown",pic:""};
                    const bld = (c.lastMsgSender!==me.uid && !c.seen) ? 'new' : '';
                    let txt = c.lastMsg;
                    if(c.lastMsgType==='image') txt = 'Sent a photo';
                    if(c.lastMsgType==='video') txt = 'Sent a video';
                    if(c.lastMsgType==='audio') txt = 'Sent a voice message';
                    l.innerHTML += `<div class="itm" onclick="goCh('${oid}')"><img src="${inf.pic}" class="av"><div style="flex:1"><div class="nm">${inf.name}</div><div class="prv ${bld}">${c.lastMsgSender===me.uid?'You: ':''}${txt}</div></div></div>`;
                });
            });
        }

        window.opnFr = async () => {
            document.getElementById('f-mod').style.display='flex';
            const l=document.getElementById('flist'); l.innerHTML='Loading...';
            const f=(await getDoc(doc(db,"users",me.uid))).data().friends||[];
            l.innerHTML="";
            for(const id of f) {
                const u=(await getDoc(doc(db,"users",id))).data();
                l.innerHTML += `<div class="itm" onclick="goCh('${id}');document.getElementById('f-mod').style.display='none'"><img src="${u.profilePic}" class="av"><div class="nm">${u.fullName}</div></div>`;
            }
        }

        window.goCh = async (uid) => {
            document.getElementById('v-ib').style.display='none';
            document.getElementById('v-ch').style.display='flex';
            const u=(await getDoc(doc(db,"users",uid))).data();
            oUser={uid, name:u.fullName, pic:u.profilePic};
            document.getElementById('c-nm').innerText=u.fullName;
            document.getElementById('c-img').src=u.profilePic;
            cid = me.uid<uid ? `${me.uid}_${uid}` : `${uid}_${me.uid}`;
            setDoc(doc(db,"chats",cid),{seen:true},{merge:true});
            onSnapshot(query(collection(db,"chats",cid,"messages"),orderBy("time","asc")), s => {
                const a=document.getElementById('msgs'); a.innerHTML="";
                s.forEach(d=>rMsg(d.data(),a));
                a.scrollTop=a.scrollHeight;
            });
        }

        function rMsg(m, a) {
            const cls = m.sender===me.uid ? 's' : 'r';
            let c = `<div class="bub">${m.txt}</div>`;
            if(m.type==='image') c = `<img src="${m.url}" class="m-img" onclick="window.open('${m.url}')">`;
            if(m.type==='video') c = `<video src="${m.url}" controls class="m-vid"></video>`;
            if(m.type==='audio') c = `<audio src="${m.url}" controls class="m-aud"></audio>`;
            a.innerHTML += `<div class="row ${cls}">${c}</div>`;
        }

        window.chkTyp = (e) => {
            const has = e.value.trim().length>0;
            document.getElementById('snd-btn').style.display=has?'block':'none';
            document.getElementById('mic-btn').style.display=has?'none':'block';
        }

        window.snd = async () => {
            const i=document.getElementById('in-txt'); const t=i.value.trim();
            if(!t)return; i.value=""; chkTyp(i);
            await psM({sender:me.uid, txt:t, type:'text', time:serverTimestamp()});
        }

        window.upFile = async (e) => {
            if(e.files[0]) {
                const f=e.files[0], type=f.type.startsWith('video')?'video':'image';
                const fd=new FormData(); fd.append('file',f); fd.append('upload_preset',C_PRE);
                const r=await fetch(C_URL,{method:'POST',body:fd}); const d=await r.json();
                await psM({sender:me.uid, type:type, url:d.secure_url, time:serverTimestamp()});
            }
        }

        window.tMic = async () => {
            const b=document.getElementById('mic-btn');
            if(!mRec || mRec.state==='inactive') {
                const s=await navigator.mediaDevices.getUserMedia({audio:true});
                mRec=new MediaRecorder(s); aChks=[];
                mRec.ondataavailable=e=>aChks.push(e.data);
                mRec.onstop=async()=>{
                    const bl=new Blob(aChks,{type:'audio/webm'});
                    const fd=new FormData(); fd.append('file',bl); fd.append('upload_preset',C_PRE);
                    const r=await fetch(C_URL,{method:'POST',body:fd}); const d=await r.json();
                    await psM({sender:me.uid, type:'audio', url:d.secure_url, time:serverTimestamp()});
                    s.getTracks().forEach(t=>t.stop());
                };
                mRec.start(); b.classList.add('mic-on');
            } else { mRec.stop(); b.classList.remove('mic-on'); }
        }

        async function psM(d) {
            await addDoc(collection(db,"chats",cid,"messages"), d);
            const i=(await getDoc(doc(db,"users",me.uid))).data();
            await setDoc(doc(db,"chats",cid), {users:[me.uid,oUser.uid], lastMsg:d.txt||'Media', lastMsgType:d.type, lastMsgSender:me.uid, lastMsgTime:serverTimestamp(), seen:false, userInfo:{[me.uid]:{name:i.fullName,pic:i.profilePic},[oUser.uid]:{name:oUser.name,pic:oUser.pic}}},{merge:true});
        }

        window.clsCh = () => { document.getElementById('v-ch').style.display='none'; document.getElementById('v-ib').style.display='flex'; }

        // --- CALL SYSTEM ---
        window.doCall = async () => {
            document.getElementById('v-call').style.display='flex';
            document.getElementById('cl-nm').innerText=oUser.name; document.getElementById('cl-img').src=oUser.pic;
            document.getElementById('cl-st').innerText="Calling...";
            
            s_out.currentTime=0; s_out.play().catch(e=>console.log("Audio play blocked"));

            cDid=doc(collection(db,"calls")).id;
            pc=new RTCPeerConnection(srv);
            lStrm=await navigator.mediaDevices.getUserMedia({audio:true});
            lStrm.getTracks().forEach(t=>pc.addTrack(t,lStrm));
            
            pc.ontrack=e=>document.getElementById('rem-aud').srcObject=e.streams[0];
            pc.onicecandidate=e=>{if(e.candidate)addDoc(collection(db,"calls",cDid,"oCan"),e.candidate.toJSON())};
            
            const off=await pc.createOffer(); await pc.setLocalDescription(off);
            await setDoc(doc(db,"calls",cDid), {caller:me.uid, rec:oUser.uid, offer:{type:off.type,sdp:off.sdp}, st:'ring'});
            
            onSnapshot(doc(db,"calls",cDid), d=>{
                const v=d.data(); if(!v)return;
                if(v.ans && !pc.currentRemoteDescription){ pc.setRemoteDescription(new RTCSessionDescription(v.ans)); document.getElementById('cl-st').innerText="Connected"; s_out.pause(); }
                if(v.st==='end') endL();
            });
            onSnapshot(collection(db,"calls",cDid,"aCan"), s=>s.docChanges().forEach(c=>{if(c.type==='added')pc.addIceCandidate(new RTCIceCandidate(c.doc.data()))}));
        }

        function lsnCall() {
            onSnapshot(query(collection(db,"calls"),where("rec","==",me.uid),where("st","==","ring")), async s=>{
                s.docChanges().forEach(async c=>{
                    if(c.type==='added'){
                        cDid=c.doc.id; const d=c.doc.data();
                        const u=(await getDoc(doc(db,"users",d.caller))).data();
                        document.getElementById('v-call').style.display='flex';
                        document.getElementById('cl-nm').innerText=u.fullName; document.getElementById('cl-img').src=u.profilePic;
                        document.getElementById('cl-st').innerText="Incoming Call...";
                        document.getElementById('b-ans').style.display='flex';
                        s_in.currentTime=0; s_in.play().catch(e=>console.log("Audio play blocked"));
                    }
                });
            });
            onSnapshot(query(collection(db,"calls"),where("rec","==",me.uid)), s=>s.docChanges().forEach(c=>{if(c.type==='modified'&&c.doc.data().st==='end')endL()}));
        }

        window.ansC = async () => {
            s_in.pause();
            pc=new RTCPeerConnection(srv);
            lStrm=await navigator.mediaDevices.getUserMedia({audio:true});
            lStrm.getTracks().forEach(t=>pc.addTrack(t,lStrm));
            
            pc.ontrack=e=>document.getElementById('rem-aud').srcObject=e.streams[0];
            pc.onicecandidate=e=>{if(e.candidate)addDoc(collection(db,"calls",cDid,"aCan"),e.candidate.toJSON())};
            
            const d=(await getDoc(doc(db,"calls",cDid))).data();
            await pc.setRemoteDescription(new RTCSessionDescription(d.offer));
            const ans=await pc.createAnswer(); await pc.setLocalDescription(ans);
            
            await updateDoc(doc(db,"calls",cDid),{ans:{type:ans.type,sdp:ans.sdp},st:'con'});
            document.getElementById('cl-st').innerText="Connected";
            document.getElementById('b-ans').style.display='none';
            onSnapshot(collection(db,"calls",cDid,"oCan"), s=>s.docChanges().forEach(c=>{if(c.type==='added')pc.addIceCandidate(new RTCIceCandidate(c.doc.data()))}));
        }

        window.endC = async () => { if(cDid)await updateDoc(doc(db,"calls",cDid),{st:'end'}); endL(); }
        function endL() {
            document.getElementById('v-call').style.display='none';
            if(pc){pc.close();pc=null;}
            if(lStrm){lStrm.getTracks().forEach(t=>t.stop());lStrm=null;}
            s_out.pause(); s_in.pause(); cDid=null;
        }
    </script>
</body>
</html>
